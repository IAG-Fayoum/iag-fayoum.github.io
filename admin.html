<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#dc2626">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</title>
  
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="assets/js/api.js"></script>

  <style>
    /* â”€â”€ Ø£Ø³Ø§Ø³ÙŠØ§Øª â”€â”€ */
    body { 
      font-family: 'Cairo', sans-serif; 
      background-color: #f8fafc;
      overscroll-behavior-y: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none; user-select: none;
    }

    input, textarea, table, h1, h2, h3, p, span, td, th {
      -webkit-user-select: text; user-select: text;
    }

    /* Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ø¢ÙŠÙÙˆÙ† */
    input, select, textarea { font-size: 16px !important; }
    
    /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· */
    button:active, .card-press:active {
      transform: scale(0.97); transition: 0.1s;
    }

    .theme-gradient { background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%); }
    .hidden-section { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Toast Notification */
    #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 400px; pointer-events: none; }
    .toast { background: #1e293b; color: white; padding: 12px 20px; border-radius: 50px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-weight: bold; font-size: 0.9rem; opacity: 0; transition: 0.3s; transform: translateY(20px); pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: #ef4444; }
    .toast.success { background: #10b981; }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      
      /* ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù„ÙƒØ±ÙˆØª */
      .mobile-card-grid { display: grid; gap: 12px; }
      .mobile-card { 
        background: white; padding: 16px; border-radius: 12px; 
        border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        display: flex; flex-direction: column; gap: 8px;
      }

      /* Tabs Scrolling */
      .main-tabs { overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding-bottom: 4px; }
      .main-tab-btn { white-space: nowrap; font-size: 0.85rem; padding: 8px 16px; flex-shrink: 0; }
      
      .input-field { font-size: 0.9rem; }
      .btn-primary { width: 100%; justify-content: center; }
    }
    
    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
    }

    /* Custom Styles */
    .stat-card { background: white; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; }
    .overview-card { background: white; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; text-align: center; }
    .overview-card h4 { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #64748b; margin-bottom: 8px; }
    .overview-card .count { font-size: 2rem; font-weight: 900; line-height: 1; }
    
    .main-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
    .main-tab-btn { padding: 10px 20px; font-weight: 700; color: #64748b; cursor: pointer; transition: 0.2s; border-radius: 10px; display: flex; align-items: center; gap: 8px; }
    .main-tab-btn.active { background-color: #b91c1c; color: white; }
    
    .input-field { width: 100%; border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px 14px; font-weight: 600; outline: none; background: white; color: #334155; }
    .input-field:focus { border-color: #b91c1c; }
    .btn-primary { background-color: #b91c1c; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-slate-50">

  <div id="toast-container"></div>

  <div id="admin-login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border border-slate-200">
      <div class="w-20 h-20 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
        <i data-lucide="shield-alert" class="w-10 h-10"></i>
      </div>
      <h3 class="text-2xl font-extrabold mb-2 text-slate-800">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      <p class="text-slate-500 mb-8 font-medium">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙÙ‚Ø·</p>
      
      <div class="relative mb-6">
        <input 
          type="password" 
          id="admin-pin-input" 
          placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙˆØ±" 
          maxlength="4" 
          inputmode="numeric" 
          pattern="[0-9]*"
          class="w-full bg-slate-50 border-2 border-slate-200 text-center text-3xl tracking-[0.5em] font-bold rounded-xl p-4 outline-none focus:border-red-500 focus:bg-white transition-all placeholder:text-slate-300 placeholder:text-lg placeholder:tracking-normal"
        >
      </div>
      
      <button onclick="checkAdminLogin()" class="bg-red-600 hover:bg-red-700 text-white w-full py-4 rounded-xl font-bold text-lg shadow-lg shadow-red-200 transition-all card-press">
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      </button>
      
      <button onclick="goHome()" class="mt-6 text-slate-400 hover:text-slate-600 text-sm font-bold flex items-center justify-center gap-2 mx-auto transition-colors">
        <i data-lucide="arrow-right" class="w-4 h-4"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      </button>
    </div>
  </div>

  <div id="admin-content-view" class="hidden-section flex-grow flex flex-col h-screen overflow-hidden">
    <header class="theme-gradient text-white py-4 shadow-lg shrink-0">
      <div class="container mx-auto px-4 flex justify-between items-center">
        <div>
          <h1 class="text-lg md:text-2xl font-extrabold flex items-center gap-2">
            <i data-lucide="shield-check" class="w-6 h-6"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
          </h1>
        </div>
        <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg flex items-center gap-2 transition-all font-bold text-sm card-press">
          <i data-lucide="log-out" class="w-4 h-4"></i><span>Ø®Ø±ÙˆØ¬</span>
        </button>
      </div>
    </header>

    <div class="flex-grow overflow-y-auto no-scrollbar p-4 md:p-6">
      <div class="container mx-auto">
        
        <div class="main-tabs">
          <button class="main-tab-btn active" onclick="switchTab('overview')">
            <i data-lucide="layout-dashboard" class="w-4 h-4"></i>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
          </button>
          <button class="main-tab-btn" onclick="switchTab('reports')">
            <i data-lucide="chart-bar" class="w-4 h-4"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
          </button>
          <button class="main-tab-btn" onclick="switchTab('archive')">
            <i data-lucide="archive" class="w-4 h-4"></i>Ø§Ù„Ø£Ø±Ø´ÙŠÙ
          </button>
        </div>

        <div id="tab-overview" class="tab-content fade-in">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div class="overview-card border-b-4 border-slate-600">
               <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</h4>
               <div id="stat-total" class="count text-slate-700">-</div>
            </div>
            <div class="overview-card border-b-4 border-emerald-500">
               <h4>Ù…Ù†Ø¬Ø²</h4>
               <div id="stat-done" class="count text-emerald-600">-</div>
            </div>
            <div class="overview-card border-b-4 border-amber-500">
               <h4>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„</h4>
               <div id="stat-progress" class="count text-amber-500">-</div>
            </div>
            <div class="overview-card border-b-4 border-red-500">
               <h4>Ù…ØªØ£Ø®Ø±</h4>
               <div id="stat-overdue" class="count text-red-600">-</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="flex justify-between items-center mb-4">
               <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                 <i data-lucide="users" class="w-5 h-5 text-red-600"></i>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
               </h3>
               <button onclick="loadOverview(); vibrateDevice();" class="text-sm text-slate-500 hover:text-red-600"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
            </div>
            
            <div class="desktop-only overflow-x-auto">
              <table class="w-full text-sm text-right">
                 <thead class="bg-slate-100 text-slate-600 font-bold">
                   <tr>
                     <th class="p-3">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                     <th class="p-3 text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                     <th class="p-3 text-center">Ø§Ù„Ù…Ù†Ø¬Ø²</th>
                     <th class="p-3 text-center">Ø¬Ø§Ø±ÙŠ</th>
                   </tr>
                 </thead>
                 <tbody id="employees-table-desktop"></tbody>
              </table>
            </div>

            <div id="employees-list-mobile" class="mobile-only mobile-card-grid"></div>
          </div>
        </div>

        <div id="tab-reports" class="tab-content hidden-section">
          <div class="stat-card text-center py-12">
            <i data-lucide="bar-chart-2" class="w-12 h-12 mx-auto text-slate-300 mb-4"></i>
            <h3 class="font-bold text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ·ÙˆÙŠØ± Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©...</h3>
          </div>
        </div>

        <div id="tab-archive" class="tab-content hidden-section">
          <div class="stat-card mb-4">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Ø§Ù„Ø³Ù†Ø©</label>
                <select id="archive-year" class="input-field py-1">
                  <option value="">Ø§Ù„ÙƒÙ„</option>
                  <option value="2025" selected>2025</option>
                  <option value="2024">2024</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 mb-1">Ø§Ù„Ø´Ù‡Ø±</label>
                <select id="archive-month" class="input-field py-1">
                  <option value="">Ø§Ù„ÙƒÙ„</option>
                  <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
                  <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
                  </select>
              </div>
              <div class="col-span-2 md:col-span-3">
                <label class="block text-xs font-bold text-slate-500 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«</label>
                <input type="text" id="archive-search" placeholder="Ø¨Ø­Ø«..." class="input-field py-1">
              </div>
            </div>
            <button onclick="searchArchiveAdmin()" class="btn-primary w-full mt-4 justify-center py-3 card-press">
              <i data-lucide="search" class="w-4 h-4"></i> Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
            </button>
          </div>
          
          <div id="archive-results-desktop" class="desktop-only stat-card overflow-x-auto"></div>
          <div id="archive-results-mobile" class="mobile-only mobile-card-grid"></div>
        </div>

      </div>
    </div>
  </div>

  <div id="loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden-section">
    <div class="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p class="font-bold text-slate-800">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
  </div>

  <script>
    lucide.createIcons();

    // â”€â”€ Helper Functions â”€â”€
    function vibrateDevice() { if (navigator.vibrate) navigator.vibrate(10); }
    
    function showToast(msg, type='success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = type === 'error' ? `<i data-lucide="alert-circle" class="w-4 h-4"></i> ${msg}` : `<i data-lucide="check" class="w-4 h-4"></i> ${msg}`;
      container.appendChild(toast);
      lucide.createIcons();
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function toggleLoader(show) {
      document.getElementById('loader').classList.toggle('hidden-section', !show);
    }

    // â”€â”€ Login Logic â”€â”€
    async function checkAdminLogin() {
      const pin = document.getElementById('admin-pin-input').value;
      if (!pin || pin.length < 4) { showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² (4 Ø£Ø±Ù‚Ø§Ù…)", "error"); return; }

      vibrateDevice();
      toggleLoader(true);
      
      try {
        if(typeof login === 'undefined') throw new Error("API not loaded");
        const res = await login(pin);
        
        if (res.success && res.role.includes('Ù…Ø¯ÙŠØ±')) {
           document.getElementById('admin-login-view').classList.add('hidden-section');
           document.getElementById('admin-content-view').classList.remove('hidden-section');
           loadOverview();
        } else {
           showToast("ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ", "error");
        }
      } catch(e) {
        console.error(e);
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "error");
      } finally {
        toggleLoader(false);
      }
    }

    // â”€â”€ Overview Logic (Fixed Math & Mobile Cards) â”€â”€
    async function loadOverview(){
      toggleLoader(true);
      try {
        const data = await getDashboard('2024-01-01','2027-12-31');
        
        if(!data || !data.totals) throw new Error("No Data");

        // Math Fixes
        const total = data.totals.periodTotal || 0;
        const done = data.totals.periodCompleted || 0;
        const overdue = data.totals.absoluteOverdue || 0;
        const prog = total - done; // Correct Calculation

        document.getElementById('stat-total').innerText = total;
        document.getElementById('stat-done').innerText = done;
        document.getElementById('stat-progress').innerText = prog;
        document.getElementById('stat-overdue').innerText = overdue;
        
        // Render Employees
        renderEmployeesTable(data.employees);

      } catch(e) {
        console.error(e);
        showToast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
      } finally {
        toggleLoader(false);
      }
    }

    function renderEmployeesTable(list) {
      const desktop = document.getElementById('employees-table-desktop');
      const mobile = document.getElementById('employees-list-mobile');
      desktop.innerHTML = ''; mobile.innerHTML = '';
      
      if(!list) return;

      list.forEach(emp => {
        const t = emp.periodTotal || 0;
        const d = emp.periodCompleted || 0;
        const p = t - d; // Math Fix

        // Desktop
        desktop.innerHTML += `
          <tr class="border-b hover:bg-slate-50">
            <td class="p-3 font-bold text-slate-800">${emp.name}</td>
            <td class="p-3 text-center">${t}</td>
            <td class="p-3 text-center text-emerald-600 font-bold">${d}</td>
            <td class="p-3 text-center text-amber-500 font-bold">${p}</td>
          </tr>`;
          
        // Mobile Card
        mobile.innerHTML += `
          <div class="mobile-card">
            <div class="flex justify-between items-center">
              <h4 class="font-bold text-slate-800">${emp.name}</h4>
              <span class="bg-slate-100 text-xs px-2 py-1 rounded">Ù…Ø¬Ù…ÙˆØ¹: ${t}</span>
            </div>
            <div class="flex gap-2 mt-1">
               <div class="flex-1 bg-emerald-50 text-emerald-700 text-center py-2 rounded text-sm font-bold">âœ… ${d}</div>
               <div class="flex-1 bg-amber-50 text-amber-700 text-center py-2 rounded text-sm font-bold">â³ ${p}</div>
            </div>
          </div>`;
      });
    }

    // â”€â”€ Archive Logic â”€â”€
    async function searchArchiveAdmin(){
      vibrateDevice();
      toggleLoader(true);
      const filters = {
        year: document.getElementById('archive-year').value,
        month: document.getElementById('archive-month').value,
        search: document.getElementById('archive-search').value
      };
      
      try {
        const result = await searchArchive(filters);
        if(result.success){
          displayArchive(result.results);
        } else {
          showToast(result.error, "error");
        }
      } catch(e) {
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«", "error");
      } finally {
        toggleLoader(false);
      }
    }
    
    function displayArchive(results){
      const desktop = document.getElementById('archive-results-desktop');
      const mobile = document.getElementById('archive-results-mobile');
      
      if(results.length === 0){
        desktop.innerHTML = '<p class="text-center text-slate-400 py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
        mobile.innerHTML = '<p class="text-center text-slate-400 py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
        return;
      }

      // Desktop Table Head
      let dHtml = '<table class="w-full text-sm text-right"><thead class="bg-slate-100 font-bold"><tr><th class="p-3">Ø±Ù‚Ù…</th><th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-3">Ø§Ù„Ø¬Ù‡Ø©</th><th class="p-3">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th><th class="p-3">Ù…Ù„ÙØ§Øª</th></tr></thead><tbody>';
      
      let mHtml = '';

      results.forEach(r => {
        // Attachments
        let att = '';
        if(r.taskAttachment) att += `<a href="${r.taskAttachment}" target="_blank" class="text-cyan-600 px-1">ğŸ“</a>`;
        if(r.reportDoc) att += `<a href="${r.reportDoc}" target="_blank" class="text-blue-600 px-1">ğŸ“„</a>`;
        if(r.reportPdf) att += `<a href="${r.reportPdf}" target="_blank" class="text-red-600 px-1">ğŸ“•</a>`;
        
        // Desktop Row
        dHtml += `<tr class="border-b hover:bg-slate-50">
          <td class="p-3 font-bold">${r.id}</td>
          <td class="p-3 text-slate-600">${r.date}</td>
          <td class="p-3 font-bold text-xs">${r.entity}</td>
          <td class="p-3 text-slate-600 text-xs">${r.subject}</td>
          <td class="p-3 text-center">${att || '-'}</td>
        </tr>`;

        // Mobile Card
        mHtml += `
          <div class="mobile-card relative">
             <div class="flex justify-between">
                <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded font-bold">#${r.id}</span>
                <span class="text-xs text-slate-400">${r.date}</span>
             </div>
             <h4 class="font-bold text-slate-800 text-sm">${r.subject}</h4>
             <p class="text-xs text-slate-500">${r.entity} | ${r.type}</p>
             <div class="flex justify-end gap-3 mt-2 border-t pt-2 border-slate-100">
                ${att ? att : '<span class="text-xs text-slate-300">Ø¨Ù„Ø§ Ù…Ø±ÙÙ‚Ø§Øª</span>'}
             </div>
          </div>
        `;
      });
      dHtml += '</tbody></table>';
      
      desktop.innerHTML = dHtml;
      mobile.innerHTML = mHtml;
    }
    
    // Navigation
    function switchTab(tabName){
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden-section'));
      document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-'+tabName).classList.remove('hidden-section');
      event.target.closest('.main-tab-btn').classList.add('active');
    }
    
    function goHome() { window.location.href = 'index.html'; }
    function logout() { window.location.href = 'index.html'; }
  </script>
</body>
</html>
