<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#dc2626">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</title>
  
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="assets/js/api.js"></script>

  <style>
    /* â”€â”€ Ø£Ø³Ø§Ø³ÙŠØ§Øª â”€â”€ */
    body { 
      font-family: 'Cairo', sans-serif; 
      background-color: #f8fafc;
      overscroll-behavior-y: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none; user-select: none;
    }

    /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…Ù‡Ù…Ø© */
    input, textarea, table, h1, h2, h3, p, span, td, th {
      -webkit-user-select: text; user-select: text;
    }

    /* Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ø¢ÙŠÙÙˆÙ† */
    input, select, textarea { font-size: 16px !important; }
    
    /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ÙˆØªØ´ ÙÙŠ Ø§Ù„Ø¢ÙŠÙÙˆÙ† */
    header {
      padding-top: calc(1rem + env(safe-area-inset-top)); /* Ù…Ø³Ø§ÙØ© Ø£Ù…Ø§Ù† Ù„Ù„Ù†ÙˆØªØ´ */
    }

    /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· */
    button:active, .card-press:active {
      transform: scale(0.97); transition: 0.1s;
    }
    
    .theme-gradient { background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%); }
    .hidden-section { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Toast Notification */
    #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 400px; pointer-events: none; }
    .toast { background: #1e293b; color: white; padding: 12px 20px; border-radius: 50px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-weight: bold; font-size: 0.9rem; opacity: 0; transition: 0.3s; transform: translateY(20px); pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: #ef4444; }
    .toast.success { background: #10b981; }

    /* Custom Styles */
    .stat-card { background: white; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; }
    .overview-card { background: white; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0; text-align: center; }
    .overview-card h4 { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #64748b; margin-bottom: 8px; }
    .overview-card .count { font-size: 2rem; font-weight: 900; line-height: 1; }
    
    .main-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .main-tab-btn { padding: 10px 20px; font-weight: 700; color: #64748b; cursor: pointer; transition: 0.2s; border-radius: 10px; display: flex; align-items: center; gap: 8px; white-space: nowrap; flex-shrink: 0; }
    .main-tab-btn.active { background-color: #b91c1c; color: white; }
    
    .input-field { width: 100%; border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px 14px; font-weight: 600; outline: none; background: white; color: #334155; transition: 0.2s; }
    .input-field:focus { border-color: #b91c1c; box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.1); }
    .btn-primary { background-color: #b91c1c; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
    .btn-primary:hover { background-color: #991b1b; }

    /* Mobile Cards */
    .mobile-card { 
      background: white; padding: 16px; border-radius: 12px; 
      border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;
    }

    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      .container { padding-left: 16px; padding-right: 16px; }
    }
    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-slate-50">

  <div id="toast-container"></div>

  <div id="admin-login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border border-slate-200">
      <div class="w-20 h-20 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm">
        <i data-lucide="shield-alert" class="w-10 h-10"></i>
      </div>
      <h3 class="text-2xl font-extrabold mb-2 text-slate-800">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      <p class="text-slate-500 mb-8 font-medium">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙÙ‚Ø·</p>
      
      <div class="relative mb-6">
        <input 
          type="password" 
          id="admin-pin-input" 
          placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙˆØ±" 
          maxlength="4" 
          inputmode="numeric" 
          pattern="[0-9]*"
          class="w-full bg-slate-50 border-2 border-slate-200 text-center text-3xl tracking-[0.5em] font-bold rounded-xl p-4 outline-none focus:border-red-500 focus:bg-white transition-all placeholder:text-slate-300 placeholder:text-lg placeholder:tracking-normal"
        >
      </div>
      
      <button onclick="checkAdminLogin()" class="bg-red-600 hover:bg-red-700 text-white w-full py-4 rounded-xl font-bold text-lg shadow-lg shadow-red-200 transition-all card-press">
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      </button>
      
      <button onclick="goHome()" class="mt-6 text-slate-400 hover:text-slate-600 text-sm font-bold flex items-center justify-center gap-2 mx-auto transition-colors">
        <i data-lucide="arrow-right" class="w-4 h-4"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      </button>
    </div>
  </div>

  <div id="admin-content-view" class="hidden-section flex-grow flex flex-col h-screen overflow-hidden">
    <header class="theme-gradient text-white py-4 shadow-lg shrink-0">
      <div class="container mx-auto px-4 flex justify-between items-center">
        <div>
          <h1 class="text-lg md:text-2xl font-extrabold flex items-center gap-2">
            <i data-lucide="shield-check" class="w-6 h-6"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
          </h1>
        </div>
        <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg flex items-center gap-2 transition-all font-bold text-sm card-press">
          <i data-lucide="log-out" class="w-4 h-4"></i><span>Ø®Ø±ÙˆØ¬</span>
        </button>
      </div>
    </header>

    <div class="flex-grow overflow-y-auto no-scrollbar p-4 md:p-6">
      <div class="container mx-auto">
        
        <div class="main-tabs">
          <button class="main-tab-btn active" onclick="switchTab('overview')"><i data-lucide="layout-dashboard" class="w-4 h-4"></i>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
          <button class="main-tab-btn" onclick="switchTab('reassign')"><i data-lucide="user-round-cog" class="w-4 h-4"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªÙƒÙ„ÙŠÙ</button>
          <button class="main-tab-btn" onclick="switchTab('status')"><i data-lucide="edit" class="w-4 h-4"></i>ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø©</button>
          <button class="main-tab-btn" onclick="switchTab('add')"><i data-lucide="plus-circle" class="w-4 h-4"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button>
          <button class="main-tab-btn" onclick="switchTab('reports')"><i data-lucide="chart-bar" class="w-4 h-4"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
          <button class="main-tab-btn" onclick="switchTab('archive')"><i data-lucide="archive" class="w-4 h-4"></i>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
        </div>

        <div id="tab-overview" class="tab-content fade-in">
          <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
            <div class="overview-card border-b-4 border-slate-600"><h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</h4><div id="stat-total" class="count text-slate-700">-</div></div>
            <div class="overview-card border-b-4 border-emerald-500"><h4>Ù…Ù†Ø¬Ø²</h4><div id="stat-done" class="count text-emerald-600">-</div></div>
            <div class="overview-card border-b-4 border-blue-500"><h4>Ø§Ù†ØªØ¸Ø§Ø±</h4><div id="stat-pending" class="count text-blue-600">-</div></div>
            <div class="overview-card border-b-4 border-amber-500"><h4>Ø¬Ø§Ø±ÙŠ</h4><div id="stat-progress" class="count text-amber-500">-</div></div>
            <div class="overview-card border-b-4 border-red-500"><h4>Ù…ØªØ£Ø®Ø±</h4><div id="stat-overdue" class="count text-red-600">-</div></div>
          </div>
          
          <div class="stat-card">
            <div class="flex justify-between items-center mb-4">
               <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                 <i data-lucide="users" class="w-5 h-5 text-red-600"></i>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
               </h3>
               <button onclick="loadOverview(); vibrateDevice();" class="text-sm text-slate-500 hover:text-red-600"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
            </div>
            
            <div class="desktop-only overflow-x-auto">
              <table class="w-full text-sm text-right">
                 <thead class="bg-slate-100 text-slate-600 font-bold">
                   <tr>
                     <th class="p-3">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                     <th class="p-3 text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                     <th class="p-3 text-center">Ù…Ù†Ø¬Ø²</th>
                     <th class="p-3 text-center">Ø§Ù†ØªØ¸Ø§Ø±</th>
                     <th class="p-3 text-center">Ø¬Ø§Ø±ÙŠ</th>
                     <th class="p-3 text-center">Ù…ØªØ£Ø®Ø±</th>
                     <th class="p-3 text-center">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                   </tr>
                 </thead>
                 <tbody id="employees-table-desktop"></tbody>
              </table>
            </div>
            
            <div id="employees-list-mobile" class="mobile-only mobile-card-grid"></div>
          </div>
        </div>

        <div id="tab-reassign" class="tab-content hidden-section">
          <div class="stat-card">
            <h3 class="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2"><i data-lucide="user-round-cog" class="w-5 h-5 text-teal-600"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªÙƒÙ„ÙŠÙ Ù…Ù‡Ù…Ø©</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">1. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø© (Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)</label>
                <div class="flex gap-2">
                  <input type="text" id="search-reassign" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ØŒ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹..." class="input-field">
                  <button onclick="searchTaskForAction('reassign')" class="btn-primary w-auto px-4"><i data-lucide="search" class="w-4 h-4"></i></button>
                </div>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">2. Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                <select id="new-employee" class="input-field"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option></select>
              </div>
            </div>
            <div id="reassign-results" class="mb-4 mobile-card-grid"></div>
            <button onclick="executeReassign()" class="btn-primary w-full md:w-auto"><i data-lucide="check" class="w-4 h-4"></i>ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ</button>
          </div>
        </div>

        <div id="tab-status" class="tab-content hidden-section">
          <div class="stat-card">
            <h3 class="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2"><i data-lucide="edit" class="w-5 h-5 text-teal-600"></i>ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ù…Ù‡Ù…Ø©</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">1. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                <div class="flex gap-2">
                  <input type="text" id="search-status" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ØŒ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹..." class="input-field">
                  <button onclick="searchTaskForAction('status')" class="btn-primary w-auto px-4"><i data-lucide="search" class="w-4 h-4"></i></button>
                </div>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">2. Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <select id="new-status-select" class="input-field">
                  <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© --</option>
                  <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
                  <option value="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø¯Ø¡">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø¯Ø¡</option>
                  <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                  <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                  <option value="Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</option>
                  <option value="ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯">ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</option>
                  <option value="Ù…ØªØ£Ø®Ø±">Ù…ØªØ£Ø®Ø±</option>
                </select>
              </div>
            </div>
            <div id="status-results" class="mb-4 mobile-card-grid"></div>
            <button onclick="executeStatusUpdate()" class="btn-primary w-full md:w-auto"><i data-lucide="check" class="w-4 h-4"></i>ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
          </div>
        </div>

        <div id="tab-add" class="tab-content hidden-section">
          <div class="stat-card">
            <h3 class="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-teal-600"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® <span class="text-red-500">*</span></label><input type="date" id="add-date" class="input-field"></div>
              <div><label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ù†Ù‡Ø§ <span class="text-red-500">*</span></label><input type="text" id="add-source" class="input-field" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙˆØ²Ø§Ø±Ø©"></div>
              <div class="md:col-span-2"><label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ <span class="text-red-500">*</span></label><textarea id="add-subject" rows="2" class="input-field"></textarea></div>
              <div><label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ø¬Ù‡Ø© Ù…Ø­Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°</label><input type="text" id="add-entity" class="input-field"></div>
              <div><label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙƒÙ„Ù</label><select id="add-employee" class="input-field"><option value="">-- Ø§Ø®ØªØ± --</option></select></div>
              <div><label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</label><input type="date" id="add-deadline" class="input-field"></div>
              <div><label class="block text-sm font-bold text-slate-700 mb-2">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø±ÙÙ‚</label><input type="url" id="add-attachment" class="input-field" placeholder="https://..."></div>
            </div>
            <button onclick="executeAddTask()" class="btn-primary mt-6 w-full md:w-auto"><i data-lucide="plus" class="w-4 h-4"></i>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          </div>
        </div>

        <div id="tab-reports" class="tab-content hidden-section">
          <div class="stat-card text-center py-12">
            <i data-lucide="bar-chart-2" class="w-12 h-12 mx-auto text-slate-300 mb-4"></i>
            <h3 class="font-bold text-slate-500">Ø¬Ø§Ø±ÙŠ ØªØ·ÙˆÙŠØ± Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©...</h3>
          </div>
        </div>

        <div id="tab-archive" class="tab-content hidden-section">
          <div class="stat-card mb-4">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
              <div><label class="block text-xs font-bold text-slate-500 mb-1">Ø§Ù„Ø³Ù†Ø©</label><select id="archive-year" class="input-field py-1"><option value="">Ø§Ù„ÙƒÙ„</option><option value="2025" selected>2025</option><option value="2024">2024</option></select></div>
              <div><label class="block text-xs font-bold text-slate-500 mb-1">Ø§Ù„Ø´Ù‡Ø±</label><select id="archive-month" class="input-field py-1"><option value="">Ø§Ù„ÙƒÙ„</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option></select></div>
              <div class="col-span-2 md:col-span-3"><label class="block text-xs font-bold text-slate-500 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«</label><input type="text" id="archive-search" placeholder="Ø¨Ø­Ø«..." class="input-field py-1"></div>
            </div>
            <button onclick="searchArchiveAdmin()" class="btn-primary w-full mt-4 justify-center py-3 card-press"><i data-lucide="search" class="w-4 h-4"></i> Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
          </div>
          <div id="archive-results-desktop" class="desktop-only stat-card overflow-x-auto"></div>
          <div id="archive-results-mobile" class="mobile-only mobile-card-grid"></div>
        </div>

      </div>
    </div>
  </div>

  <div id="loader" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden-section">
    <div class="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p class="font-bold text-slate-800">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
  </div>

  <script>
    lucide.createIcons();
    let selectedTaskId = null; // Ù„Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©

    // â”€â”€ Helper Functions â”€â”€
    function vibrateDevice() { if (navigator.vibrate) navigator.vibrate(10); }
    
    function showToast(msg, type='success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = type === 'error' ? `<i data-lucide="alert-circle" class="w-4 h-4"></i> ${msg}` : `<i data-lucide="check" class="w-4 h-4"></i> ${msg}`;
      container.appendChild(toast);
      lucide.createIcons();
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function toggleLoader(show) {
      document.getElementById('loader').classList.toggle('hidden-section', !show);
    }

    // â”€â”€ Login Logic â”€â”€
    async function checkAdminLogin() {
      const pin = document.getElementById('admin-pin-input').value;
      if (!pin || pin.length < 4) { showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² (4 Ø£Ø±Ù‚Ø§Ù…)", "error"); return; }
      vibrateDevice(); toggleLoader(true);
      
      try {
        if(typeof login === 'undefined') throw new Error("API not loaded");
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† api.js Ø£Ùˆ google.script.run
        const res = await login(pin);
        
        if (res.success && res.role.includes('Ù…Ø¯ÙŠØ±')) {
           document.getElementById('admin-login-view').classList.add('hidden-section');
           document.getElementById('admin-content-view').classList.remove('hidden-section');
           loadOverview();
        } else {
           showToast("ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ", "error");
        }
      } catch(e) { console.error(e); showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "error"); } 
      finally { toggleLoader(false); }
    }

    // â”€â”€ Overview Logic â”€â”€
    async function loadOverview(){
      toggleLoader(true);
      try {
        const data = await getDashboard('2024-01-01','2027-12-31');
        if(!data || !data.totals) throw new Error("No Data");

        // âœ… Ù‡Ù†Ø§ Ø§Ù„Ø±Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„Ù€ Undefined
        document.getElementById('stat-total').innerText = data.totals.total || 0;
        document.getElementById('stat-done').innerText = data.totals.completed || 0;
        document.getElementById('stat-pending').innerText = data.totals.pending || 0;
        document.getElementById('stat-progress').innerText = data.totals.progress || 0;
        document.getElementById('stat-overdue').innerText = data.totals.overdue || 0;
        
        // Populate Dropdowns
        const empSelects = [document.getElementById('new-employee'), document.getElementById('add-employee')];
        empSelects.forEach(sel => {
           sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù --</option>';
           if(data.employees) {
             data.employees.forEach(e => {
               sel.innerHTML += `<option value="${e.name}">${e.name}</option>`;
             });
           }
        });

        // Render Employees
        renderEmployeesTable(data.employees);

      } catch(e) { console.error(e); showToast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error"); } 
      finally { toggleLoader(false); }
    }

    function renderEmployeesTable(list) {
      const desktop = document.getElementById('employees-table-desktop');
      const mobile = document.getElementById('employees-list-mobile');
      desktop.innerHTML = ''; mobile.innerHTML = '';
      
      if(!list) return;

      list.forEach(emp => {
        // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£ÙŠØ¶Ø§Ù‹ Ù‡Ù†Ø§
        const total = emp.periodTotal || 0;
        const done = emp.periodCompleted || 0;
        const pending = emp.periodPending || 0;
        const prog = emp.periodInProgress || 0;
        const overdue = emp.absoluteOverdue || 0;
        const rate = emp.rate || 0;

        // Desktop
        desktop.innerHTML += `
          <tr class="border-b hover:bg-slate-50">
            <td class="p-3">
              <div class="font-bold text-slate-800">${emp.name}</div>
              <div class="text-[10px] text-slate-400">${emp.breakdownStr || ''}</div>
            </td>
            <td class="p-3 text-center">${total}</td>
            <td class="p-3 text-center text-emerald-600 font-bold">${done}</td>
            <td class="p-3 text-center text-blue-600 font-bold">${pending}</td>
            <td class="p-3 text-center text-amber-500 font-bold">${prog}</td>
            <td class="p-3 text-center ${overdue > 0 ? 'text-red-600 font-black' : 'text-slate-300'}">${overdue}</td>
            <td class="p-3 text-center font-bold text-slate-700">%${rate}</td>
          </tr>`;
          
        // Mobile Card
        mobile.innerHTML += `
          <div class="mobile-card">
            <div class="flex justify-between items-center">
              <h4 class="font-bold text-slate-800">${emp.name}</h4>
              <span class="bg-slate-100 text-xs px-2 py-1 rounded">Ù…Ø¬Ù…ÙˆØ¹: ${total}</span>
            </div>
            <div class="grid grid-cols-4 gap-1 mt-2 text-center text-xs font-bold">
               <div class="bg-emerald-50 text-emerald-700 py-1 rounded">âœ… ${done}</div>
               <div class="bg-blue-50 text-blue-700 py-1 rounded">â³ ${pending}</div>
               <div class="bg-amber-50 text-amber-700 py-1 rounded">ğŸš§ ${prog}</div>
               <div class="${overdue > 0 ? 'bg-red-100 text-red-700' : 'bg-slate-50 text-slate-300'} py-1 rounded">ğŸš¨ ${overdue}</div>
            </div>
          </div>`;
      });
    }

    // â”€â”€ Action Tabs Logic â”€â”€
    async function searchTaskForAction(type) {
      const query = document.getElementById('search-' + type).value;
      if(query.length < 2) { showToast("Ø§ÙƒØªØ¨ Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error"); return; }
      
      toggleLoader(true);
      try {
        const filters = { search: query, year: '2025' }; 
        const res = await searchArchive(filters); 
        
        const container = document.getElementById(type + '-results');
        container.innerHTML = '';
        selectedTaskId = null;

        if(res.success && res.results.length > 0) {
           res.results.forEach(task => {
             container.innerHTML += `
               <div onclick="selectTask(this, '${task.id}')" class="mobile-card cursor-pointer hover:border-red-500 transition-colors border-2 border-transparent">
                  <div class="flex justify-between">
                     <span class="font-bold text-xs bg-slate-200 px-2 rounded">#${task.id}</span>
                     <span class="text-xs text-slate-500">${task.date}</span>
                  </div>
                  <div class="font-bold text-sm mt-1">${task.subject}</div>
                  <div class="text-xs text-slate-400">${task.entity}</div>
               </div>
             `;
           });
        } else {
           container.innerHTML = '<p class="text-center text-slate-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
        }
      } catch(e) { console.error(e); }
      finally { toggleLoader(false); }
    }

    function selectTask(el, id) {
       document.querySelectorAll('.mobile-card').forEach(c => {
         c.classList.remove('border-red-500', 'bg-red-50');
         c.classList.add('border-transparent');
       });
       el.classList.remove('border-transparent');
       el.classList.add('border-red-500', 'bg-red-50');
       selectedTaskId = id;
       vibrateDevice();
    }

    async function executeReassign() {
       if(!selectedTaskId) { showToast("Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹", "error"); return; }
       const newEmp = document.getElementById('new-employee').value;
       if(!newEmp) { showToast("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯", "error"); return; }
       
       toggleLoader(true);
       try {
          // Check for Apps Script environment vs Web
          if(typeof reassignTask !== 'undefined') {
             const res = await reassignTask(selectedTaskId, newEmp);
             if(res.success) { showToast("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙ"); document.getElementById('reassign-results').innerHTML = ''; selectedTaskId=null; }
             else showToast("ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "error");
          } else {
             // Fallback
             google.script.run.withSuccessHandler(() => {
                showToast("ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°"); toggleLoader(false);
             }).reassignTask(selectedTaskId, newEmp);
             return;
          }
       } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°", "error"); }
       finally { toggleLoader(false); }
    }

    async function executeStatusUpdate() {
       if(!selectedTaskId) { showToast("Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹", "error"); return; }
       const newStatus = document.getElementById('new-status-select').value;
       if(!newStatus) { showToast("Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "error"); return; }
       
       toggleLoader(true);
       try {
         if(typeof updateTaskStatus !== 'undefined') {
            const res = await updateTaskStatus(selectedTaskId, newStatus);
            if(res.success) { showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©"); document.getElementById('status-results').innerHTML = ''; selectedTaskId=null; }
            else showToast("ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "error");
         } else {
             google.script.run.withSuccessHandler(() => {
               showToast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"); toggleLoader(false);
            }).updateTaskStatus(selectedTaskId, newStatus);
            return;
         }
       } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°", "error"); }
       finally { toggleLoader(false); }
    }

    async function executeAddTask() {
       const taskData = {
         date: document.getElementById('add-date').value,
         source: document.getElementById('add-source').value,
         subject: document.getElementById('add-subject').value,
         entity: document.getElementById('add-entity').value,
         employee: document.getElementById('add-employee').value,
         deadline: document.getElementById('add-deadline').value,
         attachment: document.getElementById('add-attachment').value
       };

       if(!taskData.date || !taskData.source || !taskData.subject) {
         showToast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (*)", "error"); return;
       }

       toggleLoader(true);
       try {
          if(typeof addTaskManual !== 'undefined') {
             const res = await addTaskManual(taskData);
             if(res.success) { 
               showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­"); 
               document.querySelectorAll('#tab-add input, #tab-add textarea').forEach(i => i.value = '');
             } else showToast("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©", "error");
          } else {
             google.script.run.withSuccessHandler(() => {
               showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); toggleLoader(false);
            }).addTaskManual(taskData);
            return;
          }
       } catch(e) { showToast("Ø®Ø·Ø£", "error"); }
       finally { toggleLoader(false); }
    }

    // â”€â”€ Archive Logic â”€â”€
    async function searchArchiveAdmin(){
      vibrateDevice(); toggleLoader(true);
      const filters = {
        year: document.getElementById('archive-year').value,
        month: document.getElementById('archive-month').value,
        search: document.getElementById('archive-search').value
      };
      
      try {
        const result = await searchArchive(filters);
        displayArchive(result.success ? result.results : []);
      } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«", "error"); } 
      finally { toggleLoader(false); }
    }
    
    function displayArchive(results){
      const desktop = document.getElementById('archive-results-desktop');
      const mobile = document.getElementById('archive-results-mobile');
      
      if(results.length === 0){
        desktop.innerHTML = '<p class="text-center text-slate-400 py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
        mobile.innerHTML = '<p class="text-center text-slate-400 py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
        return;
      }

      let dHtml = '<table class="w-full text-sm text-right"><thead class="bg-slate-100 font-bold"><tr><th class="p-3">Ø±Ù‚Ù…</th><th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-3">Ø§Ù„Ø¬Ù‡Ø©</th><th class="p-3">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th><th class="p-3">Ù…Ù„ÙØ§Øª</th></tr></thead><tbody>';
      let mHtml = '';

      results.forEach(r => {
        let att = '';
        if(r.taskAttachment) att += `<a href="${r.taskAttachment}" target="_blank" class="text-cyan-600 px-1">ğŸ“</a>`;
        if(r.reportDoc) att += `<a href="${r.reportDoc}" target="_blank" class="text-blue-600 px-1">ğŸ“„</a>`;
        if(r.reportPdf) att += `<a href="${r.reportPdf}" target="_blank" class="text-red-600 px-1">ğŸ“•</a>`;
        
        dHtml += `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-bold">${r.id}</td><td class="p-3 text-slate-600">${r.date}</td><td class="p-3 font-bold text-xs">${r.entity}</td><td class="p-3 text-slate-600 text-xs">${r.subject}</td><td class="p-3 text-center">${att || '-'}</td></tr>`;

        mHtml += `<div class="mobile-card relative"><div class="flex justify-between"><span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded font-bold">#${r.id}</span><span class="text-xs text-slate-400">${r.date}</span></div><h4 class="font-bold text-slate-800 text-sm mt-1">${r.subject}</h4><p class="text-xs text-slate-500">${r.entity}</p><div class="flex justify-end gap-3 mt-2 border-t pt-2 border-slate-100">${att ? att : '<span class="text-xs text-slate-300">Ø¨Ù„Ø§ Ù…Ø±ÙÙ‚Ø§Øª</span>'}</div></div>`;
      });
      dHtml += '</tbody></table>';
      desktop.innerHTML = dHtml;
      mobile.innerHTML = mHtml;
    }
    
    // Navigation
    function switchTab(tabName){
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden-section'));
      document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-'+tabName).classList.remove('hidden-section');
      // Fix: only add active class if clicked button exists (safe check)
      const btn = event ? event.target.closest('.main-tab-btn') : document.querySelector(`button[onclick="switchTab('${tabName}')"]`);
      if(btn) btn.classList.add('active');
    }
    
    function goHome() { window.location.href = 'index.html'; }
    function logout() { window.location.href = 'index.html'; }
    
    // Auto Load Icons
    lucide.createIcons();
  </script>
</body>
</html>
