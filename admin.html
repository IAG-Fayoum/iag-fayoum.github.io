<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    /* â”€â”€ Core & Reset â”€â”€ */
    body { 
      font-family: 'Cairo', sans-serif; 
      background-color: #f8fafc;
      overscroll-behavior-y: none;
      -webkit-tap-highlight-color: transparent;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Layout */
    header { padding-top: calc(1rem + env(safe-area-inset-top)); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .theme-gradient { background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%); }
    .hidden-section { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* UI Components */
    .stat-card { background: white; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .overview-card { background: white; border-radius: 12px; padding: 12px; border: 1px solid #e2e8f0; text-align: center; }
    .overview-card h4 { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 4px; }
    .overview-card .count { font-size: 1.5rem; font-weight: 900; line-height: 1; }
    
    /* Tabs */
    .main-tab-btn { padding: 10px 16px; font-weight: 700; color: #64748b; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 8px; white-space: nowrap; background: #f1f5f9; border: 1px solid transparent; font-size: 0.9rem; transition: 0.2s; }
    .main-tab-btn.active { background-color: #b91c1c; color: white; box-shadow: 0 4px 6px -1px rgba(185, 28, 28, 0.2); }
    .main-tab-btn:hover:not(.active) { background-color: #e2e8f0; }

    /* Inputs & Buttons */
    .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px 12px; font-weight: 600; outline: none; background: white; color: #334155; transition: border-color 0.2s; }
    .input-field:focus { border-color: #b91c1c; ring: 2px solid #fee2e2; }
    .btn-primary { background-color: #b91c1c; color: white; padding: 12px; border-radius: 8px; font-weight: 700; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
    .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

    /* Result Items */
    .result-item { cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
    .result-item:hover { background-color: #fef2f2; }
    .result-item.selected { border-color: #b91c1c; background-color: #fef2f2; }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      .grid-cols-5 { grid-template-columns: repeat(2, 1fr); }
      .grid-cols-5 > div:last-child { grid-column: span 2; }
    }
    @media (min-width: 769px) { .mobile-only { display: none !important; } }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-slate-50">

  <div id="admin-login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border border-slate-200 fade-in">
      <div class="w-16 h-16 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="shield-alert" class="w-8 h-8"></i></div>
      <h3 class="text-xl font-extrabold mb-2 text-slate-800">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      <p class="text-slate-500 mb-6 font-medium text-sm">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙÙ‚Ø·</p>
      
      <input type="password" id="admin-pin-input" placeholder="****" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="w-full bg-slate-50 border border-slate-200 text-center text-3xl tracking-[0.5em] font-bold rounded-xl p-3 mb-6 outline-none focus:border-red-500 transition-colors">
      
      <button onclick="checkAdminLogin()" class="btn-primary py-3 text-lg shadow-lg shadow-red-100">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
      <button onclick="goHome()" class="mt-6 text-slate-400 font-bold text-xs flex items-center justify-center gap-2 mx-auto hover:text-slate-600 transition-colors">
        <i data-lucide="arrow-right" class="w-3 h-3"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      </button>
    </div>
  </div>

  <div id="admin-content-view" class="hidden-section flex-grow flex flex-col h-screen overflow-hidden">
    <header class="theme-gradient text-white py-4 shadow-md shrink-0 z-20">
      <div class="container mx-auto px-4 flex justify-between items-center">
        <h1 class="text-lg font-bold flex items-center gap-2"><i data-lucide="shield-check" class="w-5 h-5"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
        <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg flex items-center gap-2 text-xs font-bold transition">
          <i data-lucide="log-out" class="w-3 h-3"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </header>

    <div class="flex-grow overflow-y-auto no-scrollbar p-4 safe-bottom">
      <div class="container mx-auto max-w-5xl">
        
        <div class="flex gap-2 overflow-x-auto pb-2 mb-4 no-scrollbar">
          <button class="main-tab-btn active" onclick="switchTab('overview')"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
          <button class="main-tab-btn" onclick="switchTab('reassign')"><i data-lucide="user-round-cog" class="w-4 h-4"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªÙƒÙ„ÙŠÙ</button>
          <button class="main-tab-btn" onclick="switchTab('status')"><i data-lucide="edit" class="w-4 h-4"></i> ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø©</button>
          <button class="main-tab-btn" onclick="switchTab('add')"><i data-lucide="plus-circle" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button>
          <button class="main-tab-btn" onclick="switchTab('archive')"><i data-lucide="archive" class="w-4 h-4"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
        </div>

        <div id="tab-overview" class="tab-content fade-in">
          <div class="grid grid-cols-5 gap-3 mb-6">
            <div class="overview-card border-b-4 border-slate-600"><h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h4><div id="stat-total" class="count text-slate-700">-</div></div>
            <div class="overview-card border-b-4 border-emerald-500"><h4>Ù…Ù†Ø¬Ø²</h4><div id="stat-done" class="count text-emerald-600">-</div></div>
            <div class="overview-card border-b-4 border-teal-400 bg-teal-50/30"><h4>Ø§Ù†ØªØ¸Ø§Ø±</h4><div id="stat-pending" class="count text-teal-600">-</div></div>
            <div class="overview-card border-b-4 border-blue-500 bg-blue-50/30"><h4>ÙØ­Øµ</h4><div id="stat-review" class="count text-blue-600">-</div></div>
            <div class="overview-card border-b-4 border-red-500 bg-red-50/30"><h4>Ù…ØªØ£Ø®Ø±</h4><div id="stat-overdue" class="count text-red-600">-</div></div>
          </div>
          
          <div class="stat-card">
            <div class="flex justify-between items-center mb-4">
               <h3 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5 text-red-600"></i> Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
               <button onclick="loadOverview()" class="text-xs bg-slate-100 px-3 py-1.5 rounded-lg hover:bg-slate-200 font-bold flex items-center gap-1 transition"><i data-lucide="refresh-cw" class="w-3 h-3"></i> ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <div class="overflow-x-auto rounded-lg border border-slate-100">
              <table class="w-full text-sm text-right bg-white">
                 <thead class="bg-slate-50 text-slate-600 font-bold text-xs uppercase">
                   <tr>
                     <th class="p-3">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                     <th class="p-3 text-center">Ù…Ù‡Ø§Ù…</th>
                     <th class="p-3 text-center text-emerald-600">Ù…Ù†Ø¬Ø²</th>
                     <th class="p-3 text-center text-red-600">Ù…ØªØ£Ø®Ø±</th>
                     <th class="p-3 text-center">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                   </tr>
                 </thead>
                 <tbody id="employees-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tab-reassign" class="tab-content hidden-section fade-in">
          <div class="stat-card max-w-2xl mx-auto">
            <h3 class="font-bold mb-4 text-slate-800 text-lg flex items-center gap-2"><i data-lucide="arrow-right-left" class="w-5 h-5 text-red-600"></i> Ù†Ù‚Ù„ Ù…Ù‡Ù…Ø© Ù„Ù…ÙˆØ¸Ù Ø¢Ø®Ø±</h3>
            <div class="space-y-4">
              <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <label class="text-xs font-bold text-slate-500 block mb-2">1. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                <div class="flex gap-2">
                  <input type="text" id="search-reassign" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ØŒ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ØŒ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù..." class="input-field">
                  <button onclick="searchTaskForAction('reassign')" class="bg-slate-800 text-white px-4 rounded-lg hover:bg-slate-900"><i data-lucide="search" class="w-5 h-5"></i></button>
                </div>
                <div id="reassign-results" class="space-y-2 mt-3 max-h-60 overflow-y-auto"></div>
              </div>

              <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <label class="text-xs font-bold text-slate-500 block mb-2">2. Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                <select id="new-employee" class="input-field"><option value="">-- Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ --</option></select>
              </div>
              
              <button onclick="executeReassign()" class="btn-primary mt-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</button>
            </div>
          </div>
        </div>

        <div id="tab-status" class="tab-content hidden-section fade-in">
          <div class="stat-card max-w-2xl mx-auto">
            <h3 class="font-bold mb-4 text-slate-800 text-lg flex items-center gap-2"><i data-lucide="check-circle-2" class="w-5 h-5 text-red-600"></i> ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ù…Ù‡Ù…Ø©</h3>
            <div class="space-y-4">
              <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <label class="text-xs font-bold text-slate-500 block mb-2">1. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                <div class="flex gap-2">
                  <input type="text" id="search-status" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹..." class="input-field">
                  <button onclick="searchTaskForAction('status')" class="bg-slate-800 text-white px-4 rounded-lg hover:bg-slate-900"><i data-lucide="search" class="w-5 h-5"></i></button>
                </div>
                <div id="status-results" class="space-y-2 mt-3 max-h-60 overflow-y-auto"></div>
              </div>

              <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <label class="text-xs font-bold text-slate-500 block mb-2">2. Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <select id="new-status-select" class="input-field">
                  <option value="">-- Ø§Ø®ØªØ± --</option>
                  <option value="Ø¬Ø¯ÙŠØ¯">âœ¨ Ø¬Ø¯ÙŠØ¯</option>
                  <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                  <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">ğŸ§ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                  <option value="Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯">ğŸ“œ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</option>
                  <option value="ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯">âœ… ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</option>
                  <option value="Ù…ØªØ£Ø®Ø±">ğŸš¨ Ù…ØªØ£Ø®Ø±</option>
                </select>
              </div>
              
              <button onclick="executeStatusUpdate()" class="btn-primary mt-2">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
          </div>
        </div>

        <div id="tab-add" class="tab-content hidden-section fade-in">
          <div class="stat-card max-w-2xl mx-auto">
            <h3 class="font-bold mb-4 text-slate-800 text-lg flex items-center gap-2"><i data-lucide="plus-square" class="w-5 h-5 text-red-600"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label class="text-xs font-bold text-slate-500 mb-1 block">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ±ÙˆØ¯ <span class="text-red-500">*</span></label><input type="date" id="add-date" class="input-field"></div>
              <div><label class="text-xs font-bold text-slate-500 mb-1 block">ÙˆØ§Ø±Ø¯ Ù…Ù† (Ø§Ù„Ù…ØµØ¯Ø±) <span class="text-red-500">*</span></label><input type="text" id="add-source" class="input-field" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙƒØªØ¨ Ø§Ù„ÙˆØ²ÙŠØ±"></div>
              <div class="md:col-span-2"><label class="text-xs font-bold text-slate-500 mb-1 block">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ <span class="text-red-500">*</span></label><textarea id="add-subject" rows="2" class="input-field" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ù…Ù‡Ù…Ø©..."></textarea></div>
              <div><label class="text-xs font-bold text-slate-500 mb-1 block">Ø¬Ù‡Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</label><input type="text" id="add-entity" class="input-field" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³ØªØ´ÙÙ‰ Ø·Ø§Ù…ÙŠØ©"></div>
              <div><label class="text-xs font-bold text-slate-500 mb-1 block">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙƒÙ„Ù <span class="text-red-500">*</span></label><select id="add-employee" class="input-field"><option value="">-- Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ --</option></select></div>
              <div><label class="text-xs font-bold text-slate-500 mb-1 block">Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… (Deadline)</label><input type="date" id="add-deadline" class="input-field"></div>
              <div><label class="text-xs font-bold text-slate-500 mb-1 block">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø±ÙÙ‚</label><input type="url" id="add-attachment" class="input-field" placeholder="https://..."></div>
            </div>
            <button onclick="executeAddTask()" class="btn-primary mt-6">Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</button>
          </div>
        </div>

        <div id="tab-archive" class="tab-content hidden-section fade-in">
          <div class="stat-card mb-4">
            <h3 class="font-bold mb-3 text-slate-800 flex items-center gap-2"><i data-lucide="archive" class="w-5 h-5 text-red-600"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
              <select id="archive-year" class="input-field py-2 text-sm">
                <option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option><option value="2025" selected>2025</option><option value="2024">2024</option>
              </select>
              <select id="archive-month" class="input-field py-2 text-sm">
                <option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
                <option value="1">ÙŠÙ†Ø§ÙŠØ±</option><option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="3">Ù…Ø§Ø±Ø³</option><option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
                <option value="5">Ù…Ø§ÙŠÙˆ</option><option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option><option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option><option value="8">Ø£ØºØ³Ø·Ø³</option>
                <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option><option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option><option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
              </select>
              <div class="col-span-2">
                <input type="text" id="archive-search" placeholder="Ø¨Ø­Ø« Ø´Ø§Ù…Ù„..." class="input-field py-2 text-sm">
              </div>
            </div>
            <button onclick="searchArchiveAdmin()" class="btn-primary py-2 text-sm">Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
          </div>
          
          <div id="archive-results-area" class="space-y-2"></div>
        </div>

      </div>
    </div>
  </div>

  <div id="loader" class="fixed inset-0 bg-white/90 z-[9999] flex flex-col items-center justify-center hidden-section backdrop-blur-sm">
    <div class="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p class="font-bold text-slate-800">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p>
  </div>
  <div id="toast-container" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[9999] pointer-events-none w-full max-w-sm px-4"></div>

  <script>
    lucide.createIcons();
    let selectedTaskId = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª

    // â”€â”€ Helper Functions â”€â”€
    function showToast(msg, type='success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `mb-2 p-3 rounded-full text-center text-sm font-bold shadow-lg transition-all transform translate-y-4 opacity-0 flex items-center justify-center gap-2 ${type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'}`;
      toast.innerHTML = type === 'error' ? `<i data-lucide="alert-circle" class="w-4 h-4"></i> ${msg}` : `<i data-lucide="check" class="w-4 h-4"></i> ${msg}`;
      container.appendChild(toast);
      lucide.createIcons();
      requestAnimationFrame(() => { toast.classList.remove('translate-y-4', 'opacity-0'); });
      setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
    function toggleLoader(show) { document.getElementById('loader').classList.toggle('hidden-section', !show); }
    function goHome() { 
      toggleLoader(true);
      if(typeof google !== 'undefined' && google.script) {
         google.script.run.withSuccessHandler(url => window.top.location.href = url).getScriptUrl();
      } else { window.location.href = 'index.html'; }
    }
    function logout() { location.reload(); }

    // â”€â”€ Login Logic â”€â”€
    function checkAdminLogin() {
      const pin = document.getElementById('admin-pin-input').value;
      if (!pin || pin.length < 4) { showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² ÙƒØ§Ù…Ù„Ø§Ù‹", "error"); return; }
      toggleLoader(true);
      
      try {
        if(typeof google === 'undefined' || !google.script) throw new Error("API Missing");
        google.script.run.withSuccessHandler(res => {
           if (res.success && res.role.includes('Ù…Ø¯ÙŠØ±')) {
              document.getElementById('admin-login-view').classList.add('hidden-section');
              document.getElementById('admin-content-view').classList.remove('hidden-section');
              loadOverview();
           } else { showToast("ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ", "error"); toggleLoader(false); }
        }).withFailureHandler(e => { showToast("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„: " + e, "error"); toggleLoader(false); }).loginUser(pin);
      } catch(e) { console.error(e); showToast("ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±: ØªØ®Ø·ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„", "error"); toggleLoader(false); }
    }

    // â”€â”€ Data Loading â”€â”€
    function loadOverview(){
      google.script.run.withSuccessHandler(data => {
        toggleLoader(false);
        if(!data || data.error) return;

        // Stats
        document.getElementById('stat-total').innerText = data.totals.total || 0;
        document.getElementById('stat-done').innerText = data.totals.completed || 0;
        document.getElementById('stat-pending').innerText = data.totals.pending_approval || 0;
        document.getElementById('stat-review').innerText = data.totals.review || 0;
        document.getElementById('stat-overdue').innerText = data.totals.overdue || 0;
        
        // Populate Dropdowns (Employees) for both Add & Reassign tabs
        const empSelects = [document.getElementById('new-employee'), document.getElementById('add-employee')];
        empSelects.forEach(sel => {
           sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option>';
           data.employees.forEach(e => sel.innerHTML += `<option value="${e.name}">${e.name}</option>`);
        });

        // Table
        const tbody = document.getElementById('employees-table');
        tbody.innerHTML = '';
        data.employees.forEach(e => {
            tbody.innerHTML += `
            <tr class="border-b hover:bg-slate-50">
              <td class="p-3 font-bold text-slate-800">${e.name}</td>
              <td class="p-3 text-center">${e.total}</td>
              <td class="p-3 text-center text-emerald-600 font-bold">${e.completed}</td>
              <td class="p-3 text-center font-bold ${e.overdue > 0 ? 'text-red-600' : 'text-slate-300'}">${e.overdue}</td>
              <td class="p-3 text-center text-xs text-slate-500">%${e.rate}</td>
            </tr>`;
        });
      }).getDashboardData('2020-01-01','2030-12-31');
    }

    // â”€â”€ Actions: Reassign & Status â”€â”€
    function searchTaskForAction(type) {
      const q = document.getElementById('search-' + type).value;
      if(q.length < 2) { showToast("Ø§ÙƒØªØ¨ Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error"); return; }
      toggleLoader(true);
      
      google.script.run.withSuccessHandler(res => {
        toggleLoader(false);
        const container = document.getElementById(type + '-results');
        container.innerHTML = '';
        selectedTaskId = null; // Reset selection

        if(res.success && res.results.length > 0) {
           res.results.forEach(t => {
             container.innerHTML += `
               <div onclick="selectTask(this, '${t.id}')" class="result-item bg-white p-3 rounded-lg border border-slate-200 mb-2 flex justify-between items-center group">
                  <div>
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-[10px] font-bold bg-slate-100 px-2 py-0.5 rounded text-slate-600">#${t.id}</span>
                      <span class="text-[10px] text-slate-400">${t.date}</span>
                    </div>
                    <p class="font-bold text-sm text-slate-800">${t.subject}</p>
                    <p class="text-xs text-slate-500">${t.entity}</p>
                  </div>
                  <div class="w-4 h-4 rounded-full border-2 border-slate-300 group-[.selected]:bg-red-600 group-[.selected]:border-red-600"></div>
               </div>`;
           });
        } else { container.innerHTML = '<p class="text-center text-slate-400 text-sm py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</p>'; }
      }).searchArchive({ search: q });
    }

    function selectTask(el, id) {
       // Visual feedback
       document.querySelectorAll('.result-item').forEach(c => c.classList.remove('selected'));
       el.classList.add('selected');
       selectedTaskId = id; 
       showToast("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‡Ù…Ø© #" + id);
    }

    function executeReassign() {
       if(!selectedTaskId) return showToast("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹", "error");
       const emp = document.getElementById('new-employee').value;
       if(!emp) return showToast("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯", "error");
       
       if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ù…ÙˆØ¸Ù: " + emp + "ØŸ")) return;

       toggleLoader(true);
       google.script.run.withSuccessHandler((res) => { 
         toggleLoader(false);
         if(res.success) {
            showToast("âœ… ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­"); 
            document.getElementById('search-reassign').value = '';
            document.getElementById('reassign-results').innerHTML = '';
            selectedTaskId = null;
         } else { showToast("Ø®Ø·Ø£: " + res.error, "error"); }
       }).reassignTask(selectedTaskId, emp);
    }

    function executeStatusUpdate() {
       if(!selectedTaskId) return showToast("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‡Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹", "error");
       const st = document.getElementById('new-status-select').value;
       if(!st) return showToast("Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", "error");
       
       toggleLoader(true);
       google.script.run.withSuccessHandler((res) => { 
          toggleLoader(false);
          if(res.success) {
             showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
             document.getElementById('search-status').value = '';
             document.getElementById('status-results').innerHTML = '';
             selectedTaskId = null;
          } else { showToast("Ø®Ø·Ø£: " + res.error, "error"); }
       }).updateTaskStatus(selectedTaskId, st);
    }

    // â”€â”€ Add Task Logic â”€â”€
    function executeAddTask() {
       const d = {
         date: document.getElementById('add-date').value,
         source: document.getElementById('add-source').value,
         subject: document.getElementById('add-subject').value,
         entity: document.getElementById('add-entity').value,
         employee: document.getElementById('add-employee').value,
         deadline: document.getElementById('add-deadline').value,
         attachment: document.getElementById('add-attachment').value
       };
       if(!d.date || !d.source || !d.subject || !d.employee) return showToast("Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (*)", "error");
       
       toggleLoader(true);
       google.script.run.withSuccessHandler((res) => { 
          toggleLoader(false);
          if(res.success) {
             showToast("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ù‚Ù…: " + res.id);
             // Clear inputs
             document.getElementById('add-subject').value = '';
             document.getElementById('add-attachment').value = '';
          } else { showToast("Ø®Ø·Ø£: " + res.error, "error"); }
       }).addTaskManual(d);
    }

    // â”€â”€ Archive Logic â”€â”€
    function searchArchiveAdmin(){
      const f = {
        year: document.getElementById('archive-year').value,
        month: document.getElementById('archive-month').value,
        search: document.getElementById('archive-search').value
      };
      toggleLoader(true);
      google.script.run.withSuccessHandler(res => {
        toggleLoader(false);
        const container = document.getElementById('archive-results-area');
        container.innerHTML = '';
        
        if(res.results.length === 0){
           container.innerHTML = '<div class="text-center text-slate-400 py-8 bg-white rounded-lg border border-dashed">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
           return;
        }

        res.results.forEach(r => {
          let att = r.taskAttachment ? `<a href="${r.taskAttachment}" target="_blank" class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded flex items-center gap-1 hover:bg-slate-200"><i data-lucide="paperclip" class="w-3 h-3"></i> Ù…Ø±ÙÙ‚</a>` : '';
          
          container.innerHTML += `
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between md:items-center gap-3">
               <div>
                  <div class="flex items-center gap-2 mb-1">
                     <span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded">#${r.id}</span>
                     <span class="text-xs text-slate-400 font-medium">${r.date}</span>
                  </div>
                  <h4 class="font-bold text-slate-800 text-sm">${r.subject}</h4>
                  <p class="text-xs text-slate-500 mt-0.5">${r.entity}</p>
               </div>
               <div>${att}</div>
            </div>`;
        });
        lucide.createIcons();
      }).searchArchive(f);
    }

    function switchTab(tabName){
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden-section'));
      document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
      
      document.getElementById('tab-'+tabName).classList.remove('hidden-section');
      
      // Activate buttons that link to this tab
      const buttons = document.querySelectorAll('.main-tab-btn');
      buttons.forEach(btn => {
         if(btn.getAttribute('onclick').includes(tabName)) btn.classList.add('active');
      });
    }
  </script>
</body>
</html>
