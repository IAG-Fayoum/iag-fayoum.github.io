<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#dc2626">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</title>
  
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="assets/js/api.js"></script>

  <style>
    /* â”€â”€ Ø£Ø³Ø§Ø³ÙŠØ§Øª â”€â”€ */
    body { 
      font-family: 'Cairo', sans-serif; 
      background-color: #f8fafc;
      overscroll-behavior-y: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none; user-select: none;
    }

    input, textarea, table, h1, h2, h3, p, span, td, th { -webkit-user-select: text; user-select: text; }
    input, select, textarea { font-size: 16px !important; }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ÙˆØªØ´ */
    header { padding-top: calc(1rem + env(safe-area-inset-top)); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

    /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· */
    button:active, .card-press:active { transform: scale(0.97); transition: 0.1s; opacity: 0.9; }
    
    .theme-gradient { background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%); }
    .hidden-section { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Toast */
    #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 400px; pointer-events: none; }
    .toast { background: #1e293b; color: white; padding: 12px 20px; border-radius: 50px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-weight: bold; font-size: 0.9rem; opacity: 0; transition: 0.3s; transform: translateY(20px); pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: #ef4444; }

    /* Custom UI */
    .stat-card { background: white; border-radius: 16px; padding: 16px; border: 1px solid #e2e8f0; }
    .overview-card { background: white; border-radius: 16px; padding: 16px; border: 1px solid #e2e8f0; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .overview-card h4 { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 4px; }
    .overview-card .count { font-size: 1.8rem; font-weight: 900; line-height: 1; }
    
    .main-tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; overflow-x: auto; }
    .main-tab-btn { padding: 8px 16px; font-weight: 700; color: #64748b; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 6px; white-space: nowrap; background: #f1f5f9; border: 1px solid transparent; font-size: 0.85rem; }
    .main-tab-btn.active { background-color: #b91c1c; color: white; box-shadow: 0 4px 6px -1px rgba(185, 28, 28, 0.2); }
    
    .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px 12px; font-weight: 600; outline: none; background: white; color: #334155; }
    .input-field:focus { border-color: #b91c1c; ring: 2px solid #fee2e2; }
    .btn-primary { background-color: #b91c1c; color: white; padding: 10px; border-radius: 8px; font-weight: 700; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
    
    /* Mobile Card Style */
    .mobile-card { background: white; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }

    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
    }
    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-slate-50">

  <div id="toast-container"></div>

  <div id="admin-login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100 p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border border-slate-200">
      <div class="w-16 h-16 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="shield-alert" class="w-8 h-8"></i></div>
      <h3 class="text-xl font-extrabold mb-2 text-slate-800">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      <p class="text-slate-500 mb-6 font-medium text-sm">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙÙ‚Ø·</p>
      
      <input type="password" id="admin-pin-input" placeholder="****" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="w-full bg-slate-50 border border-slate-200 text-center text-3xl tracking-[0.5em] font-bold rounded-xl p-3 mb-6 outline-none focus:border-red-500 transition-colors">
      
      <button onclick="checkAdminLogin()" class="btn-primary py-3 text-lg shadow-lg shadow-red-100">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button onclick="goHome()" class="mt-4 text-slate-400 font-bold text-xs flex items-center justify-center gap-1 mx-auto hover:text-slate-600">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>
  </div>

  <div id="admin-content-view" class="hidden-section flex-grow flex flex-col h-screen overflow-hidden">
    <header class="theme-gradient text-white py-4 shadow-md shrink-0 z-20">
      <div class="container mx-auto px-4 flex justify-between items-center">
        <h1 class="text-lg font-bold flex items-center gap-2"><i data-lucide="shield-check" class="w-5 h-5"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
        <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg flex items-center gap-2 text-xs font-bold transition">
          <i data-lucide="log-out" class="w-3 h-3"></i> Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </header>

    <div class="flex-grow overflow-y-auto no-scrollbar p-4 safe-bottom">
      <div class="container mx-auto max-w-5xl">
        
        <div class="main-tabs no-scrollbar">
          <button class="main-tab-btn active" onclick="switchTab('overview')"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
          <button class="main-tab-btn" onclick="switchTab('reassign')"><i data-lucide="user-round-cog" class="w-4 h-4"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªÙƒÙ„ÙŠÙ</button>
          <button class="main-tab-btn" onclick="switchTab('status')"><i data-lucide="edit" class="w-4 h-4"></i> ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø©</button>
          <button class="main-tab-btn" onclick="switchTab('add')"><i data-lucide="plus-circle" class="w-4 h-4"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button>
          <button class="main-tab-btn" onclick="switchTab('archive')"><i data-lucide="archive" class="w-4 h-4"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
        </div>

        <div id="tab-overview" class="tab-content fade-in">
          <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
            <div class="overview-card border-b-4 border-slate-600"><h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h4><div id="stat-total" class="count text-slate-700">-</div></div>
            <div class="overview-card border-b-4 border-emerald-500"><h4>Ù…Ù†Ø¬Ø²</h4><div id="stat-done" class="count text-emerald-600">-</div></div>
            <div class="overview-card border-b-4 border-teal-400 bg-teal-50/30"><h4>Ø§Ù†ØªØ¸Ø§Ø±</h4><div id="stat-pending" class="count text-teal-600">-</div></div>
            <div class="overview-card border-b-4 border-blue-500 bg-blue-50/30"><h4>Ù‚ÙŠØ¯ Ø§Ù„ÙØ­Øµ</h4><div id="stat-review" class="count text-blue-600">-</div></div>
            <div class="overview-card border-b-4 border-red-500 bg-red-50/30"><h4>Ù…ØªØ£Ø®Ø±</h4><div id="stat-overdue" class="count text-red-600">-</div></div>
          </div>
          
          <div class="stat-card">
            <div class="flex justify-between items-center mb-4">
               <h3 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5 text-red-600"></i> ØªÙØ§ØµÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
               <button onclick="loadOverview()" class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200"><i data-lucide="refresh-cw" class="w-3 h-3"></i> ØªØ­Ø¯ÙŠØ«</button>
            </div>
            
            <div class="desktop-only overflow-x-auto">
              <table class="w-full text-sm text-right">
                 <thead class="bg-slate-100 text-slate-600 font-bold text-xs uppercase">
                   <tr>
                     <th class="p-3">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                     <th class="p-3 text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                     <th class="p-3 text-center text-emerald-600">Ù…Ù†Ø¬Ø²</th>
                     <th class="p-3 text-center text-teal-600">Ø§Ù†ØªØ¸Ø§Ø±</th>
                     <th class="p-3 text-center text-blue-600">ÙØ­Øµ</th>
                     <th class="p-3 text-center text-red-600">Ù…ØªØ£Ø®Ø±</th>
                     <th class="p-3 text-center">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                   </tr>
                 </thead>
                 <tbody id="employees-table-desktop"></tbody>
              </table>
            </div>
            
            <div id="employees-list-mobile" class="mobile-only"></div>
          </div>
        </div>

        <div id="tab-reassign" class="tab-content hidden-section">
          <div class="stat-card">
            <h3 class="font-bold mb-4 text-slate-800">Ø¥Ø¹Ø§Ø¯Ø© ØªÙƒÙ„ÙŠÙ Ù…Ù‡Ù…Ø©</h3>
            <div class="space-y-4">
              <div>
                <label class="text-xs font-bold text-slate-500 block mb-1">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                <div class="flex gap-2">
                  <input type="text" id="search-reassign" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯..." class="input-field">
                  <button onclick="searchTaskForAction('reassign')" class="bg-slate-800 text-white px-4 rounded-lg"><i data-lucide="search" class="w-4 h-4"></i></button>
                </div>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 block mb-1">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                <select id="new-employee" class="input-field"><option value="">-- Ø§Ø®ØªØ± --</option></select>
              </div>
              <div id="reassign-results" class="space-y-2"></div>
              <button onclick="executeReassign()" class="btn-primary mt-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„</button>
            </div>
          </div>
        </div>

        <div id="tab-status" class="tab-content hidden-section">
          <div class="stat-card">
            <h3 class="font-bold mb-4 text-slate-800">ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ù…Ù‡Ù…Ø©</h3>
            <div class="space-y-4">
              <div>
                <label class="text-xs font-bold text-slate-500 block mb-1">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                <div class="flex gap-2">
                  <input type="text" id="search-status" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯..." class="input-field">
                  <button onclick="searchTaskForAction('status')" class="bg-slate-800 text-white px-4 rounded-lg"><i data-lucide="search" class="w-4 h-4"></i></button>
                </div>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 block mb-1">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <select id="new-status-select" class="input-field">
                  <option value="">-- Ø§Ø®ØªØ± --</option>
                  <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
                  <option value="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø¯Ø¡">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¨Ø¯Ø¡</option>
                  <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                  <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                  <option value="Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</option>
                  <option value="ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯">ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</option>
                  <option value="Ù…ØªØ£Ø®Ø±">Ù…ØªØ£Ø®Ø±</option>
                </select>
              </div>
              <div id="status-results" class="space-y-2"></div>
              <button onclick="executeStatusUpdate()" class="btn-primary mt-2">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
            </div>
          </div>
        </div>

        <div id="tab-add" class="tab-content hidden-section">
          <div class="stat-card">
            <h3 class="font-bold mb-4 text-slate-800">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div><label class="text-xs font-bold text-slate-500">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="add-date" class="input-field"></div>
              <div><label class="text-xs font-bold text-slate-500">Ø§Ù„Ù…ØµØ¯Ø±</label><input type="text" id="add-source" class="input-field"></div>
              <div class="md:col-span-2"><label class="text-xs font-bold text-slate-500">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label><textarea id="add-subject" rows="2" class="input-field"></textarea></div>
              <div><label class="text-xs font-bold text-slate-500">Ø§Ù„Ø¬Ù‡Ø©</label><input type="text" id="add-entity" class="input-field"></div>
              <div><label class="text-xs font-bold text-slate-500">Ø§Ù„Ù…ÙˆØ¸Ù</label><select id="add-employee" class="input-field"><option value="">-- Ø§Ø®ØªØ± --</option></select></div>
              <div><label class="text-xs font-bold text-slate-500">Ù…ÙŠØ¹Ø§Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</label><input type="date" id="add-deadline" class="input-field"></div>
              <div><label class="text-xs font-bold text-slate-500">Ù…Ø±ÙÙ‚ (Ø±Ø§Ø¨Ø·)</label><input type="url" id="add-attachment" class="input-field"></div>
            </div>
            <button onclick="executeAddTask()" class="btn-primary mt-4">Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          </div>
        </div>

        <div id="tab-archive" class="tab-content hidden-section">
          <div class="stat-card mb-4">
            <h3 class="font-bold mb-3 text-slate-800">Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
              <select id="archive-year" class="input-field py-1 text-sm">
                <option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option><option value="2025" selected>2025</option><option value="2024">2024</option>
              </select>
              <select id="archive-month" class="input-field py-1 text-sm">
                <option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
                <option value="1">ÙŠÙ†Ø§ÙŠØ±</option><option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="3">Ù…Ø§Ø±Ø³</option><option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
                <option value="5">Ù…Ø§ÙŠÙˆ</option><option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option><option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option><option value="8">Ø£ØºØ³Ø·Ø³</option>
                <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option><option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option><option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
              </select>
              <div class="col-span-2">
                <input type="text" id="archive-search" placeholder="Ø¨Ø­Ø«..." class="input-field py-1 text-sm">
              </div>
            </div>
            <button onclick="searchArchiveAdmin()" class="btn-primary py-2">Ø¨Ø­Ø«</button>
          </div>
          <div id="archive-results-desktop" class="desktop-only stat-card overflow-x-auto"></div>
          <div id="archive-results-mobile" class="mobile-only"></div>
        </div>

      </div>
    </div>
  </div>

  <div id="loader" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center hidden-section">
    <div class="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p class="font-bold text-slate-800">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
  </div>

  <script>
    lucide.createIcons();
    let selectedTaskId = null;

    // â”€â”€ Helper â”€â”€
    function vibrateDevice() { if (navigator.vibrate) navigator.vibrate(10); }
    function showToast(msg, type='success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = type === 'error' ? `<i data-lucide="alert-circle" class="w-4 h-4"></i> ${msg}` : `<i data-lucide="check" class="w-4 h-4"></i> ${msg}`;
      container.appendChild(toast);
      lucide.createIcons();
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
    function toggleLoader(show) { document.getElementById('loader').classList.toggle('hidden-section', !show); }

    // â”€â”€ Logic â”€â”€
    async function checkAdminLogin() {
      const pin = document.getElementById('admin-pin-input').value;
      if (!pin || pin.length < 4) { showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² (4 Ø£Ø±Ù‚Ø§Ù…)", "error"); return; }
      vibrateDevice(); toggleLoader(true);
      
      try {
        if(typeof google === 'undefined' || !google.script) throw new Error("API Missing");
        google.script.run.withSuccessHandler(res => {
           if (res.success && res.role.includes('Ù…Ø¯ÙŠØ±')) {
              document.getElementById('admin-login-view').classList.add('hidden-section');
              document.getElementById('admin-content-view').classList.remove('hidden-section');
              loadOverview();
           } else { showToast("ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ", "error"); toggleLoader(false); }
        }).withFailureHandler(e => { showToast("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„", "error"); toggleLoader(false); }).loginUser(pin);
      } catch(e) { console.error(e); toggleLoader(false); }
    }

    function loadOverview(){
      google.script.run.withSuccessHandler(data => {
        toggleLoader(false);
        if(!data || data.error) return;

        // Stats
        document.getElementById('stat-total').innerText = data.totals.total || 0;
        document.getElementById('stat-done').innerText = data.totals.completed || 0;
        document.getElementById('stat-pending').innerText = data.totals.pending_approval || 0;
        document.getElementById('stat-review').innerText = data.totals.review || 0;
        document.getElementById('stat-overdue').innerText = data.totals.overdue || 0;
        
        // Populate Dropdowns
        const empSelects = [document.getElementById('new-employee'), document.getElementById('add-employee')];
        empSelects.forEach(sel => {
           sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>';
           data.employees.forEach(e => sel.innerHTML += `<option value="${e.name}">${e.name}</option>`);
        });

        renderEmployeesTable(data.employees);
      }).getDashboardData('2020-01-01','2030-12-31');
    }

    function renderEmployeesTable(list) {
      const desktop = document.getElementById('employees-table-desktop');
      const mobile = document.getElementById('employees-list-mobile');
      desktop.innerHTML = ''; mobile.innerHTML = '';
      
      if(!list) return;

      list.forEach(e => {
        // Desktop
        desktop.innerHTML += `
          <tr class="border-b hover:bg-slate-50">
            <td class="p-3">
              <div class="font-bold text-slate-800">${e.name}</div>
              <div class="text-[10px] text-slate-400 bg-slate-100 px-1 rounded w-fit mt-1">${e.breakdownStr || ''}</div>
            </td>
            <td class="p-3 text-center font-bold">${e.total}</td>
            <td class="p-3 text-center text-emerald-600 font-bold">${e.completed}</td>
            <td class="p-3 text-center text-teal-600 font-bold">${e.pending_approval}</td>
            <td class="p-3 text-center text-blue-600 font-bold">${e.review}</td>
            <td class="p-3 text-center font-bold ${e.overdue > 0 ? 'text-red-600' : 'text-slate-300'}">${e.overdue}</td>
            <td class="p-3 text-center font-bold text-slate-700">%${e.rate}</td>
          </tr>`;
          
        // Mobile
        mobile.innerHTML += `
          <div class="mobile-card">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-bold text-slate-800">${e.name}</h4>
                <p class="text-[10px] text-slate-500 mt-1">${e.breakdownStr || ''}</p>
              </div>
              <span class="bg-slate-100 text-xs px-2 py-1 rounded font-bold">Ù…Ø¬Ù…ÙˆØ¹: ${e.total}</span>
            </div>
            <div class="grid grid-cols-5 gap-1 mt-2 text-center text-[10px] font-bold">
               <div class="bg-emerald-50 text-emerald-700 py-1 rounded">âœ… ${e.completed}</div>
               <div class="bg-teal-50 text-teal-700 py-1 rounded">â³ ${e.pending_approval}</div>
               <div class="bg-blue-50 text-blue-700 py-1 rounded">ğŸ§ ${e.review}</div>
               <div class="${e.overdue > 0 ? 'bg-red-100 text-red-700' : 'bg-slate-50 text-slate-300'} py-1 rounded">ğŸš¨ ${e.overdue}</div>
               <div class="bg-slate-100 text-slate-700 py-1 rounded">%${e.rate}</div>
            </div>
          </div>`;
      });
    }

    // â”€â”€ Search & Actions â”€â”€
    function searchTaskForAction(type) {
      const q = document.getElementById('search-' + type).value;
      if(q.length < 2) { showToast("Ø§ÙƒØªØ¨ Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error"); return; }
      toggleLoader(true);
      
      google.script.run.withSuccessHandler(res => {
        toggleLoader(false);
        const container = document.getElementById(type + '-results');
        container.innerHTML = '';
        selectedTaskId = null;

        if(res.success && res.results.length > 0) {
           res.results.forEach(t => {
             container.innerHTML += `
               <div onclick="selectTask(this, '${t.id}')" class="mobile-card cursor-pointer hover:border-red-500 border-2 border-transparent transition">
                  <div class="flex justify-between"><span class="font-bold text-xs bg-slate-100 px-2 rounded">#${t.id}</span><span class="text-xs text-slate-400">${t.date}</span></div>
                  <div class="font-bold text-sm mt-1">${t.subject}</div>
                  <div class="text-xs text-slate-500">${t.entity}</div>
               </div>`;
           });
        } else { container.innerHTML = '<p class="text-center text-slate-400">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬</p>'; }
      }).searchArchive({ search: q }); // Search all dates
    }

    function selectTask(el, id) {
       document.querySelectorAll('.mobile-card').forEach(c => { c.classList.remove('border-red-500','bg-red-50'); c.classList.add('border-transparent'); });
       el.classList.remove('border-transparent'); el.classList.add('border-red-500','bg-red-50');
       selectedTaskId = id; vibrateDevice();
    }

    function executeReassign() {
       if(!selectedTaskId) return showToast("Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø©", "error");
       const emp = document.getElementById('new-employee').value;
       if(!emp) return showToast("Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù", "error");
       toggleLoader(true);
       google.script.run.withSuccessHandler(() => { showToast("ØªÙ… Ø§Ù„Ù†Ù‚Ù„"); toggleLoader(false); }).reassignTask(selectedTaskId, emp);
    }

    function executeStatusUpdate() {
       if(!selectedTaskId) return showToast("Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø©", "error");
       const st = document.getElementById('new-status-select').value;
       if(!st) return showToast("Ø§Ø®ØªØ± Ø­Ø§Ù„Ø©", "error");
       toggleLoader(true);
       google.script.run.withSuccessHandler(() => { showToast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); toggleLoader(false); }).updateTaskStatus(selectedTaskId, st);
    }

    function executeAddTask() {
       const d = {
         date: document.getElementById('add-date').value,
         source: document.getElementById('add-source').value,
         subject: document.getElementById('add-subject').value,
         entity: document.getElementById('add-entity').value,
         employee: document.getElementById('add-employee').value,
         deadline: document.getElementById('add-deadline').value,
         attachment: document.getElementById('add-attachment').value
       };
       if(!d.date || !d.source || !d.subject) return showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©", "error");
       toggleLoader(true);
       google.script.run.withSuccessHandler(() => { showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); toggleLoader(false); }).addTaskManual(d);
    }

    function searchArchiveAdmin(){
      const f = {
        year: document.getElementById('archive-year').value,
        month: document.getElementById('archive-month').value,
        search: document.getElementById('archive-search').value
      };
      toggleLoader(true);
      google.script.run.withSuccessHandler(res => {
        toggleLoader(false);
        const desktop = document.getElementById('archive-results-desktop');
        const mobile = document.getElementById('archive-results-mobile');
        
        if(res.results.length === 0){
           desktop.innerHTML = '<p class="text-center text-slate-400 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
           mobile.innerHTML = '<p class="text-center text-slate-400 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
           return;
        }

        let dHtml = '<table class="w-full text-sm text-right"><thead class="bg-slate-100 font-bold"><tr><th class="p-3">Ø±Ù‚Ù…</th><th class="p-3">ØªØ§Ø±ÙŠØ®</th><th class="p-3">Ø¬Ù‡Ø©</th><th class="p-3">Ù…ÙˆØ¶ÙˆØ¹</th><th class="p-3">Ù…Ø±ÙÙ‚</th></tr></thead><tbody>';
        let mHtml = '';

        res.results.forEach(r => {
          // Restore Attachment Logic
          let att = '';
          if(r.taskAttachment) att += `<a href="${r.taskAttachment}" target="_blank" class="text-cyan-600 hover:underline mx-1" title="Ù…Ø±ÙÙ‚ Ø§Ù„ØªÙƒÙ„ÙŠÙ">ğŸ“</a>`;
          // Assuming backend returns reportDoc/reportPdf if available (future proof)
          if(r.reportDoc) att += `<a href="${r.reportDoc}" target="_blank" class="text-blue-600 hover:underline mx-1" title="Doc">ğŸ“„</a>`;
          if(r.reportPdf) att += `<a href="${r.reportPdf}" target="_blank" class="text-red-600 hover:underline mx-1" title="PDF">ğŸ“•</a>`;
          
          dHtml += `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-bold">${r.id}</td><td class="p-3">${r.date}</td><td class="p-3">${r.entity}</td><td class="p-3">${r.subject}</td><td class="p-3 text-center">${att || '-'}</td></tr>`;
          
          mHtml += `
            <div class="mobile-card">
              <div class="flex justify-between"><span class="font-bold bg-slate-100 px-2 rounded">#${r.id}</span><span class="text-slate-400 text-xs">${r.date}</span></div>
              <div class="font-bold text-sm mt-1">${r.subject}</div>
              <div class="text-xs text-slate-500">${r.entity}</div>
              <div class="mt-2 text-left">${att}</div>
            </div>`;
        });
        dHtml += '</tbody></table>';
        desktop.innerHTML = dHtml;
        mobile.innerHTML = mHtml;
      }).searchArchive(f);
    }

    function switchTab(tabName){
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden-section'));
      document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-'+tabName).classList.remove('hidden-section');
      
      // Robust active class toggling
      const buttons = document.querySelectorAll('.main-tab-btn');
      buttons.forEach(btn => {
         if(btn.getAttribute('onclick').includes(tabName)) {
            btn.classList.add('active');
         }
      });
    }
    
    function goHome() { window.location.href = 'index.html'; }
    function logout() { window.location.href = 'index.html'; }
    lucide.createIcons();
  </script>
</body>
</html>
