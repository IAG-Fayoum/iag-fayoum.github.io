<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>لوحة المنسق | نظام الحوكمة</title>
    
    <link rel="icon" type="image/png" href="assets/icons/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; padding-bottom: 80px; }
        
        /* --- Colors --- */
        :root {
            --primary: #0f766e;
            --secondary: #115e59;
            --light-bg: #f0fdfa;
            --accent: #14b8a6;
        }

        /* --- Sidebar & Navigation --- */
        .sidebar {
            position: fixed; right: 0; top: 0; height: 100vh; width: 280px;
            background: white; border-left: 1px solid #e2e8f0;
            padding: 2rem 1.5rem; display: none; flex-direction: column; gap: 1.5rem;
            overflow-y: auto; z-index: 100;
        }

        @media (min-width: 1024px) {
            .sidebar { display: flex; }
            body { padding-right: 280px; padding-bottom: 0; }
            .mobile-header, .bottom-nav { display: none; }
        }

        .sidebar-header { display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #f1f5f9; }
        .logo { width: 48px; height: 48px; object-fit: contain; }
        .title { font-size: 1.1rem; font-weight: 800; color: #0f766e; margin: 0; }
        .subtitle { font-size: 0.75rem; color: #64748b; margin: 0; }

        .user-info-card {
            background: linear-gradient(135deg, #f0fdfa 0%, #e6f7f5 100%);
            border: 1px solid #99f6e4; border-radius: 12px; padding: 1rem;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .user-avatar {
            width: 40px; height: 40px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #0f766e;
        }
        .user-name { font-size: 0.9rem; font-weight: 700; color: #0f766e; margin: 0; }
        .user-role { font-size: 0.75rem; color: #64748b; margin: 0; }

        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-link {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem;
            border-radius: 10px; color: #64748b; text-decoration: none;
            font-weight: 600; font-size: 0.9rem; transition: all 0.2s; position: relative;
        }
        .nav-link:hover { background: #f0fdfa; color: #0f766e; }
        .nav-link.active { background: #0f766e; color: white; box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3); }
        .nav-link i { width: 20px; height: 20px; }

        .notif-badge {
            margin-right: auto; background: #dc2626; color: white;
            font-size: 0.7rem; font-weight: 800; padding: 2px 6px;
            border-radius: 10px; min-width: 20px; text-align: center;
        }

        .btn-logout {
            width: 100%; padding: 0.875rem; background: #fee2e2; color: #dc2626;
            border: 1px solid #fecaca; border-radius: 10px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-logout:hover { background: #fecaca; }

        /* --- Mobile Header --- */
        .mobile-header {
            background: white; border-bottom: 1px solid #e2e8f0;
            padding: 1rem; position: sticky; top: 0; z-index: 90;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-center { display: flex; align-items: center; gap: 0.75rem; }
        .header-logo { width: 36px; height: 36px; object-fit: contain; }
        .header-title { font-size: 1rem; font-weight: 800; color: #0f766e; margin: 0; }
        .header-subtitle { font-size: 0.7rem; color: #64748b; margin: 0; }
        .btn-hamburger, .btn-notifications { background: transparent; border: none; color: #64748b; cursor: pointer; }
        .notif-badge-mobile {
            position: absolute; top: 8px; right: 8px; background: #dc2626;
            color: white; font-size: 0.6rem; font-weight: 800; padding: 1px 4px;
            border-radius: 8px; min-width: 14px; text-align: center;
        }

        /* --- Mobile Slide Menu --- */
        .slide-menu {
            position: fixed; inset: 0; z-index: 200; pointer-events: none;
            transition: opacity 0.3s; opacity: 0;
        }
        .slide-menu.active { pointer-events: auto; opacity: 1; }
        .slide-menu-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.5);
        }
        .slide-menu-content {
            position: absolute; top: 0; right: 0; bottom: 0; width: 280px;
            background: white; padding: 2rem 1.5rem; display: flex; flex-direction: column;
            gap: 1.5rem; transform: translateX(100%); transition: transform 0.3s;
        }
        .slide-menu.active .slide-menu-content { transform: translateX(0); }
        .slide-user-info {
            text-align: center; padding-bottom: 1.5rem; border-bottom: 1px solid #f1f5f9;
        }
        .user-avatar-big {
            width: 64px; height: 64px; background: #f0fdfa; color: #0f766e;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin: 0 auto 0.75rem; font-size: 1.5rem;
        }
        .slide-user-name { font-weight: 700; color: #0f766e; margin-bottom: 0.25rem; }
        .slide-user-role { font-size: 0.8rem; color: #64748b; }
        .slide-nav { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; }
        .slide-link {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem;
            color: #64748b; text-decoration: none; font-weight: 600; border-radius: 10px;
        }
        .slide-link.active { background: #0f766e; color: white; }
        .slide-logout {
            width: 100%; padding: 0.875rem; background: #fee2e2; color: #dc2626;
            border: 1px solid #fecaca; border-radius: 10px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            border-top: 1px solid #e2e8f0; padding: 0.5rem 0; display: flex;
            justify-content: space-around; z-index: 90;
        }
        .bottom-nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 0.25rem;
            color: #94a3b8; text-decoration: none; font-size: 0.7rem; font-weight: 600;
            padding: 0.5rem; border-radius: 8px; position: relative;
        }
        .bottom-nav-item.active { color: #0f766e; background: #f0fdfa; }
        .notif-badge-mobile-bottom {
            position: absolute; top: 4px; right: 25%; background: #dc2626;
            color: white; font-size: 0.6rem; padding: 1px 4px; border-radius: 8px;
        }

        /* --- Main Content Layout --- */
        .main-content { padding: 1.5rem; max-width: 1600px; margin: 0 auto; }
        @media (min-width: 1024px) { .main-content { padding: 2rem; } }

        /* --- Filters Section --- */
        .filters-wrapper { margin-bottom: 2rem; }
        .filters-box {
            background: white; border-radius: 16px; padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
        }
        .filters-title {
            display: flex; align-items: center; gap: 0.5rem; font-weight: 800;
            color: #1e293b; margin-bottom: 1.5rem; font-size: 1.1rem;
        }
        .filters-title i { color: #0f766e; }
        
        .filters-grid {
            display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem;
        }
        @media (min-width: 768px) { .filters-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1280px) { .filters-grid { grid-template-columns: repeat(4, 1fr); } }
        
        .filter-item { display: flex; flex-direction: column; gap: 0.5rem; }
        .filter-full-width { grid-column: 1 / -1; }
        .filter-label { font-size: 0.8rem; font-weight: 700; color: #64748b; }
        .filter-input {
            padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 10px;
            font-size: 0.9rem; outline: none; transition: border-color 0.2s;
            background-color: #f8fafc; width: 100%;
        }
        .filter-input:focus { border-color: #0f766e; background-color: white; }
        
        .filter-actions {
            grid-column: 1 / -1; display: flex; gap: 1rem; margin-top: 0.5rem;
        }
        .btn-apply-filter, .btn-reset-filter {
            flex: 1; padding: 0.875rem; border-radius: 10px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            cursor: pointer; transition: all 0.2s; border: none;
        }
        .btn-apply-filter { background: #0f766e; color: white; }
        .btn-apply-filter:hover { background: #115e59; }
        .btn-reset-filter { background: #fee2e2; color: #dc2626; }
        .btn-reset-filter:hover { background: #fecaca; }

        /* --- Stats Cards --- */
        .stats-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem; margin-bottom: 2rem;
        }
        .stat-card {
            background: white; border-radius: 14px; padding: 1.25rem;
            border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 1rem;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .stat-card.active {
            border-color: #0f766e; background: #f0fdfa;
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.15);
        }
        .stat-icon {
            width: 48px; height: 48px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .stat-content { flex: 1; display: flex; flex-direction: column; }
        .stat-number { font-size: 1.75rem; font-weight: 800; line-height: 1; margin-bottom: 4px; }
        .stat-label { font-size: 0.8rem; font-weight: 600; color: #64748b; }

        /* --- Tasks Grid --- */
        .tasks-grid {
            display: grid; gap: 1.5rem; padding-bottom: 2rem;
        }
        @media (min-width: 768px) { .tasks-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1280px) { .tasks-grid { grid-template-columns: repeat(3, 1fr); } }

        /* --- Task Card Design --- */
        .task-card {
            background: white; border-radius: 16px; overflow: hidden; position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e2e8f0;
            transition: all 0.3s ease; display: flex; flex-direction: column;
        }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 12px 28px rgba(0,0,0,0.12); }
        
        .card-status-border {
            position: absolute; right: 0; top: 0; bottom: 0; width: 5px;
        }

        /* Status Colors */
        .task-card[data-status*="جديد"] .card-status-border { background: #3b82f6; }
        .task-card[data-status*="جديد"] { background: linear-gradient(to left, #eff6ff 0%, white 8%); }
        
        .task-card[data-status*="بانتظار"] .card-status-border { background: #86efac; }
        .task-card[data-status*="بانتظار"] { background: linear-gradient(to left, #dcfce7 0%, white 8%); }
        
        .task-card[data-status*="تم الاعتماد"] .card-status-border { background: #064e3b; }
        .task-card[data-status*="تم الاعتماد"] { background: linear-gradient(to left, #d1fae5 0%, white 8%); }
        
        .task-card[data-status*="متابعة"] .card-status-border { background: #94a3b8; }
        .task-card[data-status*="متابعة"] { background: linear-gradient(to left, #f1f5f9 0%, white 8%); }
        
        .task-card[data-status*="متأخر"] .card-status-border { background: #dc2626; }
        .task-card[data-status*="متأخر"] { background: linear-gradient(to left, #fee2e2 0%, white 8%); }

        .card-header {
            padding: 1.25rem 1.25rem 0.75rem; display: flex;
            justify-content: space-between; align-items: center;
        }
        .card-id {
            font-family: 'Courier New', monospace; font-size: 0.85rem; font-weight: 800;
            color: #64748b; background: rgba(0,0,0,0.04); padding: 4px 10px; border-radius: 6px;
        }
        .card-status-badge {
            display: flex; align-items: center; gap: 4px; padding: 5px 10px;
            border-radius: 20px; font-size: 0.75rem; font-weight: 700;
            background: white; border: 1px solid #e2e8f0;
        }

        .card-body { padding: 0.75rem 1.25rem 1.25rem; flex: 1; }
        .card-subject {
            font-size: 1.05rem; font-weight: 700; color: #1e293b;
            line-height: 1.5; margin-bottom: 1rem;
        }
        
        .card-info-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.875rem; margin-bottom: 1rem;
        }
        .info-item { display: flex; align-items: start; gap: 0.5rem; }
        .info-icon { width: 16px; height: 16px; color: #0f766e; flex-shrink: 0; margin-top: 2px; }
        .info-text { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .info-label { font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .info-value { font-size: 0.875rem; font-weight: 600; color: #1e293b; }
        
        .days-badge {
            display: inline-block; padding: 3px 8px; border-radius: 6px;
            background: #dcfce7; color: #16a34a; font-weight: 700;
        }
        .days-badge.warning { background: #fee2e2; color: #dc2626; }

        .card-bottom-info {
            display: flex; gap: 0.5rem; flex-wrap: wrap; padding-top: 0.75rem;
            border-top: 1px dashed #e2e8f0;
        }
        .employee-badge, .importance-badge {
            display: flex; align-items: center; gap: 5px; padding: 6px 10px;
            border-radius: 8px; font-size: 0.8rem; font-weight: 600;
        }
        .employee-badge { background: #f0fdfa; color: #0f766e; border: 1px solid #99f6e4; }
        .importance-badge { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }

        .card-footer {
            padding: 1rem 1.25rem; background: #f8fafc; border-top: 1px solid #e2e8f0;
            display: flex; gap: 0.5rem;
        }
        .btn-card-primary, .btn-card-secondary {
            flex: 1; padding: 10px; border-radius: 10px; font-size: 0.85rem; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer; transition: all 0.2s; border: none; text-decoration: none;
        }
        .btn-card-primary { background: #0f766e; color: white; }
        .btn-card-primary:hover { background: #115e59; transform: translateY(-2px); }
        .btn-card-secondary { background: white; color: #0f766e; border: 2px solid #0f766e; }
        .btn-card-secondary:hover { background: #f0fdfa; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200;
            display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content {
            background: white; width: 90%; max-width: 600px; max-height: 90vh;
            border-radius: 20px; overflow-y: auto; padding: 2rem; position: relative;
            transform: translateY(20px); transition: transform 0.3s;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .btn-close-modal {
            position: absolute; top: 1rem; left: 1rem; background: #f1f5f9;
            border: none; width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .modal-details-grid { display: grid; gap: 1rem; margin-top: 1.5rem; }
        .detail-row { display: flex; flex-direction: column; gap: 0.25rem; padding-bottom: 0.5rem; border-bottom: 1px solid #f1f5f9; }
        .detail-label { font-size: 0.8rem; font-weight: 700; color: #64748b; }
        .detail-value { font-size: 1rem; font-weight: 600; color: #1e293b; }

        /* Loading & Empty States */
        .loading-spinner {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 4rem; gap: 1rem; color: #0f766e;
        }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .empty-state {
            text-align: center; padding: 4rem 1rem; grid-column: 1 / -1;
        }
        .empty-icon {
            width: 64px; height: 64px; background: #f1f5f9; color: #94a3b8;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin: 0 auto 1rem;
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="assets/icons/favicon.png" class="logo">
            <div>
                <h1 class="title">نظام الحوكمة</h1>
                <p class="subtitle">لوحة المنسق</p>
            </div>
        </div>
        
        <div class="user-info-card">
            <div class="user-avatar"><i data-lucide="user-circle"></i></div>
            <div>
                <p class="user-name" id="sidebar-user-name">...</p>
                <p class="user-role" id="sidebar-user-role">...</p>
            </div>
        </div>
        
        <nav class="nav-menu">
            <a href="index.html" class="nav-link"><i data-lucide="home"></i><span>الرئيسية</span></a>
            <a href="distribution.html" class="nav-link"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
            <a href="coordinator.html" class="nav-link active"><i data-lucide="users"></i><span>المنسقين</span></a>
            <a href="forms.html" class="nav-link"><i data-lucide="file-text"></i><span>النماذج</span></a>
            <a href="notifications.html" class="nav-link"><i data-lucide="bell"></i><span>الإشعارات</span><span class="notif-badge">3</span></a>
        </nav>
        
        <button class="btn-logout" onclick="auth.logout()"><i data-lucide="log-out"></i><span>تسجيل الخروج</span></button>
    </aside>

    <header class="mobile-header">
        <div class="header-content">
            <button class="btn-hamburger" onclick="toggleMenu()"><i data-lucide="menu"></i></button>
            <div class="header-center">
                <img src="assets/icons/favicon.png" class="header-logo">
                <div>
                    <p class="header-subtitle">إدارة الحوكمة</p>
                    <h1 class="header-title">المنسقين</h1>
                </div>
            </div>
            <button class="btn-notifications" onclick="window.location.href='notifications.html'">
                <i data-lucide="bell"></i><span class="notif-badge-mobile">3</span>
            </button>
        </div>
    </header>

    <div class="slide-menu" id="slide-menu">
        <div class="slide-menu-overlay" onclick="toggleMenu()"></div>
        <div class="slide-menu-content">
            <div class="slide-user-info">
                <div class="user-avatar-big"><i data-lucide="user-circle"></i></div>
                <p class="slide-user-name" id="mobile-user-name">...</p>
                <p class="slide-user-role" id="mobile-user-role">...</p>
            </div>
            <nav class="slide-nav">
                <a href="index.html" class="slide-link"><i data-lucide="home"></i><span>الرئيسية</span></a>
                <a href="distribution.html" class="slide-link"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
                <a href="coordinator.html" class="slide-link active"><i data-lucide="users"></i><span>المنسقين</span></a>
                <a href="forms.html" class="slide-link"><i data-lucide="file-text"></i><span>النماذج</span></a>
                <a href="notifications.html" class="slide-link"><i data-lucide="bell"></i><span>الإشعارات</span><span class="notif-badge">3</span></a>
            </nav>
            <button class="slide-logout" onclick="auth.logout()"><i data-lucide="log-out"></i><span>تسجيل الخروج</span></button>
        </div>
    </div>

    <div class="main-content">
        
        <div class="filters-wrapper">
            <div class="filters-box">
                <h3 class="filters-title"><i data-lucide="filter"></i><span>الفلاتر</span></h3>
                <div class="filters-grid">
                    <div class="filter-item">
                        <label class="filter-label">الموظف المسؤول</label>
                        <select id="f-employee" class="filter-input">
                            <option value="">عرض الكل</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">الجهة الوارد منها</label>
                        <select id="f-source" class="filter-input">
                            <option value="">كل الجهات</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">نوع المستند</label>
                        <select id="f-doctype" class="filter-input">
                            <option value="">كل الأنواع</option>
                            <option value="مرور فني مستشفيات">مرور فني مستشفيات</option>
                            <option value="فني وحدات الرعاية">فني وحدات الرعاية</option>
                            <option value="المرور المالي والإداري">المرور المالي والإداري</option>
                            <option value="فحص الشكاوى">فحص الشكاوى</option>
                            <option value="سجل الصادر والوارد">الصادر والوارد</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">الأهمية</label>
                        <select id="f-importance" class="filter-input">
                            <option value="">كل الدرجات</option>
                            <option value="هام وعاجل">هام وعاجل</option>
                            <option value="هام">هام فقط</option>
                            <option value="عاجل">عاجل فقط</option>
                            <option value="عادي">عادي</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">من تاريخ</label>
                        <input type="date" id="f-start" class="filter-input">
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">إلى تاريخ</label>
                        <input type="date" id="f-end" class="filter-input">
                    </div>
                    <div class="filter-item filter-full-width">
                        <label class="filter-label">بحث عام</label>
                        <input type="text" id="f-search" class="filter-input" placeholder="ابحث في الموضوع أو رقم القيد...">
                    </div>
                    <div class="filter-actions">
                        <button class="btn-apply-filter" onclick="applyFilters()"><i data-lucide="search"></i><span>تطبيق الفلتر</span></button>
                        <button class="btn-reset-filter" onclick="resetFilters()"><i data-lucide="x"></i><span>إعادة تعيين</span></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card active" onclick="filterByStatus('')" id="stat-total">
                <div class="stat-icon" style="background: #f1f5f9; color: #334155;"><i data-lucide="layers"></i></div>
                <div class="stat-content"><span class="stat-number" id="count-total">0</span><span class="stat-label">الإجمالي</span></div>
            </div>
            <div class="stat-card" onclick="filterByStatus('جديد')" id="stat-new">
                <div class="stat-icon" style="background: #eff6ff; color: #3b82f6;"><i data-lucide="file-plus"></i></div>
                <div class="stat-content"><span class="stat-number" style="color: #3b82f6;" id="count-new">0</span><span class="stat-label">جديد</span></div>
            </div>
            <div class="stat-card" onclick="filterByStatus('بانتظار الاعتماد')" id="stat-pending">
                <div class="stat-icon" style="background: #dcfce7; color: #16a34a;"><i data-lucide="clock"></i></div>
                <div class="stat-content"><span class="stat-number" style="color: #16a34a;" id="count-pending">0</span><span class="stat-label">بانتظار الاعتماد</span></div>
            </div>
            <div class="stat-card" onclick="filterByStatus('تم الاعتماد')" id="stat-approved">
                <div class="stat-icon" style="background: #d1fae5; color: #064e3b;"><i data-lucide="check-circle"></i></div>
                <div class="stat-content"><span class="stat-number" style="color: #064e3b;" id="count-approved">0</span><span class="stat-label">تم الاعتماد</span></div>
            </div>
            <div class="stat-card" onclick="filterByStatus('بحاجة الي متابعة')" id="stat-followup">
                <div class="stat-icon" style="background: #f1f5f9; color: #475569;"><i data-lucide="eye"></i></div>
                <div class="stat-content"><span class="stat-number" style="color: #475569;" id="count-followup">0</span><span class="stat-label">للمتابعة</span></div>
            </div>
            <div class="stat-card" onclick="filterByStatus('متأخر')" id="stat-late">
                <div class="stat-icon" style="background: #fee2e2; color: #dc2626;"><i data-lucide="alert-circle"></i></div>
                <div class="stat-content"><span class="stat-number" style="color: #dc2626;" id="count-late">0</span><span class="stat-label">متأخر</span></div>
            </div>
        </div>

        <div class="tasks-grid" id="tasks-container">
            <div class="loading-spinner">
                <i data-lucide="loader-2" class="animate-spin" style="width: 48px; height: 48px;"></i>
                <p>جاري تحميل البيانات...</p>
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav-item"><i data-lucide="home"></i><span>الرئيسية</span></a>
        <a href="distribution.html" class="bottom-nav-item"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></a>
        <a href="coordinator.html" class="bottom-nav-item active"><i data-lucide="users"></i><span>المنسقين</span></a>
        <a href="forms.html" class="bottom-nav-item"><i data-lucide="file-text"></i><span>النماذج</span></a>
        <a href="notifications.html" class="bottom-nav-item"><i data-lucide="bell"></i><span class="notif-badge-mobile-bottom">3</span></a>
    </nav>

    <div class="modal-overlay" id="details-modal">
        <div class="modal-content">
            <button class="btn-close-modal" onclick="closeModal()"><i data-lucide="x"></i></button>
            <h2 class="card-subject" style="margin-bottom: 0;">تفاصيل المهمة</h2>
            <div class="modal-details-grid" id="modal-details-body">
                </div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        lucide.createIcons();
        let allTasks = [];
        let currentStatusFilter = '';

        document.addEventListener('DOMContentLoaded', async () => {
            const user = auth.checkSession();
            if (!user) {
                window.location.replace('index.html');
                return;
            }
            if (user.role !== 'منسق' && user.role !== 'مدير') {
                alert('غير مصرح لك بالدخول');
                window.location.replace('index.html');
                return;
            }

            document.querySelectorAll('#sidebar-user-name, #mobile-user-name').forEach(el => el.textContent = user.name);
            document.querySelectorAll('#sidebar-user-role, #mobile-user-role').forEach(el => el.textContent = user.role);

            await loadData(user.name);
        });

        function toggleMenu() {
            document.getElementById('slide-menu').classList.toggle('active');
        }

        async function loadData(userName) {
            try {
                const API_URL = (typeof CONFIG !== 'undefined') ? CONFIG.API_URL : '';
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getAllData', role: 'مدير', name: userName })
                });
                const data = await response.json();

                if (data.success) {
                    allTasks = data.tasks || [];
                    populateFiltersFromData();
                    setDefaultDateFilter();
                    updateStats();
                    applyFilters();
                } else {
                    document.getElementById('tasks-container').innerHTML = `<div class="empty-state"><p>${data.error}</p></div>`;
                }
            } catch (error) {
                document.getElementById('tasks-container').innerHTML = `<div class="empty-state"><p>خطأ في الاتصال</p></div>`;
            }
        }

        function populateFiltersFromData() {
            const employees = new Set();
            const sources = new Set();
            allTasks.forEach(t => {
                if (t.assignee) employees.add(t.assignee.trim());
                if (t.source) sources.add(t.source.trim());
            });

            const empSelect = document.getElementById('f-employee');
            Array.from(employees).sort().forEach(n => empSelect.add(new Option(n, n)));

            const srcSelect = document.getElementById('f-source');
            Array.from(sources).sort().forEach(s => srcSelect.add(new Option(s, s)));
        }

        function setDefaultDateFilter() {
            const today = new Date();
            const first = new Date(today.getFullYear(), today.getMonth(), 1);
            const last = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            document.getElementById('f-start').value = first.toISOString().split('T')[0];
            document.getElementById('f-end').value = last.toISOString().split('T')[0];
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            const id = status === '' ? 'total' : 
                       status.includes('جديد') ? 'new' : 
                       status.includes('بانتظار') ? 'pending' : 
                       status.includes('تم') ? 'approved' : 
                       status.includes('متابعة') ? 'followup' : 'late';
            document.getElementById('stat-' + id).classList.add('active');
            applyFilters();
        }

        function updateStats() {
            const counts = { total: 0, new: 0, pending: 0, approved: 0, followup: 0, late: 0 };
            
            // Stats always calculated from FULL filtered dataset (except status filter)
            // But usually stats show GLOBAL counts for the period. Let's use date-filtered data.
            
            const startStr = document.getElementById('f-start').value;
            const endStr = document.getElementById('f-end').value;
            
            allTasks.forEach(t => {
                // Apply Date Filter Only for Stats Context
                if(startStr && endStr) {
                    const d = t.date.split('/').reverse().join('-');
                    if(d < startStr || d > endStr) return;
                }

                counts.total++;
                const s = t.status || '';
                if(s.includes('جديد')) counts.new++;
                else if(s.includes('بانتظار')) counts.pending++;
                else if(s.includes('تم')) counts.approved++;
                else if(s.includes('متابعة')) counts.followup++;
                else if(s.includes('متأخر')) counts.late++;
            });

            document.getElementById('count-total').innerText = counts.total;
            document.getElementById('count-new').innerText = counts.new;
            document.getElementById('count-pending').innerText = counts.pending;
            document.getElementById('count-approved').innerText = counts.approved;
            document.getElementById('count-followup').innerText = counts.followup;
            document.getElementById('count-late').innerText = counts.late;
        }

        function applyFilters() {
            const emp = document.getElementById('f-employee').value;
            const src = document.getElementById('f-source').value;
            const type = document.getElementById('f-doctype').value;
            const imp = document.getElementById('f-importance').value;
            const search = document.getElementById('f-search').value.toLowerCase();
            const start = document.getElementById('f-start').value;
            const end = document.getElementById('f-end').value;

            const filtered = allTasks.filter(t => {
                if(currentStatusFilter && !(t.status || '').includes(currentStatusFilter)) return false;
                if(emp && t.assignee !== emp) return false;
                if(src && t.source !== src) return false;
                if(type && t.docType !== type) return false;
                if(imp && t.importance !== imp) return false;
                if(search && !(t.subject+t.id).toLowerCase().includes(search)) return false;
                
                if(start && end) {
                    const d = t.date.split('/').reverse().join('-');
                    if(d < start || d > end) return false;
                }
                return true;
            });

            renderTasks(filtered);
        }

        function renderTasks(tasks) {
            const container = document.getElementById('tasks-container');
            if(tasks.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-icon"><i data-lucide="search-x"></i></div><p class="text-slate-500 font-bold">لا توجد معاملات</p></div>`;
                lucide.createIcons();
                return;
            }

            container.innerHTML = tasks.map(t => {
                let badgeIcon = 'circle';
                if(t.status.includes('تم')) badgeIcon = 'check-circle';
                else if(t.status.includes('متأخر')) badgeIcon = 'alert-circle';
                else if(t.status.includes('جديد')) badgeIcon = 'file-plus';
                else if(t.status.includes('بانتظار')) badgeIcon = 'clock';

                return `
                <div class="task-card" data-status="${t.status}">
                    <div class="card-status-border"></div>
                    <div class="card-header">
                        <span class="card-id">#${t.id}</span>
                        <span class="card-status-badge"><i data-lucide="${badgeIcon}"></i><span>${t.status}</span></span>
                    </div>
                    <div class="card-body">
                        <h3 class="card-subject">${t.subject}</h3>
                        <div class="card-info-grid">
                            <div class="info-item"><i data-lucide="file-text" class="info-icon"></i><div class="info-text"><span class="info-label">نوع المستند</span><span class="info-value">${t.docType}</span></div></div>
                            <div class="info-item"><i data-lucide="building" class="info-icon"></i><div class="info-text"><span class="info-label">الجهة الوارد منها</span><span class="info-value">${t.source}</span></div></div>
                            <div class="info-item"><i data-lucide="calendar" class="info-icon"></i><div class="info-text"><span class="info-label">التاريخ</span><span class="info-value">${t.date}</span></div></div>
                            <div class="info-item"><i data-lucide="timer" class="info-icon"></i><div class="info-text"><span class="info-label">المتبقي</span><span class="info-value days-badge" data-days="${t.delay}">${t.delay ? t.delay + ' يوم' : '-'}</span></div></div>
                        </div>
                        <div class="card-bottom-info">
                            <div class="employee-badge"><i data-lucide="user-check"></i><span>${t.assignee || 'غير محدد'}</span></div>
                            <div class="importance-badge"><i data-lucide="alert-triangle"></i><span>${t.importance}</span></div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn-card-primary" onclick="viewDetails('${t.id}')"><i data-lucide="eye"></i><span>عرض التفاصيل</span></button>
                        ${t.attachment ? `<button class="btn-card-secondary" onclick="window.open('${t.attachment}')"><i data-lucide="paperclip"></i><span>المرفقات</span></button>` : ''}
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function viewDetails(id) {
            const task = allTasks.find(t => t.id == id);
            if(!task) return;
            
            const html = `
                <div class="detail-row"><span class="detail-label">رقم القيد</span><span class="detail-value">${task.id}</span></div>
                <div class="detail-row"><span class="detail-label">الموضوع</span><span class="detail-value">${task.subject}</span></div>
                <div class="detail-row"><span class="detail-label">الجهة</span><span class="detail-value">${task.source}</span></div>
                <div class="detail-row"><span class="detail-label">محل التنفيذ</span><span class="detail-value">${task.entity}</span></div>
                <div class="detail-row"><span class="detail-label">الموظف المسؤول</span><span class="detail-value">${task.assignee}</span></div>
                <div class="detail-row"><span class="detail-label">الحالة</span><span class="detail-value">${task.status}</span></div>
                <div class="detail-row"><span class="detail-label">ملاحظات</span><span class="detail-value">${task.notes || '-'}</span></div>
            `;
            document.getElementById('modal-details-body').innerHTML = html;
            document.getElementById('details-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('details-modal').classList.remove('active');
        }

        function resetFilters() {
            document.querySelectorAll('select, input').forEach(el => el.value = '');
            setDefaultDateFilter();
            filterByStatus('');
        }
    </script>
</body>
</html>
