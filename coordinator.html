<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>لوحة المنسق | نظام الحوكمة</title>
    
    <link rel="icon" type="image/png" href="assets/icons/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; padding-bottom: 80px; }
        
        /* Scrollbar */
        .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Custom Colors & Shadows */
        .header-bg {
            background: linear-gradient(135deg, #0f766e 0%, #115e59 100%);
            box-shadow: 0 4px 20px rgba(15, 118, 110, 0.2);
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 12px; font-weight: 700; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px; z-index: 9999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease forwards;
            opacity: 0;
        }
        @keyframes slideDown { from { top: -20px; opacity: 0; } to { top: 20px; opacity: 1; } }
        .toast-success { background: #065f46; color: white; border: 1px solid #34d399; }
        .toast-error { background: #991b1b; color: white; border: 1px solid #fca5a5; }

        /* Reassign Styles */
        .assign-select {
            padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 8px;
            font-size: 0.8rem; outline: none; background: white; width: 100%; transition: 0.2s;
        }
        .assign-select:focus { border-color: #0f766e; box-shadow: 0 0 0 2px rgba(15, 118, 110, 0.1); }
        
        .btn-save {
            background: #0f766e; color: white; padding: 6px 12px; border-radius: 8px;
            font-size: 0.75rem; font-weight: 700; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .btn-save:hover { background: #115e59; }
        .btn-save:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Mobile Card Style */
        .task-card {
            background: white; border-radius: 16px; border: 1px solid #e2e8f0;
            padding: 1.25rem; margin-bottom: 1rem; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        
        /* Status Badges */
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.65rem; font-weight: 700; }
        .badge-new { background: #f1f5f9; color: #475569; }
        .badge-pending { background: #fef3c7; color: #b45309; }
        .badge-done { background: #dcfce7; color: #15803d; }
        .badge-late { background: #fee2e2; color: #991b1b; }

        /* Sidebar Desktop */
        @media (min-width: 1024px) {
            body { padding-right: 260px; padding-bottom: 0; }
            .mobile-header { display: none; }
            .bottom-nav { display: none; }
        }
        .sidebar {
            position: fixed; right: 0; top: 0; height: 100vh; width: 260px;
            background: white; border-left: 1px solid #e2e8f0; z-index: 50;
            display: none; flex-direction: column;
        }
        @media (min-width: 1024px) { .sidebar { display: flex; } }
        
        .nav-item {
            display: flex; align-items: center; gap: 10px; padding: 12px 20px;
            color: #64748b; font-weight: 600; text-decoration: none; transition: 0.2s; margin-bottom: 4px;
        }
        .nav-item:hover { background: #f0fdfa; color: #0f766e; }
        .nav-item.active { background: linear-gradient(135deg, #0f766e, #115e59); color: white; border-radius: 8px; }
    </style>
</head>
<body>

    <aside class="sidebar p-4">
        <div class="flex items-center gap-3 px-2 mb-8">
            <div class="w-10 h-10 bg-teal-50 rounded-full flex items-center justify-center">
                <img src="assets/icons/favicon.png" class="w-6 h-6 object-contain">
            </div>
            <div>
                <h1 class="font-bold text-slate-800 text-lg">نظام الحوكمة</h1>
                <p class="text-[10px] text-slate-500">لوحة المنسق</p>
            </div>
        </div>
        <nav class="flex-1">
            <a href="index.html" class="nav-item rounded-lg"><i data-lucide="home" class="w-5 h-5"></i> الرئيسية</a>
            <a href="distribution.html" class="nav-item rounded-lg"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> المؤشرات</a>
            <a href="coordinator.html" class="nav-item active rounded-lg"><i data-lucide="users" class="w-5 h-5"></i> المنسقين</a>
            <a href="forms.html" class="nav-item rounded-lg"><i data-lucide="file-text" class="w-5 h-5"></i> النماذج</a>
        </nav>
        <div class="mt-auto border-t border-slate-100 pt-4">
            <div class="px-2 mb-2">
                <p class="text-xs text-slate-400 font-bold">المستخدم الحالي</p>
                <p class="text-sm font-bold text-slate-800 truncate" id="sidebar-user">...</p>
            </div>
            <button onclick="logout()" class="nav-item w-full text-red-500 hover:bg-red-50 hover:text-red-600 rounded-lg">
                <i data-lucide="log-out" class="w-5 h-5"></i> تسجيل خروج
            </button>
        </div>
    </aside>

    <div class="header-bg lg:hidden p-4 pb-16 text-white rounded-b-[30px] mb-[-30px] relative z-10">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                    <img src="assets/icons/favicon.png" class="w-6 h-6 object-contain">
                </div>
                <div>
                    <p class="text-teal-100 text-xs font-bold">لوحة المنسق</p>
                    <h1 class="font-bold text-lg" id="mobile-user">...</h1>
                </div>
            </div>
            <button onclick="logout()" class="bg-white/20 p-2 rounded-xl hover:bg-red-500/50 transition">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <main class="container mx-auto px-4 lg:py-8 pt-12 pb-24">
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6 relative z-20">
            <div class="bg-white p-4 rounded-xl border border-blue-100 shadow-sm text-center">
                <p class="text-xs text-slate-500 font-bold mb-1">الإجمالي</p>
                <h3 class="text-2xl font-black text-blue-600" id="s-total">0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl border border-yellow-100 shadow-sm text-center">
                <p class="text-xs text-slate-500 font-bold mb-1">قيد التنفيذ</p>
                <h3 class="text-2xl font-black text-yellow-600" id="s-pending">0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl border border-green-100 shadow-sm text-center">
                <p class="text-xs text-slate-500 font-bold mb-1">مكتملة</p>
                <h3 class="text-2xl font-black text-green-600" id="s-completed">0</h3>
            </div>
            <div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm text-center">
                <p class="text-xs text-slate-500 font-bold mb-1">متأخرة</p>
                <h3 class="text-2xl font-black text-red-600" id="s-late">0</h3>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                <i data-lucide="bar-chart" class="w-4 h-4 text-[#0f766e]"></i> أداء الفريق
            </h3>
            <div class="flex gap-3 overflow-x-auto pb-4 hide-scrollbar" id="employee-stats-container">
                <div class="min-w-[200px] h-[100px] bg-slate-100 rounded-xl animate-pulse"></div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700 text-sm">تصفية المهام</h3>
                <button onclick="resetFilters()" class="text-xs text-red-500 font-bold hover:underline">إعادة تعيين</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <input type="text" id="f-search" placeholder="بحث (رقم، جهة، موضوع)..." class="assign-select">
                <select id="f-emp" class="assign-select"><option value="">كل الموظفين</option></select>
                <select id="f-status" class="assign-select">
                    <option value="">كل الحالات</option>
                    <option value="جديد">جديد</option>
                    <option value="قيد التنفيذ">قيد التنفيذ</option>
                    <option value="مكتملة">مكتملة</option>
                    <option value="متأخرة">متأخرة</option>
                </select>
                <button onclick="applyFilters()" class="bg-[#0f766e] text-white rounded-lg py-2 text-sm font-bold hover:bg-[#0d5f57] shadow-md transition">
                    تنفيذ الفلتر
                </button>
            </div>
        </div>

        <div id="content-area">
            <div id="loading" class="text-center py-12">
                <span class="inline-block animate-spin text-[#0f766e]"><i data-lucide="loader-2" class="w-8 h-8"></i></span>
                <p class="text-sm text-slate-400 mt-2">جاري جلب البيانات...</p>
            </div>

            <div id="table-view" class="hidden lg:block bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-sm text-right">
                    <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                        <tr>
                            <th class="p-4">#</th>
                            <th class="p-4">التاريخ</th>
                            <th class="p-4">الجهة</th>
                            <th class="p-4 w-1/3">الموضوع</th>
                            <th class="p-4">الحالة</th>
                            <th class="p-4 w-1/4">إعادة التوزيع</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <div id="cards-view" class="lg:hidden space-y-4"></div>
        </div>

    </main>

    <nav class="bottom-nav lg:hidden fixed bottom-0 w-full bg-white border-t border-slate-200 flex justify-around py-2 z-50">
        <a href="index.html" class="flex flex-col items-center text-[10px] text-slate-400 gap-1 p-2">
            <i data-lucide="home" class="w-5 h-5"></i> الرئيسية
        </a>
        <a href="distribution.html" class="flex flex-col items-center text-[10px] text-slate-400 gap-1 p-2">
            <i data-lucide="bar-chart-2" class="w-5 h-5"></i> المؤشرات
        </a>
        <a href="coordinator.html" class="flex flex-col items-center text-[10px] text-[#0f766e] font-bold gap-1 p-2">
            <i data-lucide="users" class="w-5 h-5"></i> المنسقين
        </a>
        <a href="forms.html" class="flex flex-col items-center text-[10px] text-slate-400 gap-1 p-2">
            <i data-lucide="file-text" class="w-5 h-5"></i> النماذج
        </a>
    </nav>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        // Initialization
        lucide.createIcons();
        let allTasks = [];
        // القائمة الثابتة للموظفين (Backup) + ستتم تعبئتها من البيانات
        const staffList = [
            "ريم محمد", "صبحي أحمد", "نسمة علي", "أسماء حسن",
            "د. مصطفى حمزة", "د. ريهام إبراهيم", "أ. منار جمال", 
            "أ. عمرو رشاد", "أ. محمود نور الدين", "أ. إيمان عبد اللطيف", 
            "أ. علا سيد", "أ. نيفين مكرم"
        ];

        document.addEventListener('DOMContentLoaded', async () => {
            // Check Auth
            const user = auth.checkAuth();
            if (!user) return; // auth.js handles redirect

            // Check Role (Coordinator or Admin)
            if (user.role !== 'منسق' && user.role !== 'Coordinator' && user.role !== 'مدير' && user.role !== 'Admin') {
                alert('عفواً، هذه الصفحة للمنسقين والإدارة فقط');
                window.location.href = 'index.html';
                return;
            }

            // Set User Info
            document.getElementById('mobile-user').textContent = user.name;
            document.getElementById('sidebar-user').textContent = user.name;

            await loadData();
        });

        // Load Data
        async function loadData() {
            try {
                const API_URL = CONFIG.API_URL;
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getAllData' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    allTasks = data.tasks || [];
                    
                    // 1. Populate Employees Dropdown (Merge static list with actual assignees)
                    const distinctAssignees = [...new Set(allTasks.map(t => t.assignee).filter(n => n))];
                    const fullStaff = [...new Set([...staffList, ...distinctAssignees])].sort();
                    
                    const empSelect = document.getElementById('f-emp');
                    empSelect.innerHTML = '<option value="">كل الموظفين</option>';
                    fullStaff.forEach(emp => {
                        empSelect.innerHTML += `<option value="${emp}">${emp}</option>`;
                    });

                    // 2. Render Stats & Content
                    calculateStats(fullStaff);
                    applyFilters();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerHTML = `<p class="text-red-500 font-bold">خطأ في الاتصال: ${error.message}</p>`;
            }
        }

        // Stats Calculation
        function calculateStats(staff) {
            // General Stats
            const total = allTasks.length;
            const pending = allTasks.filter(t => t.status.includes('تنفيذ') || t.status.includes('جديد')).length;
            const completed = allTasks.filter(t => t.status.includes('مكتمل') || t.status.includes('تم')).length;
            const late = allTasks.filter(t => t.status.includes('متأخر')).length;

            document.getElementById('s-total').innerText = total;
            document.getElementById('s-pending').innerText = pending;
            document.getElementById('s-completed').innerText = completed;
            document.getElementById('s-late').innerText = late;

            // Employee Cards
            const container = document.getElementById('employee-stats-container');
            container.innerHTML = '';

            staff.forEach(empName => {
                const empTasks = allTasks.filter(t => t.assignee === empName);
                if (empTasks.length === 0) return; // Skip empty

                const empPending = empTasks.filter(t => t.status.includes('تنفيذ')).length;
                const empDone = empTasks.filter(t => t.status.includes('مكتمل') || t.status.includes('تم')).length;
                const rate = empTasks.length > 0 ? Math.round((empDone / empTasks.length) * 100) : 0;

                container.innerHTML += `
                <div class="min-w-[180px] bg-white border border-slate-200 rounded-xl p-3 shadow-sm flex flex-col gap-2">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-8 h-8 rounded-full bg-teal-50 text-[#0f766e] flex items-center justify-center font-bold text-xs">
                            ${empName.charAt(0)}
                        </div>
                        <p class="text-xs font-bold text-slate-800 truncate w-24">${empName}</p>
                    </div>
                    <div class="flex justify-between text-[10px] text-slate-500">
                        <span>المهام: ${empTasks.length}</span>
                        <span class="text-yellow-600">جاري: ${empPending}</span>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mt-1">
                        <div class="bg-[#0f766e] h-full" style="width: ${rate}%"></div>
                    </div>
                    <p class="text-[9px] text-right text-slate-400">الإنجاز: ${rate}%</p>
                </div>`;
            });
        }

        // Filters & Render
        function applyFilters() {
            const search = document.getElementById('f-search').value.toLowerCase();
            const emp = document.getElementById('f-emp').value;
            const status = document.getElementById('f-status').value;

            const filtered = allTasks.filter(t => {
                const matchSearch = (t.id + t.subject + t.source).toLowerCase().includes(search);
                const matchEmp = emp === "" || t.assignee === emp;
                const matchStatus = status === "" || t.status.includes(status);
                return matchSearch && matchEmp && matchStatus;
            });

            renderContent(filtered);
        }

        function renderContent(tasks) {
            const loading = document.getElementById('loading');
            const tableView = document.getElementById('table-view');
            const cardsView = document.getElementById('cards-view');
            const tbody = document.getElementById('table-body');

            loading.classList.add('hidden');
            
            if (tasks.length === 0) {
                tableView.classList.add('hidden');
                cardsView.innerHTML = `<div class="text-center py-10 text-slate-400">لا توجد مهام مطابقة</div>`;
                return;
            }

            tableView.classList.remove('hidden'); // Shown by CSS media query on desktop
            tbody.innerHTML = '';
            cardsView.innerHTML = '';

            // Generate Dropdown Options for all rows
            const optionsHTML = document.getElementById('f-emp').innerHTML; // Reuse the filter options

            tasks.forEach(t => {
                // Determine Status Badge
                let badgeClass = 'badge-new';
                if (t.status.includes('تنفيذ')) badgeClass = 'badge-pending';
                if (t.status.includes('مكتمل') || t.status.includes('تم')) badgeClass = 'badge-done';
                if (t.status.includes('متأخر')) badgeClass = 'badge-late';

                const statusHTML = `<span class="badge ${badgeClass}">${t.status}</span>`;
                const dateShort = t.date ? t.date.split('T')[0] : '-';

                // --- 1. Desktop Row ---
                tbody.innerHTML += `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4 font-mono text-xs text-slate-500">#${t.id}</td>
                    <td class="p-4 text-slate-600">${dateShort}</td>
                    <td class="p-4 font-bold text-slate-700">${t.source || t.entity}</td>
                    <td class="p-4 text-slate-600 truncate max-w-xs" title="${t.subject}">${t.subject}</td>
                    <td class="p-4">${statusHTML}</td>
                    <td class="p-4">
                        <div class="flex gap-2">
                            <select id="desk-sel-${t.id}" class="assign-select">
                                ${optionsHTML.replace(`value="${t.assignee}"`, `value="${t.assignee}" selected`)}
                            </select>
                            <button onclick="reassign('${t.id}', 'desk-sel-${t.id}')" class="btn-save shadow-sm">
                                <i data-lucide="save" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;

                // --- 2. Mobile Card (Diamond Style) ---
                cardsView.innerHTML += `
                <div class="task-card">
                    <div class="flex justify-between items-start mb-3">
                        ${statusHTML}
                        <span class="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-500">#${t.id}</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-sm mb-2 leading-relaxed">${t.subject}</h3>
                    <div class="flex items-center gap-2 text-xs text-slate-500 mb-4">
                        <i data-lucide="building-2" class="w-3 h-3 text-slate-400"></i>
                        <span>${t.source || t.entity}</span>
                    </div>
                    
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">الموظف المسؤول:</label>
                        <div class="flex gap-2">
                            <select id="mob-sel-${t.id}" class="assign-select">
                                ${optionsHTML.replace(`value="${t.assignee}"`, `value="${t.assignee}" selected`)}
                            </select>
                            <button onclick="reassign('${t.id}', 'mob-sel-${t.id}')" class="btn-save w-10">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            });

            lucide.createIcons();
        }

        // Reassign Action
        async function reassign(taskId, selectId) {
            const select = document.getElementById(selectId);
            const newEmp = select.value;
            const btn = select.nextElementSibling;
            const originalIcon = btn.innerHTML;

            if (!newEmp) return showToast("يرجى اختيار موظف", "error");

            // Loading State
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
            lucide.createIcons();

            try {
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'reassignTask',
                        taskId: taskId,
                        newEmployee: newEmp
                    })
                });
                
                const result = await response.json();

                if (result.success) {
                    showToast(`تم التكليف بنجاح لـ ${newEmp}`, "success");
                    // Update Local Data
                    const taskIndex = allTasks.findIndex(t => t.id == taskId);
                    if (taskIndex > -1) allTasks[taskIndex].assignee = newEmp;
                    // Reset Button
                    btn.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i>`;
                    setTimeout(() => { 
                        btn.innerHTML = originalIcon; 
                        btn.disabled = false; 
                        calculateStats([...new Set(allTasks.map(t => t.assignee))]); // Refresh stats
                    }, 2000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showToast("فشل التحديث: " + error.message, "error");
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        }

        function showToast(msg, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
            toast.innerHTML = type === 'success' ? 
                `<i data-lucide="check-circle" class="w-4 h-4"></i> ${msg}` : 
                `<i data-lucide="alert-circle" class="w-4 h-4"></i> ${msg}`;
            document.body.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 3000);
        }

        function resetFilters() {
            document.getElementById('f-search').value = '';
            document.getElementById('f-emp').value = '';
            document.getElementById('f-status').value = '';
            applyFilters();
        }

        function logout() {
            auth.logout();
        }
    </script>
</body>
</html>
