<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>Ù…ÙƒØªØ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ | Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</title>
    
    <link rel="icon" type="image/png" href="assets/icons/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; padding-bottom: 80px; }
        
        /* Header */
        .header-bg {
            background: linear-gradient(135deg, #0f766e 0%, #115e59 100%);
            padding: 1rem 1.5rem 6rem;
            color: white;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            position: relative; z-index: 10;
            box-shadow: 0 4px 20px rgba(15, 118, 110, 0.2);
        }

        /* Stats Scroll Container (Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ 6 ÙƒØ±ÙˆØª ØªØ¸Ù‡Ø± ÙƒÙˆÙŠØ³) */
        .stats-container {
            display: flex; gap: 10px; overflow-x: auto; 
            padding: 5px 15px 20px; margin: -5rem 0 1rem;
            position: relative; z-index: 20;
            -webkit-overflow-scrolling: touch;
        }
        .stats-container::-webkit-scrollbar { height: 4px; }
        .stats-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .stat-box {
            min-width: 140px; background: white; padding: 12px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center;
            border: 1px solid #e2e8f0; flex-shrink: 0;
        }
        .stat-num { font-size: 1.5rem; font-weight: 800; color: #1e293b; display: block; line-height: 1; margin-bottom: 4px; }
        .stat-label { font-size: 0.7rem; font-weight: 700; color: #64748b; white-space: nowrap; }
        .stat-icon { width: 30px; height: 30px; border-radius: 8px; margin: 0 auto 6px; display: flex; align-items: center; justify-content: center; }

        /* Colors for Statuses */
        .c-total { color: #0f766e; background: #f0fdfa; }
        .c-new { color: #64748b; background: #f1f5f9; } /* Ø¬Ø¯ÙŠØ¯ */
        .c-pending { color: #0284c7; background: #e0f2fe; } /* Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ */
        .c-approved { color: #16a34a; background: #dcfce7; } /* ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ */
        .c-followup { color: #ea580c; background: #ffedd5; } /* Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© */
        .c-late { color: #dc2626; background: #fee2e2; } /* Ù…ØªØ£Ø®Ø± */

        /* Filters */
        .filters-box {
            background: white; border-radius: 20px; padding: 1.5rem;
            margin: 0 1rem 1.5rem; position: relative; z-index: 15;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03); border: 1px solid #e2e8f0;
        }
        .inp {
            width: 100%; padding: 9px 12px; border: 1px solid #e2e8f0; border-radius: 10px;
            font-size: 0.8rem; outline: none; background-color: #f8fafc; transition: 0.2s;
        }
        .inp:focus { border-color: #0f766e; background: white; }
        .lbl { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 4px; display: block; }

        /* Task Card */
        .task-card {
            background: white; border-radius: 16px; border: 1px solid #e2e8f0;
            padding: 1.25rem; margin-bottom: 1rem; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s;
        }
        .task-card:hover { transform: translateY(-3px); border-color: #0f766e; }

        /* Status Badges */
        .badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 6px; font-weight: 700; }
        .bg-st-new { background: #f1f5f9; color: #334155; border: 1px solid #e2e8f0; }
        .bg-st-pending { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }
        .bg-st-approved { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .bg-st-followup { background: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }
        .bg-st-late { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        /* Assignment Footer */
        .assign-box {
            background: #f8fafc; border-radius: 12px; padding: 10px; margin-top: 12px; border: 1px solid #f1f5f9;
        }
        .btn-save {
            width: 100%; background: #0f766e; color: white; padding: 8px;
            border-radius: 8px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.8rem; margin-top: 8px;
        }
        .btn-save:hover { background: #115e59; }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; padding: 10px; z-index: 50; display: flex; justify-content: space-around; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #94a3b8; gap: 4px; text-decoration: none; }
        .nav-item.active { color: #0f766e; font-weight: bold; }

        @media (min-width: 1024px) {
            .main-content { margin-right: 260px; padding: 20px; }
            .mobile-header, .bottom-nav { display: none; }
            .header-bg { display: none; }
            .stats-container { margin: 0 0 20px; overflow: unset; flex-wrap: wrap; justify-content: center; }
            .stat-box { min-width: 180px; }
            .sidebar { position: fixed; right: 0; top: 0; height: 100vh; width: 260px; background: white; border-left: 1px solid #e2e8f0; padding: 1.5rem; display: flex; flex-direction: column; }
            #tasks-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        }
    </style>
</head>
<body>

    <aside class="sidebar hidden lg:flex">
        <div class="flex items-center gap-3 mb-8 px-2">
            <img src="assets/icons/favicon.png" class="w-10 h-10">
            <div><h1 class="font-bold text-slate-800">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</h1><p class="text-xs text-slate-500">Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚</p></div>
        </div>
        <nav class="flex-1 space-y-2">
            <a href="index.html" class="flex items-center gap-3 p-3 text-slate-500 hover:bg-teal-50 hover:text-teal-700 rounded-lg font-bold"><i data-lucide="home" class="w-5 h-5"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="distribution.html" class="flex items-center gap-3 p-3 text-slate-500 hover:bg-teal-50 hover:text-teal-700 rounded-lg font-bold"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</a>
            <a href="coordinator.html" class="flex items-center gap-3 p-3 bg-teal-600 text-white rounded-lg font-bold shadow-md"><i data-lucide="users" class="w-5 h-5"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù…</a>
            <a href="forms.html" class="flex items-center gap-3 p-3 text-slate-500 hover:bg-teal-50 hover:text-teal-700 rounded-lg font-bold"><i data-lucide="file-text" class="w-5 h-5"></i> Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</a>
        </nav>
        <button onclick="auth.logout()" class="text-red-500 font-bold flex items-center gap-2 mt-auto p-2"><i data-lucide="log-out" class="w-5 h-5"></i> Ø®Ø±ÙˆØ¬</button>
    </aside>

    <div class="main-content">
        <div class="header-bg lg:hidden">
            <div class="flex justify-between items-center mb-1">
                <div class="flex items-center gap-3">
                    <div class="logo-circle-small"><img src="assets/icons/favicon.png" class="w-8 h-8 object-contain"></div>
                    <div>
                        <p class="text-teal-100 text-[11px] font-bold opacity-90">Ù…ÙƒØªØ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚</p>
                        <h1 class="font-bold text-xl text-white" id="user-name">...</h1>
                    </div>
                </div>
                <button onclick="auth.logout()" class="bg-white/20 p-2 rounded-xl text-white"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-box border-b-4 border-teal-600">
                <div class="stat-icon c-total"><i data-lucide="layers"></i></div>
                <span class="stat-num" id="count-total">0</span>
                <span class="stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            </div>
            <div class="stat-box border-b-4 border-slate-400">
                <div class="stat-icon c-new"><i data-lucide="plus-circle"></i></div>
                <span class="stat-num" id="count-new">0</span>
                <span class="stat-label">Ø¬Ø¯ÙŠØ¯</span>
            </div>
            <div class="stat-box border-b-4 border-sky-500">
                <div class="stat-icon c-pending"><i data-lucide="clock"></i></div>
                <span class="stat-num" id="count-pending">0</span>
                <span class="stat-label">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</span>
            </div>
            <div class="stat-box border-b-4 border-green-600">
                <div class="stat-icon c-approved"><i data-lucide="check-circle-2"></i></div>
                <span class="stat-num" id="count-approved">0</span>
                <span class="stat-label">ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©</span>
            </div>
            <div class="stat-box border-b-4 border-orange-500">
                <div class="stat-icon c-followup"><i data-lucide="eye"></i></div>
                <span class="stat-num" id="count-followup">0</span>
                <span class="stat-label">Ø¨Ø­Ø§Ø¬Ø© Ø§Ù„ÙŠ Ù…ØªØ§Ø¨Ø¹Ø©</span>
            </div>
            <div class="stat-box border-b-4 border-red-600">
                <div class="stat-icon c-late"><i data-lucide="alert-octagon"></i></div>
                <span class="stat-num" id="count-late">0</span>
                <span class="stat-label">Ù…ØªØ£Ø®Ø±</span>
            </div>
        </div>

        <div class="filters-box">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700 flex items-center gap-2 text-sm"><i data-lucide="filter" class="w-4 h-4 text-[#0f766e]"></i> ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <button onclick="resetFilters()" class="text-xs text-red-500 font-bold">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3">
                <div>
                    <label class="lbl">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select id="f-status" class="inp">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
                        <option value="Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</option>
                        <option value="ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©">ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©</option>
                        <option value="Ø¨Ø­Ø§Ø¬Ø© Ø§Ù„ÙŠ Ù…ØªØ§Ø¨Ø¹Ø©">Ø¨Ø­Ø§Ø¬Ø© Ø§Ù„ÙŠ Ù…ØªØ§Ø¨Ø¹Ø©</option>
                        <option value="Ù…ØªØ£Ø®Ø±">Ù…ØªØ£Ø®Ø±</option>
                    </select>
                </div>
                <div>
                    <label class="lbl">Ø§Ù„Ù…ÙˆØ¸Ù</label>
                    <select id="f-emp" class="inp">
                        <option value="">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                </div>
                <div>
                    <label class="lbl">Ø¨Ø­Ø«</label>
                    <input type="text" id="f-search" class="inp" placeholder="Ø§Ù„Ø¬Ù‡Ø© / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹...">
                </div>
                <div>
                    <label class="lbl">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="f-start" class="inp">
                </div>
                <div>
                    <label class="lbl">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="f-end" class="inp">
                </div>
            </div>
            
            <button onclick="applyFilters()" class="w-full mt-4 bg-[#0f766e] text-white py-2 rounded-xl font-bold text-sm shadow hover:bg-[#0d5f57]">Ø¨Ø­Ø« ÙˆØªÙ†ÙÙŠØ°</button>
        </div>

        <div class="px-2 lg:px-0">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙƒÙ„ÙŠÙØ§Øª <span class="text-xs bg-[#0f766e] text-white px-2 py-0.5 rounded-full" id="task-count">0</span>
            </h3>
            <div id="tasks-container">
                <div class="text-center py-12"><span class="inline-block animate-spin text-[#0f766e]"><i data-lucide="loader-2" class="w-8 h-8"></i></span><p class="text-slate-400 text-sm mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><i data-lucide="home" class="w-6 h-6"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
        <a href="distribution.html" class="nav-item"><i data-lucide="bar-chart-2" class="w-6 h-6"></i><span>Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</span></a>
        <a href="coordinator.html" class="nav-item active"><i data-lucide="users" class="w-6 h-6"></i><span>ØªÙˆØ²ÙŠØ¹</span></a>
        <a href="forms.html" class="nav-item"><i data-lucide="file-text" class="w-6 h-6"></i><span>Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</span></a>
    </nav>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        lucide.createIcons();
        let allTasks = [], activeEmployees = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const user = auth.checkAuth();
            if (!user) return;
            document.getElementById('user-name').textContent = user.name.split(' ')[0];

            // 1. Fetch Employees (Active Only)
            await loadEmployees();
            
            // 2. Fetch All Tasks (Using 'Admin' role trick)
            await loadTasks(user.name);
        });

        async function loadEmployees() {
            try {
                const API_URL = (typeof CONFIG !== 'undefined') ? CONFIG.API_URL : '';
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getEmployees' }) });
                const data = await res.json();
                
                if (data.success && data.data) {
                    activeEmployees = data.data; // Array of names
                    populateEmpDropdowns();
                }
            } catch (e) { console.error("Error fetching employees", e); }
        }

        function populateEmpDropdowns() {
            const filterSelect = document.getElementById('f-emp');
            filterSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
            activeEmployees.forEach(emp => {
                filterSelect.innerHTML += `<option value="${emp}">${emp}</option>`;
            });
        }

        async function loadTasks(username) {
            try {
                const API_URL = (typeof CONFIG !== 'undefined') ? CONFIG.API_URL : '';
                // ğŸ”¥ Sending role: 'Ù…Ø¯ÙŠØ±' to get ALL data
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllData', role: 'Ù…Ø¯ÙŠØ±', name: username }) });
                const data = await res.json();

                if (data.success) {
                    allTasks = data.tasks || [];
                    calculateStats();
                    applyFilters();
                } else {
                    document.getElementById('tasks-container').innerHTML = `<div class="text-center py-10 text-red-500 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>`;
                }
            } catch (e) {
                console.error(e);
                document.getElementById('tasks-container').innerHTML = `<div class="text-center py-10 text-red-500 font-bold">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>`;
            }
        }

        function calculateStats() {
            // Initialize counts
            let counts = { total: 0, new: 0, pending: 0, approved: 0, followup: 0, late: 0 };
            
            allTasks.forEach(t => {
                counts.total++;
                const s = t.status || '';
                
                if (s === 'Ø¬Ø¯ÙŠØ¯') counts.new++;
                else if (s === 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯') counts.pending++;
                else if (s === 'ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©') counts.approved++;
                else if (s === 'Ø¨Ø­Ø§Ø¬Ø© Ø§Ù„ÙŠ Ù…ØªØ§Ø¨Ø¹Ø©') counts.followup++;
                else if (s === 'Ù…ØªØ£Ø®Ø±') counts.late++;
            });

            // Update UI
            document.getElementById('count-total').textContent = counts.total;
            document.getElementById('count-new').textContent = counts.new;
            document.getElementById('count-pending').textContent = counts.pending;
            document.getElementById('count-approved').textContent = counts.approved;
            document.getElementById('count-followup').textContent = counts.followup;
            document.getElementById('count-late').textContent = counts.late;
        }

        function applyFilters() {
            const status = document.getElementById('f-status').value;
            const emp = document.getElementById('f-emp').value;
            const search = document.getElementById('f-search').value.toLowerCase();
            const start = document.getElementById('f-start').value;
            const end = document.getElementById('f-end').value;

            const filtered = allTasks.filter(t => {
                // Status Filter
                if (status && t.status !== status) return false;
                // Employee Filter
                if (emp && t.assignee !== emp) return false;
                // Search Filter
                if (search && !(t.source + t.subject + t.id).toLowerCase().includes(search)) return false;
                // Date Range Filter (Assuming date format DD/MM/YYYY)
                if (start || end) {
                    const taskDateParts = t.date.split('/'); // Convert DD/MM/YYYY to YYYY-MM-DD
                    const taskDateISO = `${taskDateParts[2]}-${taskDateParts[1]}-${taskDateParts[0]}`;
                    if (start && taskDateISO < start) return false;
                    if (end && taskDateISO > end) return false;
                }
                return true;
            });

            renderTasks(filtered);
        }

        function renderTasks(tasks) {
            const container = document.getElementById('tasks-container');
            document.getElementById('task-count').textContent = tasks.length;

            if (tasks.length === 0) {
                container.innerHTML = `<div class="text-center py-12 text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>`;
                return;
            }

            // Prepare Employee Options HTML once
            let empOptions = '<option value="">-- Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù --</option>';
            activeEmployees.forEach(e => empOptions += `<option value="${e}">${e}</option>`);

            container.innerHTML = tasks.map(t => {
                // Badge Logic
                let badgeClass = 'bg-st-new';
                if (t.status === 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯') badgeClass = 'bg-st-pending';
                else if (t.status === 'ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©') badgeClass = 'bg-st-approved';
                else if (t.status === 'Ø¨Ø­Ø§Ø¬Ø© Ø§Ù„ÙŠ Ù…ØªØ§Ø¨Ø¹Ø©') badgeClass = 'bg-st-followup';
                else if (t.status === 'Ù…ØªØ£Ø®Ø±') badgeClass = 'bg-st-late';

                const assignOpts = empOptions.replace(`value="${t.assignee}"`, `value="${t.assignee}" selected`);
                const hasAttachment = t.attachment && t.attachment.length > 5;

                return `
                <div class="task-card group">
                    <div class="flex justify-between items-start mb-3">
                        <span class="badge ${badgeClass}">${t.status}</span>
                        <span class="text-[10px] font-mono text-slate-400">#${t.id}</span>
                    </div>
                    <h3 class="font-bold text-slate-800 text-sm mb-2 leading-relaxed">${t.subject}</h3>
                    <div class="flex items-center gap-2 text-xs text-slate-500 mb-3">
                        <i data-lucide="building-2" class="w-3 h-3 text-slate-400"></i> ${t.source}
                    </div>
                    
                    ${hasAttachment ? `<div class="mb-3"><a href="${t.attachment}" target="_blank" class="block w-full text-center bg-white border border-slate-200 text-slate-600 py-1.5 rounded-lg text-xs font-bold hover:bg-slate-50">ğŸ“ ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚</a></div>` : ''}

                    <div class="assign-box">
                        <label class="lbl">ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰:</label>
                        <select id="sel-${t.id}" class="inp py-1 mb-2">${assignOpts}</select>
                        <button onclick="reassignTask('${t.id}')" class="btn-save">
                            <i data-lucide="check" class="w-3 h-3"></i> Ø­ÙØ¸ Ø§Ù„ØªÙˆØ²ÙŠØ¹
                        </button>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        async function reassignTask(id) {
            const select = document.getElementById(`sel-${id}`);
            const newEmp = select.value;
            const btn = select.nextElementSibling;
            
            if(!newEmp) return alert("Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹");

            const originalHtml = btn.innerHTML;
            btn.innerHTML = 'âŒ› Ø¬Ø§Ø±ÙŠ...';
            btn.disabled = true;

            try {
                const API_URL = (typeof CONFIG !== 'undefined') ? CONFIG.API_URL : '';
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'reassignTask', taskId: id, newEmployee: newEmp })
                });
                const data = await res.json();
                
                if(data.success) {
                    btn.innerHTML = 'âœ… ØªÙ…';
                    btn.style.background = '#15803d';
                    setTimeout(() => { 
                        btn.innerHTML = originalHtml; 
                        btn.style.background = ''; 
                        btn.disabled = false;
                        // Update local data
                        const task = allTasks.find(t => t.id == id);
                        if(task) task.assignee = newEmp;
                    }, 2000);
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                alert("Ø®Ø·Ø£: " + e.message);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        function resetFilters() {
            document.getElementById('f-status').value = '';
            document.getElementById('f-emp').value = '';
            document.getElementById('f-search').value = '';
            document.getElementById('f-start').value = '';
            document.getElementById('f-end').value = '';
            applyFilters();
        }
    </script>
</body>
</html>
