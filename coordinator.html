<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ù…Ù†Ø³Ù‚ - IAG</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>

  <aside class="sidebar">
    <div class="sidebar-logo">
      <h2 class="text-xl font-bold mb-2">IAG System</h2>
      <p id="user-name" class="text-sm opacity-90">Ù…Ø±Ø­Ø¨Ø§Ù‹</p>
    </div>
    
    <nav style="padding: 16px 0;">
      <a href="index.html" class="sidebar-item">
        <i data-lucide="home" style="width: 20px; height: 20px;"></i>
        <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
      </a>
      <a href="distribution.html" class="sidebar-item">
        <i data-lucide="pie-chart" style="width: 20px; height: 20px;"></i>
        <span>Dashboard</span>
      </a>
      <a href="forms.html" class="sidebar-item">
        <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
        <span>Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</span>
      </a>
      <a href="coordinator.html" class="sidebar-item active" id="coordinator-link" style="display: none;">
        <i data-lucide="users" style="width: 20px; height: 20px;"></i>
        <span>Ø§Ù„Ù…Ù†Ø³Ù‚ÙŠÙ†</span>
      </a>
      <a href="admin.html" class="sidebar-item admin" id="admin-link" style="display: none;">
        <i data-lucide="settings" style="width: 20px; height: 20px;"></i>
        <span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
      </a>
    </nav>
  </aside>

  <main class="main-content">
    
    <div class="card header-card">
      <h1 style="font-size: 1.75rem; font-weight: 800;">ØµÙØ­Ø© Ø§Ù„Ù…Ù†Ø³Ù‚</h1>
      <p style="opacity: 0.9; margin-top: 4px;">ØªÙˆØ²ÙŠØ¹ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</p>
    </div>

    <div class="card">
      <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 16px;">Ø§Ù„ÙÙ„Ø§ØªØ±</h2>
      
      <div class="filter-grid">
        <div>
          <label class="filter-label">Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <select id="emp-filter">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
            <option value="ALL_FINANCIAL">ğŸ”¹ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</option>
            <option value="ALL_TECHNICAL">ğŸ”§ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</option>
          </select>
        </div>

        <div>
          <label class="filter-label">Ø§Ù„ÙØªØ±Ø©</label>
          <select id="period-filter">
            <option value="week">Ø¢Ø®Ø± Ø£Ø³Ø¨ÙˆØ¹</option>
            <option value="month">Ø¢Ø®Ø± Ø´Ù‡Ø±</option>
            <option value="3months">Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±</option>
            <option value="year">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª</option>
          </select>
        </div>
      </div>

      <button onclick="loadData()">
        <i data-lucide="search" style="width: 18px; height: 18px; display: inline; vertical-align: middle; margin-left: 6px;"></i>
        ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
      </button>
    </div>

    <div id="results" style="color: #94a3b8; text-align: center; padding: 40px;">
      <div style="font-size: 2rem; margin-bottom: 12px;">â³</div>
      <p style="font-weight: 600;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

  </main>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/auth.js"></script>
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”’ SECURITY CHECK - Coordinators & Admins Only
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const user = auth.checkSession();
    if (!user) {
      alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      window.location.href = 'index.html';
    }

    const allowedRoles = ['Ù…Ù†Ø³Ù‚', 'Ù…Ø¯ÙŠØ±', 'Admin', 'Coordinator'];
    if (!allowedRoles.includes(user.role)) {
      alert('â›” Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ù†Ø³Ù‚ÙŠÙ† ÙˆØ§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙÙ‚Ø·!\n\nØ³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');
      window.location.href = 'index.html';
    }

    lucide.createIcons();

    // Show/Hide Sidebar Links Based on Role
    if (user.role === 'Ù…Ù†Ø³Ù‚' || user.role === 'Coordinator') {
      document.getElementById('coordinator-link').style.display = 'flex';
    } else if (user.role === 'Ù…Ø¯ÙŠØ±' || user.role === 'Admin') {
      document.getElementById('coordinator-link').style.display = 'flex';
      document.getElementById('admin-link').style.display = 'flex';
    }

    document.getElementById('user-name').textContent = `${user.name} ğŸ‘‹`;

    let allEmployees = [];
    let allTasks = [];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Get Date Range
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getDateRange() {
      const today = new Date();
      const period = document.getElementById('period-filter').value;
      let start = new Date(today);
      
      switch(period) {
        case 'week': start.setDate(today.getDate() - 7); break;
        case 'month': start.setMonth(today.getMonth() - 1); break;
        case '3months': start.setMonth(today.getMonth() - 3); break;
        case 'year': start = new Date(today.getFullYear(), 0, 1); break;
        case 'all': start = new Date('2020-01-01'); break;
      }
      
      return {
        start: start.toISOString().split('T')[0],
        end: today.toISOString().split('T')[0]
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Load Data
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadData() {
      document.getElementById('results').innerHTML = '<div style="color: #94a3b8; text-align: center; padding: 60px;"><div style="font-size: 2rem; margin-bottom: 12px;">â³</div><p style="font-weight: 600;">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';

      try {
        const range = getDateRange();
        
        const result = await auth.apiCall('getAllData', {
          role: user.role || 'Ù…Ø¯ÙŠØ±',
          name: user.name,
          startDate: range.start,
          endDate: range.end
        });

        if (!result || !result.success) {
          throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }

        allTasks = result.tasks || [];
        allEmployees = result.stats.employees || [];

        // Populate employee dropdown
        const empFilter = document.getElementById('emp-filter');
        let options = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
        options += '<option value="ALL_FINANCIAL">ğŸ”¹ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</option>';
        options += '<option value="ALL_TECHNICAL">ğŸ”§ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</option>';
        options += '<optgroup label="Ø£ÙØ±Ø§Ø¯">';
        
        allEmployees.forEach(e => {
          options += `<option value="${e.name}">${e.name}</option>`;
        });
        
        options += '</optgroup>';
        empFilter.innerHTML = options;

        filterAndDisplay();

      } catch (err) {
        document.getElementById('results').innerHTML = `
          <div style="text-align: center; padding: 60px; color: #dc2626;">
            <div style="font-size: 3rem; margin-bottom: 12px;">âŒ</div>
            <h3 style="font-weight: 700; margin-bottom: 8px;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h3>
            <p style="color: #64748b;">${err.message}</p>
            <button onclick="loadData()" style="width: auto; margin: 16px auto 0; padding: 10px 24px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Filter and Display
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function filterAndDisplay() {
      const empFilter = document.getElementById('emp-filter').value;
      let filtered = allTasks;

      if (empFilter === 'ALL_FINANCIAL') {
        const names = allEmployees
          .filter(e => e.role && (e.role.includes('Ù…Ø§Ù„ÙŠ') || e.role.includes('Ø¥Ø¯Ø§Ø±ÙŠ') || e.role.includes('Ù…Ø±Ø§Ø¬Ø¹')))
          .map(e => e.name);
        filtered = allTasks.filter(t => names.some(n => t.assignee && t.assignee.includes(n)));
      } else if (empFilter === 'ALL_TECHNICAL') {
        const names = allEmployees
          .filter(e => e.role && (e.role.includes('ÙÙ†ÙŠ') || e.role.includes('ØªÙØªÙŠØ´')))
          .map(e => e.name);
        filtered = allTasks.filter(t => names.some(n => t.assignee && t.assignee.includes(n)));
      } else if (empFilter) {
        filtered = allTasks.filter(t => t.assignee && t.assignee.includes(empFilter));
      }

      displayTasks(filtered);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Display Tasks
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function displayTasks(tasks) {
      const container = document.getElementById('results');

      if (!tasks || tasks.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px; color: #94a3b8;">
            <div style="font-size: 3rem; margin-bottom: 12px;">ğŸ“­</div>
            <p style="font-size: 1.1rem; font-weight: 600;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</p>
          </div>
        `;
        return;
      }

      // Group by employee
      const grouped = {};
      tasks.forEach(t => {
        const emp = t.assignee || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        if (!grouped[emp]) grouped[emp] = [];
        grouped[emp].push(t);
      });

      let html = '';

      Object.entries(grouped).forEach(([emp, empTasks]) => {
        const done = empTasks.filter(t => {
          const s = t.status || '';
          return s.includes('ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯') || s.includes('Ù…Ù†ØªÙ‡ÙŠ') || s.includes('Ø£Ø±Ø´ÙŠÙ');
        }).length;
        const pending = empTasks.length - done;

        html += `
          <div class="employee-group">
            <div class="employee-header">
              <div>
                <div style="font-size: 1.25rem; font-weight: 800;">${emp}</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${empTasks.length} Ù…Ù‡Ù…Ø©</div>
              </div>
              <div style="display: flex; gap: 20px;">
                <div style="text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 800;">${done}</div>
                  <div style="font-size: 0.75rem; opacity: 0.9;">Ù…Ù†ØªÙ‡ÙŠ</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 800;">${pending}</div>
                  <div style="font-size: 0.75rem; opacity: 0.9;">Ø¬Ø§Ø±ÙŠ</div>
                </div>
              </div>
            </div>

            <div class="task-grid">
            ${empTasks.map(t => {
              const isDone = (t.status || '').includes('ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯') || (t.status || '').includes('Ù…Ù†ØªÙ‡ÙŠ') || (t.status || '').includes('Ø£Ø±Ø´ÙŠÙ');
              
              return `
                <div class="task-card ${isDone ? 'task-done' : 'task-pending'}">
                  <div class="task-header">
                    <div class="task-id">${t.id}</div>
                    <span class="badge ${isDone ? 'badge-done' : 'badge-pending'}">
                      ${isDone ? 'âœ… Ù…Ù†ØªÙ‡ÙŠ' : 'â³ Ø¬Ø§Ø±ÙŠ'}
                    </span>
                  </div>
                  
                  <div class="task-subject">${t.subject}</div>
                  
                  <div class="task-meta">
                    <div><strong>ğŸ“¥ Ù…Ù†:</strong> ${t.source || t.entity}</div>
                    <div><strong>ğŸ“ Ø§Ù„ØªÙ†ÙÙŠØ°:</strong> ${t.executionLocation || t.entity}</div>
                    <div><strong>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${t.date}</div>
                    ${t.attachment ? `<div><a href="${t.attachment}" target="_blank" style="color: #0f766e; text-decoration: underline; font-weight: 700;">ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚</a></div>` : ''}
                    ${t.report ? `<div><a href="${t.report}" target="_blank" style="color: #dc2626; text-decoration: underline; font-weight: 700;">ğŸ“„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</a></div>` : ''}
                  </div>
                </div>
              `;
            }).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
      lucide.createIcons();
    }

    // Initial Load
    loadData();
  </script>
</body>
</html>
