<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>Ù…ÙƒØªØ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ | Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</title>
    <link rel="icon" href="assets/icons/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root { --primary: #047857; --bg-main: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-main); padding-bottom: 80px; }
        /* ÙƒØ§Ø±Øª */
        .super-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
        .status-strip { width: 5px; height: 100%; position: absolute; right: 0; top: 0; }
        .st-late { border-right: 5px solid #ef4444; } .st-done { border-right: 5px solid #10b981; } .st-pending { border-right: 5px solid #f59e0b; }
        /* Sidebar */
        @media (min-width: 1024px) { body { padding-right: 260px; } .sidebar { width: 260px; transform: translateX(0) !important; } .mobile-header, .bottom-nav { display: none !important; } }
    </style>
</head>
<body>
    <aside class="sidebar fixed top-0 right-0 h-full bg-white shadow-lg border-l border-gray-100 transition-transform duration-300 translate-x-full z-50 flex flex-col">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 bg-teal-50 rounded-lg flex items-center justify-center text-[#047857]"><i data-lucide="shield-check"></i></div>
            <div><h1 class="font-bold text-lg">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</h1><p class="text-xs text-gray-500">Ù…ÙƒØªØ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚</p></div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="distribution.html" class="flex gap-3 px-4 py-3 text-gray-600 hover:bg-teal-50 rounded-xl font-medium"><i data-lucide="layout-grid"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="coordinator.html" class="flex gap-3 px-4 py-3 bg-[#047857] text-white rounded-xl font-bold shadow-md"><i data-lucide="users"></i> Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØªÙƒÙ„ÙŠÙ</a>
            <a href="forms.html" class="flex gap-3 px-4 py-3 text-gray-600 hover:bg-teal-50 rounded-xl font-medium"><i data-lucide="file-text"></i> Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</a>
        </nav>
        <div class="p-4 border-t"><button onclick="auth.logout()" class="flex items-center gap-2 text-red-500 text-sm font-bold"><i data-lucide="log-out" class="w-4"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button></div>
    </aside>

    <main class="w-full min-h-screen">
        <div class="mobile-header bg-white p-4 sticky top-0 z-30 shadow-sm flex justify-between items-center lg:hidden">
            <h1 class="font-bold text-[#047857]">Ù…ÙƒØªØ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚</h1>
            <button onclick="location.reload()"><i data-lucide="refresh-cw" class="w-5 text-gray-500"></i></button>
        </div>

        <div class="p-4 lg:p-8 max-w-7xl mx-auto space-y-6">
            <div class="bg-white p-4 rounded-xl border shadow-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <select id="filter-emp" class="w-full p-2 border rounded-lg text-sm"><option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option></select>
                <select id="filter-source" class="w-full p-2 border rounded-lg text-sm"><option value="all">ÙƒÙ„ Ø§Ù„Ø¬Ù‡Ø§Øª</option></select>
                <select id="filter-status" class="w-full p-2 border rounded-lg text-sm">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="late">âš ï¸ Ù…ØªØ£Ø®Ø±</option>
                    <option value="pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„</option>
                    <option value="done">âœ… Ù…Ù†ØªÙ‡ÙŠ</option>
                </select>
                <button onclick="applyFilters()" class="bg-[#047857] text-white py-2 rounded-lg font-bold shadow hover:bg-[#065f46]">Ø¨Ø­Ø«</button>
            </div>

            <div id="tasks-container" class="space-y-4">
                <div class="text-center py-10 text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            </div>
        </div>
    </main>

    <nav class="bottom-nav fixed bottom-0 w-full bg-white border-t flex justify-around p-2 z-40 lg:hidden shadow-lg">
        <a href="distribution.html" class="text-gray-400 flex flex-col items-center text-[10px]"><i data-lucide="layout-grid" class="w-6"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="coordinator.html" class="text-[#047857] flex flex-col items-center text-[10px] font-bold"><i data-lucide="users" class="w-6"></i>Ø§Ù„ØªÙ†Ø³ÙŠÙ‚</a>
        <a href="forms.html" class="text-gray-400 flex flex-col items-center text-[10px]"><i data-lucide="file-text" class="w-6"></i>Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</a>
    </nav>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        lucide.createIcons();
        let allTasks = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const user = auth.checkAuth();
            if(!user || user.role === 'employee') return; // Ø­Ù…Ø§ÙŠØ©

            // Turbo Load: ØªØ­Ù…ÙŠÙ„ Ù…Ù† 2024 ÙÙ‚Ø·
            const startDate = `${new Date().getFullYear()}-01-01`;
            
            try {
                const res = await auth.callAPI('getAllData', { role: 'coordinator', name: user.name, startDate });
                if(res.success) {
                    allTasks = res.tasks;
                    populateFilters(allTasks);
                    renderCards(allTasks);
                }
            } catch(e) { console.error(e); }
        });

        function populateFilters(tasks) {
            const emps = new Set(), srcs = new Set();
            tasks.forEach(t => { if(t.assignee) emps.add(t.assignee); if(t.source) srcs.add(t.source); });
            
            document.getElementById('filter-emp').innerHTML += Array.from(emps).map(e => `<option>${e}</option>`).join('');
            document.getElementById('filter-source').innerHTML += Array.from(srcs).map(s => `<option>${s}</option>`).join('');
        }

        function applyFilters() {
            const emp = document.getElementById('filter-emp').value;
            const src = document.getElementById('filter-source').value;
            const sts = document.getElementById('filter-status').value;

            const filtered = allTasks.filter(t => {
                const s = (t.status||'').toLowerCase();
                return (emp === 'all' || t.assignee === emp) &&
                       (src === 'all' || t.source === src) &&
                       (sts === 'all' || (sts==='late' && s.includes('Ù…ØªØ£Ø®Ø±')) || (sts==='done' && s.includes('ØªÙ…')) || (sts==='pending' && !s.includes('ØªÙ…') && !s.includes('Ù…ØªØ£Ø®Ø±')));
            });
            renderCards(filtered);
        }

        function renderCards(tasks) {
            const container = document.getElementById('tasks-container');
            if(!tasks.length) return container.innerHTML = '<div class="text-center py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';

            container.innerHTML = tasks.map(t => {
                const isLate = t.status.includes('Ù…ØªØ£Ø®Ø±');
                const isDone = t.status.includes('ØªÙ…');
                const stripClass = isLate ? 'st-late' : (isDone ? 'st-done' : 'st-pending');
                const statusText = isLate ? 'ğŸ”¥ Ù…ØªØ£Ø®Ø±' : (isDone ? 'âœ… Ù…Ù†ØªÙ‡ÙŠ' : 'â³ Ø¬Ø§Ø±ÙŠ');
                const isLegal = t.caseNumber;

                return `
                <div class="super-card">
                    <div class="status-strip ${stripClass}"></div>
                    <div class="p-3 border-b flex justify-between bg-gray-50">
                        <div class="flex items-center gap-2">
                            <span class="bg-white border px-2 py-0.5 rounded text-[10px] font-bold text-gray-600">${t.docType}</span>
                            <span class="font-mono text-sm font-bold">#${t.id}</span>
                        </div>
                        <span class="text-[10px] font-bold px-2 py-1 rounded bg-white border">${statusText}</span>
                    </div>
                    <div class="p-4">
                        <h3 class="text-sm font-bold text-gray-800 mb-2">${t.subject}</h3>
                        ${isLegal ? `<div class="bg-orange-50 border border-orange-100 p-2 rounded mb-2 text-xs text-orange-800 font-bold">âš–ï¸ Ù‚Ø¶ÙŠØ©: ${t.caseNumber} Ù„Ø³Ù†Ø© ${t.caseYear}</div>` : ''}
                        <div class="flex gap-2 text-xs text-gray-500">
                            <span>ğŸ“¥ ${t.source}</span> | <span>ğŸ‘¤ ${t.assignee}</span>
                        </div>
                    </div>
                    ${t.attachment || t.report ? `<div class="p-3 border-t bg-gray-50 flex gap-2">
                        ${t.attachment ? `<a href="${t.attachment}" target="_blank" class="text-xs text-green-700 font-bold bg-white border px-2 py-1 rounded">ğŸ“ Ø§Ù„ØªÙƒÙ„ÙŠÙ</a>` : ''}
                        ${t.report ? `<a href="${t.report}" target="_blank" class="text-xs text-blue-700 font-bold bg-white border px-2 py-1 rounded">ğŸ“„ Ø§Ù„Ø±Ø¯</a>` : ''}
                    </div>` : ''}
                </div>`;
            }).join('');
            lucide.createIcons();
        }
    </script>
</body>
</html>
