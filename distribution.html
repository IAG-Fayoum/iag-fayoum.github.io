<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مركز العمليات - IAG (Live Sheet)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        
        .kpi-card {
            background: white; border-radius: 12px; padding: 16px;
            border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 100px; transition: all 0.2s;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        /* Status Colors Mapping */
        .status-done { color: #15803d; background-color: #dcfce7; } /* تم الاعتماد والأرشفة */
        .status-review { color: #1d4ed8; background-color: #dbeafe; } /* قيد المراجعة / بانتظار الاعتماد */
        .status-late { color: #be123c; background-color: #ffe4e6; } /* متأخر */
        .status-wait { color: #854d0e; background-color: #fef9c3; } /* لم يتم البدء */
        
        .progress-track { background-color: #e2e8f0; border-radius: 99px; height: 6px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 99px; transition: width 1s ease; }

        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 100; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="pb-10">

    <div id="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="w-10 h-10 border-4 border-slate-800 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-slate-800 font-bold">جاري الاتصال بـ Google Sheet...</p>
        </div>
    </div>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-30 px-6 py-4 shadow-sm mb-8">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-slate-800">IAG Operations Center</h2>
                <div class="flex items-center gap-2 text-xs text-slate-500 mt-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span>متصل مباشرة: Google Sheet (1GgDP5w...)</span>
                </div>
            </div>
            <button onclick="fetchData()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition flex items-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> تحديث
            </button>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 space-y-8">

        <section>
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="bar-chart-2" class="w-5 h-5 text-teal-600"></i> مؤشرات الأداء العام
            </h3>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="kpi-card border-r-4 border-slate-600">
                    <span class="text-xs font-bold text-slate-400 uppercase">إجمالي التكليفات</span>
                    <div class="flex justify-between items-end">
                        <span class="text-3xl font-extrabold text-slate-800" id="stat-total">0</span>
                        <i data-lucide="layers" class="w-5 h-5 text-slate-300"></i>
                    </div>
                </div>
                <div class="kpi-card border-r-4 border-green-600">
                    <span class="text-xs font-bold text-slate-400 uppercase">تم الاعتماد والأرشفة</span>
                    <div class="flex justify-between items-end">
                        <span class="text-3xl font-extrabold text-green-700" id="stat-done">0</span>
                        <i data-lucide="check-circle-2" class="w-5 h-5 text-green-200"></i>
                    </div>
                </div>
                <div class="kpi-card border-r-4 border-blue-500">
                    <span class="text-xs font-bold text-slate-400 uppercase">قيد العمل / المراجعة</span>
                    <div class="flex justify-between items-end">
                        <span class="text-3xl font-extrabold text-blue-600" id="stat-active">0</span>
                        <i data-lucide="loader" class="w-5 h-5 text-blue-200"></i>
                    </div>
                </div>
                <div class="kpi-card border-r-4 border-violet-500">
                    <span class="text-xs font-bold text-slate-400 uppercase">متوسط زمن الإنجاز</span>
                    <div class="flex justify-between items-end">
                        <div class="flex items-baseline gap-1">
                            <span class="text-3xl font-extrabold text-violet-600" id="stat-avg-days">0</span>
                            <span class="text-xs font-bold text-slate-400">يوم</span>
                        </div>
                        <i data-lucide="zap" class="w-5 h-5 text-violet-200"></i>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                 <div class="kpi-card border-r-4 border-red-500 bg-red-50/30">
                    <span class="text-xs font-bold text-red-400 uppercase">متأخرات (Overdue)</span>
                    <div class="flex justify-between items-end">
                        <span class="text-3xl font-extrabold text-red-600" id="stat-late">0</span>
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-300"></i>
                    </div>
                </div>
                 <div class="kpi-card border-r-4 border-yellow-500">
                    <span class="text-xs font-bold text-slate-400 uppercase">لم يتم البدء</span>
                    <div class="flex justify-between items-end">
                        <span class="text-3xl font-extrabold text-yellow-600" id="stat-not-started">0</span>
                        <i data-lucide="clock" class="w-5 h-5 text-yellow-200"></i>
                    </div>
                </div>
                 <div class="kpi-card col-span-2 border-r-4 border-teal-500">
                    <span class="text-xs font-bold text-slate-400 uppercase">نسبة الإنجاز الكلية</span>
                    <div class="flex items-center gap-4 mt-2">
                        <span class="text-3xl font-extrabold text-teal-600" id="stat-rate">0%</span>
                        <div class="progress-track w-full">
                            <div class="progress-fill bg-teal-500" id="stat-rate-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="users" class="w-5 h-5 text-teal-600"></i> لوحة المتصدرين (Team Performance)
            </h3>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="py-4 px-6 text-xs font-bold text-slate-500">الترتيب</th>
                                <th class="py-4 px-6 text-xs font-bold text-slate-500">الموظف المكلف</th>
                                <th class="py-4 px-6 text-center text-xs font-bold text-slate-500">إجمالي المهام</th>
                                <th class="py-4 px-2 text-center text-[10px] font-bold text-green-700 bg-green-50">تم الاعتماد</th>
                                <th class="py-4 px-2 text-center text-[10px] font-bold text-blue-700 bg-blue-50">قيد العمل</th>
                                <th class="py-4 px-2 text-center text-[10px] font-bold text-red-700 bg-red-50">متأخر</th>
                                <th class="py-4 px-6 text-xs font-bold text-slate-500 w-1/4">معدل الإنجاز</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody" class="divide-y divide-slate-100 text-sm font-semibold text-slate-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

    </div>

    <script>
        // SHEET ID from your link: 1GgDP5wOGIaynlbVX0UfSsnJXUfwBvFSgh7xJ3u0fI6Y
        // We use Google Visualization API to get clean CSV data
        const SHEET_ID = '1GgDP5wOGIaynlbVX0UfSsnJXUfwBvFSgh7xJ3u0fI6Y';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchData();
        });

        function fetchData() {
            document.getElementById('loading-overlay').style.display = 'flex';
            
            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        processSheetData(results.data);
                    } else {
                        alert('لم يتم العثور على بيانات. تأكد من أن الشيت يحتوي على بيانات وأن أسماء الأعمدة صحيحة.');
                    }
                    document.getElementById('loading-overlay').style.display = 'none';
                },
                error: function(err) {
                    console.error(err);
                    alert('خطأ في الاتصال: تأكد من أن الشيت "Published to Web" أو متاح للعامة.');
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            });
        }

        function processSheetData(data) {
            // 1. Initialize Counters
            let total = 0, done = 0, active = 0, late = 0, notStarted = 0;
            let totalDays = 0, tasksWithDays = 0;
            
            // Employee Map
            const employeeStats = {};

            // 2. Loop through rows
            data.forEach(row => {
                // Map columns based on your provided headers
                const empName = row['الموظف_المكلف'] ? row['الموظف_المكلف'].trim() : 'غير معين';
                const status = row['الحالة'] ? row['الحالة'].trim() : '';
                const startDateStr = row['تاريخ_التخصيص'];
                const endDateStr = row['تاريخ_الإنجاز'];

                if (!status) return; // Skip empty rows

                total++;

                // -- Status Logic (Categorization) --
                let isDone = false;
                let isLate = false;
                let isActive = false;

                if (status.includes('تم الاعتماد') || status.includes('منتهي') || status.includes('مؤرشف')) {
                    done++;
                    isDone = true;
                    
                    // Efficiency Calculation (Only for Done tasks)
                    if (startDateStr && endDateStr) {
                        const days = calculateDaysDiff(startDateStr, endDateStr);
                        if (days !== null && days >= 0) {
                            totalDays += days;
                            tasksWithDays++;
                        }
                    }

                } else if (status.includes('متأخر')) {
                    late++;
                    isLate = true;
                } else if (status.includes('لم يتم البدء')) {
                    notStarted++;
                } else {
                    // Everything else is considered Active/In Progress (قيد المراجعة, بانتظار الاعتماد, etc.)
                    active++;
                    isActive = true;
                }

                // -- Employee Aggregation --
                if (empName !== 'غير معين') {
                    if (!employeeStats[empName]) {
                        employeeStats[empName] = { total: 0, done: 0, active: 0, late: 0 };
                    }
                    employeeStats[empName].total++;
                    if (isDone) employeeStats[empName].done++;
                    if (isActive) employeeStats[empName].active++;
                    if (isLate) employeeStats[empName].late++;
                }
            });

            // 3. Update Dashboard Numbers
            animateValue('stat-total', total);
            animateValue('stat-done', done);
            animateValue('stat-active', active);
            animateValue('stat-late', late);
            animateValue('stat-not-started', notStarted);

            // Efficiency
            const avgDays = tasksWithDays > 0 ? Math.round(totalDays / tasksWithDays) : 0;
            animateValue('stat-avg-days', avgDays);

            // Rate
            const rate = total > 0 ? Math.round((done / total) * 100) : 0;
            document.getElementById('stat-rate').innerText = rate + '%';
            document.getElementById('stat-rate-bar').style.width = rate + '%';

            // 4. Render Leaderboard
            renderLeaderboard(employeeStats);
        }

        function renderLeaderboard(statsObj) {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';

            // Convert object to array and sort by Done Rate
            const employees = Object.keys(statsObj).map(name => {
                const s = statsObj[name];
                const r = s.total > 0 ? Math.round((s.done / s.total) * 100) : 0;
                return { name, ...s, rate: r };
            }).sort((a, b) => b.rate - a.rate); // Sort Descending

            employees.forEach((emp, index) => {
                let rankHtml = `<span class="font-mono text-slate-400 font-bold">#${index + 1}</span>`;
                if(index === 0) rankHtml = `<div class="bg-yellow-100 text-yellow-700 w-8 h-8 rounded-full flex items-center justify-center mx-auto shadow-sm"><i data-lucide="trophy" class="w-4 h-4"></i></div>`;

                let barColor = 'bg-teal-500';
                if (emp.rate < 50) barColor = 'bg-red-500';
                else if (emp.rate < 80) barColor = 'bg-blue-500';

                const tr = `
                    <tr class="hover:bg-slate-50 transition group">
                        <td class="text-center align-middle py-4">${rankHtml}</td>
                        <td class="font-bold text-slate-800">${emp.name}</td>
                        <td class="text-center"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${emp.total}</span></td>
                        <td class="text-center text-green-700 font-bold bg-green-50/50">${emp.done}</td>
                        <td class="text-center text-blue-700 font-bold bg-blue-50/50">${emp.active}</td>
                        <td class="text-center text-red-700 font-bold bg-red-50/50">${emp.late}</td>
                        <td class="align-middle px-6">
                            <div class="flex items-center gap-3">
                                <div class="progress-track w-full">
                                    <div class="progress-fill ${barColor}" style="width: ${emp.rate}%"></div>
                                </div>
                                <span class="text-xs font-bold text-slate-600 w-8">${emp.rate}%</span>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
            lucide.createIcons();
        }

        // Helper: Date Difference
        function calculateDaysDiff(start, end) {
            const d1 = new Date(start);
            const d2 = new Date(end);
            if (isNaN(d1) || isNaN(d2)) return null;
            const diffTime = Math.abs(d2 - d1);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        }

        function animateValue(id, end) {
            const obj = document.getElementById(id);
            if(!obj) return;
            let current = 0;
            const increment = Math.ceil(end / 20); // Speed
            if (end === 0) { obj.innerText = 0; return; }
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= end) {
                    obj.innerText = end;
                    clearInterval(timer);
                } else {
                    obj.innerText = current;
                }
            }, 30);
        }
    </script>
</body>
</html>
