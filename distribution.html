<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - لوحة المراقبة</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        
        /* كروت الحالة الملونة */
        .status-card { @apply p-4 rounded-xl shadow-sm text-white flex flex-col justify-between h-28 transition-transform hover:-translate-y-1; }
        .bg-new { background: linear-gradient(135deg, #64748b 0%, #475569 100%); } /* لم يتم البدء - رمادي مزرق */
        .bg-review { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); } /* قيد المراجعة - برتقالي */
        .bg-pending { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); } /* انتظار الاعتماد - بنفسجي */
        .bg-done { background: linear-gradient(135deg, #10b981 0%, #059669 100%); } /* تم الاعتماد - أخضر */
        .bg-followup { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); } /* متابعة - أزرق سماوي */
        .bg-late { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); } /* متأخر - أحمر */
        
        /* Loading */
        #loading-overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-20">

    <div id="loading-overlay"><div class="spinner"></div></div>

    <header class="bg-slate-800 text-white pt-6 pb-12 px-6 shadow-lg mb-6">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <div class="flex items-center gap-4">
                <button onclick="window.history.back()" class="bg-white/10 p-2 rounded-full hover:bg-white/20 transition">
                    <i data-lucide="arrow-right" class="w-6 h-6"></i>
                </button>
                <div>
                    <h1 class="text-2xl font-bold">لوحة المراقبة (Dashboard)</h1>
                    <p class="text-slate-400 text-sm">تحليل وتوزيع الأعمال</p>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-2 bg-slate-700/50 p-2 rounded-lg backdrop-blur-sm">
                <select id="filterYear" class="bg-slate-800 border border-slate-600 text-white text-sm rounded px-3 py-1 outline-none focus:border-teal-500">
                    </select>

                <select id="filterPeriod" class="bg-slate-800 border border-slate-600 text-white text-sm rounded px-3 py-1 outline-none focus:border-teal-500">
                    <option value="">كامل السنة</option>
                    <optgroup label="ربع سنوي">
                        <option value="Q1">الربع الأول (Q1)</option>
                        <option value="Q2">الربع الثاني (Q2)</option>
                        <option value="Q3">الربع الثالث (Q3)</option>
                        <option value="Q4">الربع الرابع (Q4)</option>
                    </optgroup>
                    <optgroup label="شهري">
                        <option value="1">يناير</option>
                        <option value="2">فبراير</option>
                        <option value="3">مارس</option>
                        <option value="4">أبريل</option>
                        <option value="5">مايو</option>
                        <option value="6">يونيو</option>
                        <option value="7">يوليو</option>
                        <option value="8">أغسطس</option>
                        <option value="9">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </optgroup>
                </select>

                <select id="filterEmployee" class="bg-slate-800 border border-slate-600 text-white text-sm rounded px-3 py-1 outline-none focus:border-teal-500 min-w-[150px]">
                    <option value="">كل الموظفين</option>
                    </select>

                <button onclick="loadDashboardData()" class="bg-teal-600 hover:bg-teal-500 text-white p-1.5 rounded transition">
                    <i data-lucide="filter" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 -mt-8">
        
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-8">
            <div class="status-card bg-new">
                <div class="flex justify-between items-start">
                    <i data-lucide="circle" class="w-6 h-6 opacity-70"></i>
                    <span class="text-3xl font-bold" id="stat-notStarted">0</span>
                </div>
                <span class="text-xs font-bold">لم يتم البدء</span>
            </div>

            <div class="status-card bg-review">
                <div class="flex justify-between items-start">
                    <i data-lucide="loader-2" class="w-6 h-6 opacity-70"></i>
                    <span class="text-3xl font-bold" id="stat-inProgress">0</span>
                </div>
                <span class="text-xs font-bold">قيد المراجعة</span>
            </div>

            <div class="status-card bg-pending">
                <div class="flex justify-between items-start">
                    <i data-lucide="rubber-stamp" class="w-6 h-6 opacity-70"></i>
                    <span class="text-3xl font-bold" id="stat-pending">0</span>
                </div>
                <span class="text-xs font-bold">بانتظار الاعتماد</span>
            </div>

            <div class="status-card bg-followup">
                <div class="flex justify-between items-start">
                    <i data-lucide="eye" class="w-6 h-6 opacity-70"></i>
                    <span class="text-3xl font-bold" id="stat-followUp">0</span>
                </div>
                <span class="text-xs font-bold">بحاجة لمتابعة</span>
            </div>

            <div class="status-card bg-late">
                <div class="flex justify-between items-start">
                    <i data-lucide="alert-circle" class="w-6 h-6 opacity-70"></i>
                    <span class="text-3xl font-bold" id="stat-overdue">0</span>
                </div>
                <span class="text-xs font-bold">متأخر</span>
            </div>

            <div class="status-card bg-done">
                <div class="flex justify-between items-start">
                    <i data-lucide="check-circle-2" class="w-6 h-6 opacity-70"></i>
                    <span class="text-3xl font-bold" id="stat-completed">0</span>
                </div>
                <span class="text-xs font-bold">تم الاعتماد والأرشفة</span>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex items-center gap-2">
                <i data-lucide="list-todo" class="text-slate-700 w-5 h-5"></i>
                <h2 class="font-bold text-slate-800">جدول توزيع الأعمال</h2>
                <span class="bg-teal-100 text-teal-800 text-xs px-2 py-1 rounded-full mr-auto font-bold" id="total-assign-badge">0 تكليف</span>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-100 text-slate-600 font-bold border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-4 w-1/4">الاسم</th>
                            <th class="px-6 py-4 w-1/12 text-center">العدد</th>
                            <th class="px-6 py-4">المهام / التكليفات المستلمة</th>
                        </tr>
                    </thead>
                    <tbody id="distributionTableBody" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupFilters();
            loadDashboardData();
        });

        function setupFilters() {
            // ملء قائمة السنوات (من 2024 حتى السنة الحالية)
            const yearSelect = document.getElementById('filterYear');
            const currentYear = new Date().getFullYear();
            for (let y = currentYear; y >= 2024; y--) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                yearSelect.appendChild(option);
            }
        }

        async function loadDashboardData() {
            const year = document.getElementById('filterYear').value;
            const period = document.getElementById('filterPeriod').value;
            const employee = document.getElementById('filterEmployee').value;

            // استدعاء API
            const result = await auth.apiCall('getDashboardData', { 
                year: year, 
                period: period,
                employeeId: employee 
            });
            
            if (result.success) {
                updateStats(result.stats);
                updateTable(result.employees);
                updateEmployeeDropdown(result.activeEmployeesList);
            } else {
                alert('فشل تحميل البيانات: ' + result.error);
            }
        }

        function updateStats(stats) {
            animateValue("stat-notStarted", stats.notStarted);
            animateValue("stat-inProgress", stats.inProgress);
            animateValue("stat-pending", stats.pending);
            animateValue("stat-completed", stats.completed);
            animateValue("stat-followUp", stats.followUp);
            animateValue("stat-overdue", stats.overdue);
            
            document.getElementById('total-assign-badge').textContent = stats.total + " تكليف";
        }

        function updateTable(employees) {
            const tbody = document.getElementById('distributionTableBody');
            tbody.innerHTML = '';

            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-slate-400">لا توجد بيانات لهذه الفترة</td></tr>';
                return;
            }

            employees.forEach(emp => {
                // تخطي الموظفين الذين ليس لديهم مهام في هذا الفلتر (اختياري، لكن يجعل الجدول أنظف)
                if (emp.count === 0) return;

                let tasksHtml = '<div class="flex flex-wrap gap-2">';
                emp.tasks.forEach(task => {
                    // تحديد لون بسيط للحالة داخل الكارت الصغير
                    let borderClass = 'border-slate-200';
                    if (task.status.includes('جديد')) borderClass = 'border-slate-400';
                    if (task.status.includes('متأخر')) borderClass = 'border-red-300 bg-red-50';
                    if (task.status.includes('منتهي')) borderClass = 'border-emerald-300 bg-emerald-50';

                    tasksHtml += `
                        <div class="border ${borderClass} rounded-lg px-3 py-2 bg-white shadow-sm flex flex-col min-w-[200px] max-w-[250px]">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-mono text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-600">${task.id}</span>
                                <span class="text-[10px] text-slate-400">${task.date}</span>
                            </div>
                            <span class="font-bold text-xs text-slate-800 truncate mb-1" title="${task.subject}">${task.subject}</span>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-slate-500 truncate max-w-[100px]">${task.entity}</span>
                                <span class="text-[10px] font-bold px-2 rounded-full 
                                    ${task.status.includes('متأخر') ? 'text-red-600 bg-red-100' : 
                                      task.status.includes('منتهي') ? 'text-emerald-600 bg-emerald-100' : 'text-slate-600 bg-slate-100'}">
                                    ${task.status}
                                </span>
                            </div>
                        </div>
                    `;
                });
                tasksHtml += '</div>';

                const row = `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 align-top">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-teal-50 text-teal-700 flex items-center justify-center font-bold shadow-sm">
                                    ${emp.name.charAt(0)}
                                </div>
                                <span class="font-bold text-slate-700">${emp.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 align-top text-center">
                            <span class="inline-block bg-slate-800 text-white text-xs px-3 py-1 rounded-full font-bold">
                                ${emp.count}
                            </span>
                        </td>
                        <td class="px-6 py-4 align-top">
                            ${tasksHtml}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            lucide.createIcons();
        }

        // تحديث القائمة المنسدلة مرة واحدة فقط عند التحميل
        let isDropdownLoaded = false;
        function updateEmployeeDropdown(list) {
            if (isDropdownLoaded || !list) return;
            const select = document.getElementById('filterEmployee');
            // احتفاظ بالخيار الأول "الكل"
            select.innerHTML = '<option value="">كل الموظفين</option>';
            list.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
            isDropdownLoaded = true;
        }

        function animateValue(id, end) {
            const obj = document.getElementById(id);
            if (!obj) return;
            obj.innerText = end; // تحديث مباشر للسرعة، يمكن إضافة أنيميشن لو رغبت
        }
    </script>
</body>
</html>
