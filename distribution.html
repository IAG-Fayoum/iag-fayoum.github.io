<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>مركز العمليات - IAG</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        /* Sidebar & Layout */
        .sidebar {
            position: fixed; top: 0; right: 0; width: 260px; height: 100%;
            background: #ffffff; border-left: 1px solid #e2e8f0;
            z-index: 50; display: none; flex-direction: column;
            padding: 24px; box-shadow: -4px 0 20px rgba(0,0,0,0.02);
        }
        @media (min-width: 1024px) { 
            .sidebar { display: flex; } 
            .main-content { margin-right: 260px; }
        }
        
        .nav-link {
            display: flex; items-center; gap: 12px; padding: 12px 16px;
            border-radius: 12px; color: #64748b; font-weight: 600; font-size: 14px;
            transition: all 0.2s; margin-bottom: 4px;
        }
        .nav-link:hover, .nav-link.active { background-color: #f0fdfa; color: #0f766e; }
        .nav-link.active { background-color: #0f766e; color: white; box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2); }

        /* KPI Cards Grid - Optimized for 8 cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        @media (min-width: 768px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }

        .kpi-card {
            background: white; border-radius: 16px; padding: 16px;
            border: 1px solid #f1f5f9; box-shadow: 0 2px 6px rgba(0,0,0,0.01);
            transition: transform 0.2s; display: flex; flex-direction: column; justify-content: space-between;
            min-height: 110px;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* Progress Bar */
        .progress-track { background-color: #e2e8f0; border-radius: 99px; height: 8px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 99px; }

        /* Status Colors (Based on your Image) */
        .bg-status-done { background-color: #15803d; } /* تم الاعتماد والأرشفة - Green Dark */
        .text-status-done { color: #15803d; }
        
        .bg-status-wait { background-color: #86efac; } /* بانتظار الاعتماد - Light Green */
        .text-status-wait { color: #166534; }

        .bg-status-review { background-color: #93c5fd; } /* قيد المراجعة - Blue */
        .text-status-review { color: #1e40af; }

        .bg-status-not-started { background-color: #fde047; } /* لم يتم البدء - Yellow */
        .text-status-not-started { color: #854d0e; }

        .bg-status-followup { background-color: #cbd5e1; } /* بحاجة الى متابعة - Grey */
        .text-status-followup { color: #475569; }

        .bg-status-late { background-color: #f43f5e; } /* متأخر - Red */
        .text-status-late { color: #be123c; }

        /* Mobile Nav */
        .mobile-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #e2e8f0;
            display: flex; justify-content: space-around; padding: 12px;
            z-index: 50; padding-bottom: env(safe-area-inset-bottom);
        }
        @media (min-width: 1024px) { .mobile-nav { display: none; } }

        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="pb-24 lg:pb-0">

    <div id="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="w-10 h-10 border-4 border-teal-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-teal-800 font-bold text-sm">جاري جلب البيانات...</p>
        </div>
    </div>

    <aside class="sidebar">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="w-10 h-10 bg-teal-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-teal-600/20">
                <i data-lucide="activity" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800">IAG Hub</h1>
                <p class="text-[10px] text-slate-400 font-bold">إدارة المراجعة الداخلية</p>
            </div>
        </div>

        <nav class="flex-1">
            <a href="distribution.html" class="nav-link active">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>لوحة العمليات</span>
            </a>
            <a href="admin.html" class="nav-link">
                <i data-lucide="pie-chart" class="w-5 h-5"></i>
                <span>الإحصائيات العامة</span>
            </a>
            <a href="employee.html" class="nav-link">
                <i data-lucide="briefcase" class="w-5 h-5"></i>
                <span>مهامي</span>
            </a>
        </nav>

        <div class="mt-auto">
            <button onclick="auth.logout()" class="nav-link text-red-500 hover:bg-red-50 w-full">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>تسجيل خروج</span>
            </button>
        </div>
    </aside>

    <div class="main-content min-h-screen">
        
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-30 px-6 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-slate-800">مركز العمليات الموحد</h2>
                    <p class="text-xs text-slate-500">متابعة الأداء، الكفاءة، وتوزيع المهام</p>
                </div>
                
                <div class="flex gap-2 bg-slate-100 p-1 rounded-lg">
                    <select id="filterYear" class="bg-white text-slate-700 text-xs font-bold rounded-md px-3 py-2 outline-none shadow-sm cursor-pointer border border-slate-200 hover:border-teal-500 transition"></select>
                    <select id="filterPeriod" class="bg-white text-slate-700 text-xs font-bold rounded-md px-3 py-2 outline-none shadow-sm cursor-pointer border border-slate-200 hover:border-teal-500 transition">
                        <option value="">كل السنة</option>
                        <option value="Q1">الربع الأول</option>
                        <option value="Q2">الربع الثاني</option>
                        <option value="Q3">الربع الثالث</option>
                        <option value="Q4">الربع الرابع</option>
                        <option value="1">يناير</option><option value="2">فبراير</option>
                    </select>
                    <button onclick="loadData()" class="bg-teal-600 text-white px-3 rounded-md hover:bg-teal-700 transition shadow-lg shadow-teal-600/20">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="p-6 space-y-8">

            <section>
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-1 h-6 bg-teal-500 rounded-full"></div>
                    <h3 class="text-lg font-bold text-slate-800">1. مؤشرات الأداء والكفاءة (Status & Efficiency)</h3>
                </div>
                
                <div class="stats-grid mb-4">
                    <div class="kpi-card border-r-4 border-slate-500">
                        <div class="text-slate-400 text-[10px] font-bold uppercase">إجمالي التكليفات</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-slate-800" id="stat-total">0</span>
                            <div class="p-2 rounded-lg bg-slate-50 text-slate-600"><i data-lucide="layers" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="kpi-card border-r-4 border-green-700">
                        <div class="text-slate-400 text-[10px] font-bold uppercase">تم الاعتماد والأرشفة</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-green-700" id="stat-archived">0</span>
                            <div class="p-2 rounded-lg bg-green-50 text-green-700"><i data-lucide="check-check" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="kpi-card border-r-4 border-blue-500">
                        <div class="text-slate-400 text-[10px] font-bold uppercase">جاري العمل (مراجعة/اعتماد)</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-blue-600" id="stat-in-progress">0</span>
                            <div class="p-2 rounded-lg bg-blue-50 text-blue-600"><i data-lucide="loader-2" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="kpi-card border-r-4 border-yellow-400">
                        <div class="text-slate-400 text-[10px] font-bold uppercase">لم يتم البدء</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-yellow-600" id="stat-not-started">0</span>
                            <div class="p-2 rounded-lg bg-yellow-50 text-yellow-600"><i data-lucide="clock" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="kpi-card border-r-4 border-red-500 bg-red-50/10">
                        <div class="text-red-400 text-[10px] font-bold uppercase">متأخر (Overdue)</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-red-600" id="stat-overdue">0</span>
                            <div class="p-2 rounded-lg bg-red-50 text-red-600"><i data-lucide="alert-circle" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="kpi-card border-r-4 border-slate-400">
                        <div class="text-slate-400 text-[10px] font-bold uppercase">بحاجة إلى متابعة</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-slate-600" id="stat-followup">0</span>
                            <div class="p-2 rounded-lg bg-slate-100 text-slate-600"><i data-lucide="help-circle" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="kpi-card border-r-4 border-violet-500">
                        <div class="text-slate-400 text-[10px] font-bold uppercase">متوسط زمن الإغلاق</div>
                        <div class="flex justify-between items-end">
                            <div class="flex items-baseline gap-1">
                                <span class="text-3xl font-extrabold text-violet-600" id="stat-avg-days">0</span>
                                <span class="text-xs font-bold text-slate-400">يوم</span>
                            </div>
                            <div class="p-2 rounded-lg bg-violet-50 text-violet-600"><i data-lucide="zap" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="kpi-card border-r-4 border-teal-500">
                        <div class="text-slate-400 text-[10px] font-bold uppercase">نسبة الإنجاز الكلية</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-teal-600" id="stat-rate">0%</span>
                            <div class="p-2 rounded-lg bg-teal-50 text-teal-600"><i data-lucide="percent" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-1 h-6 bg-violet-500 rounded-full"></div>
                        <h3 class="text-lg font-bold text-slate-800">2. تقييم أداء الفريق (Leaderboard)</h3>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="py-4 px-6 text-xs font-bold text-slate-400 uppercase">الترتيب</th>
                                    <th class="py-4 px-6 text-xs font-bold text-slate-400 uppercase">الموظف</th>
                                    <th class="py-4 px-6 text-center text-xs font-bold text-slate-400 uppercase">المهام</th>
                                    <th class="py-4 px-2 text-center text-[10px] font-bold text-green-700 uppercase bg-green-50">تم الاعتماد</th>
                                    <th class="py-4 px-2 text-center text-[10px] font-bold text-blue-700 uppercase bg-blue-50">جاري العمل</th>
                                    <th class="py-4 px-2 text-center text-[10px] font-bold text-red-700 uppercase bg-red-50">متأخر</th>
                                    <th class="py-4 px-6 text-xs font-bold text-slate-400 uppercase w-1/4">معدل الإنجاز</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody" class="divide-y divide-slate-100 text-sm font-semibold text-slate-700">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div class="mobile-nav">
        <a href="distribution.html" class="flex flex-col items-center text-teal-600"><i data-lucide="layout-dashboard" class="w-6 h-6"></i></a>
        <a href="admin.html" class="flex flex-col items-center text-slate-400"><i data-lucide="pie-chart" class="w-6 h-6"></i></a>
    </div>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    
    <script>
        // --- Mock Data Generator (To simulate backend response) ---
        // This function creates random data fitting your requested categories
        function generateMockData() {
            const employees = ['أحمد محمد', 'سارة علي', 'خالد عمر', 'منى حسن', 'يوسف إبراهيم'];
            const depts = ['مراجعة مالية', 'مراجعة تشغيلية', 'التزام', 'IT Audit', 'مخاطر'];
            
            let data = [];
            
            employees.forEach((name, idx) => {
                // Random stats per employee based on your image categories
                const archived = Math.floor(Math.random() * 50) + 10; // تم الاعتماد والأرشفة
                const waiting = Math.floor(Math.random() * 10); // بانتظار الاعتماد
                const review = Math.floor(Math.random() * 15); // قيد المراجعة
                const notStarted = Math.floor(Math.random() * 8); // لم يتم البدء
                const late = Math.floor(Math.random() * 5); // متأخر
                const followup = Math.floor(Math.random() * 5); // بحاجة لمتابعة

                const total = archived + waiting + review + notStarted + late + followup;
                const completionRate = Math.round((archived / total) * 100);
                
                // Mock Efficiency (Average days to close a task)
                const avgDays = Math.floor(Math.random() * 15) + 2; 

                data.push({
                    name: name,
                    dept: depts[idx],
                    stats: {
                        total,
                        archived,      // Green Dark
                        waiting,       // Light Green
                        review,        // Blue
                        notStarted,    // Yellow
                        late,          // Red
                        followup,      // Grey
                        avgDays
                    },
                    rate: completionRate
                });
            });

            // Sort by completion rate for Leaderboard
            return data.sort((a, b) => b.rate - a.rate);
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupFilters();
            loadData();
        });

        function setupFilters() {
            const yearSelect = document.getElementById('filterYear');
            const current = new Date().getFullYear();
            [current, current-1, current-2].forEach(y => {
                const opt = document.createElement('option');
                opt.value = y; opt.textContent = y;
                yearSelect.appendChild(opt);
            });
        }

        async function loadData() {
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // Simulation of API Call delay
            setTimeout(() => {
                const employeesData = generateMockData();
                renderDashboard(employeesData);
                document.getElementById('loading-overlay').style.display = 'none';
            }, 800);
        }

        function renderDashboard(employees) {
            // 1. Calculate Aggregated Stats
            let total = 0, archived = 0, waiting = 0, review = 0, notStarted = 0, late = 0, followup = 0;
            let totalDays = 0;

            employees.forEach(emp => {
                total += emp.stats.total;
                archived += emp.stats.archived;
                waiting += emp.stats.waiting;
                review += emp.stats.review;
                notStarted += emp.stats.notStarted;
                late += emp.stats.late;
                followup += emp.stats.followup;
                totalDays += emp.stats.avgDays;
            });

            // "Active" or "In Progress" groups: Waiting + Review
            const inProgress = waiting + review;
            const avgDaysGlobal = Math.round(totalDays / employees.length);
            const globalRate = Math.round((archived / total) * 100) || 0;

            // Update Cards
            animateValue('stat-total', total);
            animateValue('stat-archived', archived);
            animateValue('stat-in-progress', inProgress); // Grouped
            animateValue('stat-not-started', notStarted);
            animateValue('stat-overdue', late);
            animateValue('stat-followup', followup);
            animateValue('stat-avg-days', avgDaysGlobal);
            document.getElementById('stat-rate').innerText = globalRate + '%';

            // 2. Render Leaderboard
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';

            employees.forEach((emp, index) => {
                // Rank Styling
                let rankHtml = `<span class="font-mono text-slate-400">#${index + 1}</span>`;
                if(index === 0) rankHtml = `<div class="bg-yellow-100 text-yellow-700 w-8 h-8 rounded-full flex items-center justify-center mx-auto"><i data-lucide="trophy" class="w-4 h-4"></i></div>`;
                
                // Progress Bar Color based on Rate
                let barColor = 'bg-status-done'; // Default Green
                if(emp.rate < 60) barColor = 'bg-status-late';
                else if(emp.rate < 85) barColor = 'bg-status-review';

                const row = `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="text-center align-middle">${rankHtml}</td>
                        <td class="py-4 px-6">
                            <div class="flex flex-col">
                                <span class="font-bold text-slate-800">${emp.name}</span>
                                <span class="text-[10px] text-slate-400">${emp.dept}</span>
                            </div>
                        </td>
                        <td class="text-center align-middle"><span class="bg-slate-100 px-2 py-1 rounded text-slate-700 font-bold text-xs">${emp.stats.total}</span></td>
                        
                        <td class="text-center align-middle text-status-done font-bold bg-green-50/50">${emp.stats.archived}</td>
                        <td class="text-center align-middle text-status-review font-bold bg-blue-50/50">${emp.stats.review + emp.stats.waiting}</td>
                        <td class="text-center align-middle text-status-late font-bold bg-red-50/50">${emp.stats.late}</td>
                        
                        <td class="align-middle px-6">
                            <div class="flex items-center gap-3">
                                <div class="progress-track w-full">
                                    <div class="progress-fill ${barColor}" style="width: ${emp.rate}%"></div>
                                </div>
                                <span class="text-xs font-bold text-slate-600 w-8 text-left">${emp.rate}%</span>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            lucide.createIcons();
        }

        function animateValue(id, end) {
            const obj = document.getElementById(id);
            if(!obj) return;
            let start = 0;
            if (end === 0) { obj.innerText = 0; return; }
            let duration = 1000;
            let startTime = null;
            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                let progress = timestamp - startTime;
                let value = Math.min(Math.floor(progress / duration * end), end);
                obj.innerText = value;
                if (progress < duration) window.requestAnimationFrame(step);
            }
            window.requestAnimationFrame(step);
        }
    </script>
</body>
</html>
