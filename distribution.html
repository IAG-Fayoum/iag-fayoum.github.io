<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>مركز العمليات - IAG</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        /* إعدادات الخطوط والألوان العامة */
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; color: #1e293b; }
        
        /* Sidebar Styling (SaaS Style) */
        .sidebar {
            position: fixed; top: 0; right: 0; width: 260px; height: 100%;
            background: #ffffff; border-left: 1px solid #e2e8f0;
            z-index: 50; display: none; flex-direction: column;
            padding: 24px; box-shadow: -4px 0 20px rgba(0,0,0,0.02);
        }
        @media (min-width: 1024px) { 
            .sidebar { display: flex; } 
            .main-content { margin-right: 260px; }
        }
        
        /* Navigation Links */
        .nav-link {
            display: flex; items-center; gap: 12px; padding: 12px 16px;
            border-radius: 12px; color: #64748b; font-weight: 600; font-size: 14px;
            transition: all 0.2s; margin-bottom: 4px;
        }
        .nav-link:hover, .nav-link.active {
            background-color: #f0fdfa; color: #0f766e;
        }
        .nav-link.active { background-color: #0f766e; color: white; box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2); }

        /* Mobile Bottom Nav */
        .mobile-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #e2e8f0;
            display: flex; justify-content: space-around; padding: 12px;
            z-index: 50; padding-bottom: env(safe-area-inset-bottom);
        }
        @media (min-width: 1024px) { .mobile-nav { display: none; } }

        /* Card Styles */
        .kpi-card {
            background: white; border-radius: 16px; padding: 20px;
            border: 1px solid #f1f5f9; box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-2px); }

        /* Table Styles */
        .custom-table th { @apply text-right text-xs font-bold text-slate-400 uppercase tracking-wider py-4 px-6 border-b border-slate-100; }
        .custom-table td { @apply py-4 px-6 border-b border-slate-50 text-sm font-semibold text-slate-700; }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tr:hover { background-color: #f8fafc; }

        /* Progress Bar */
        .progress-track { background-color: #f1f5f9; border-radius: 99px; height: 8px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 99px; transition: width 1s ease; }

        /* Loading */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="pb-24 lg:pb-0">

    <div id="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-teal-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-teal-800 font-bold">جاري تحليل البيانات...</p>
        </div>
    </div>

    <aside class="sidebar">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="w-10 h-10 bg-teal-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-teal-600/20">
                <i data-lucide="activity" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800">IAG Hub</h1>
                <p class="text-[10px] text-slate-400 font-bold">إدارة المراجعة الداخلية</p>
            </div>
        </div>

        <nav class="flex-1">
            <a href="distribution.html" class="nav-link active">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>لوحة العمليات</span>
            </a>
            <a href="admin.html" class="nav-link">
                <i data-lucide="pie-chart" class="w-5 h-5"></i>
                <span>الإحصائيات العامة</span>
            </a>
            <a href="employee.html" class="nav-link">
                <i data-lucide="briefcase" class="w-5 h-5"></i>
                <span>مهامي</span>
            </a>
            <a href="settings.html" class="nav-link">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span>إعدادات النظام</span>
            </a>
        </nav>

        <div class="mt-auto">
            <button onclick="auth.logout()" class="nav-link text-red-500 hover:bg-red-50 hover:text-red-600 w-full">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>تسجيل خروج</span>
            </button>
        </div>
    </aside>

    <div class="main-content min-h-screen">
        
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-30 px-6 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-bold text-slate-800">مركز العمليات الموحد</h2>
                
                <div class="flex gap-2 bg-slate-100 p-1 rounded-lg">
                    <select id="filterYear" class="bg-white text-slate-700 text-xs font-bold rounded-md px-3 py-2 outline-none shadow-sm cursor-pointer border border-slate-200 hover:border-teal-500 transition">
                        </select>
                    <select id="filterPeriod" class="bg-white text-slate-700 text-xs font-bold rounded-md px-3 py-2 outline-none shadow-sm cursor-pointer border border-slate-200 hover:border-teal-500 transition">
                        <option value="">كل السنة</option>
                        <option value="Q1">الربع الأول</option>
                        <option value="Q2">الربع الثاني</option>
                        <option value="Q3">الربع الثالث</option>
                        <option value="Q4">الربع الرابع</option>
                        <option value="1">يناير</option><option value="2">فبراير</option><option value="3">مارس</option>
                        <option value="4">أبريل</option><option value="5">مايو</option><option value="6">يونيو</option>
                        <option value="7">يوليو</option><option value="8">أغسطس</option><option value="9">سبتمبر</option>
                        <option value="10">أكتوبر</option><option value="11">نوفمبر</option><option value="12">ديسمبر</option>
                    </select>
                    <button onclick="loadData()" class="bg-teal-600 text-white px-3 rounded-md hover:bg-teal-700 transition shadow-lg shadow-teal-600/20">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="p-6 space-y-8">

            <section>
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-1 h-6 bg-teal-500 rounded-full"></div>
                    <h3 class="text-lg font-bold text-slate-800">1. مؤشرات الأداء العام (المالي والإداري)</h3>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="kpi-card border-l-4 border-blue-500">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-2">إجمالي التكليفات</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-slate-800" id="stat-total">0</span>
                            <div class="bg-blue-50 p-2 rounded-lg text-blue-600"><i data-lucide="layers" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="kpi-card border-l-4 border-emerald-500">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-2">تم الإنجاز</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-slate-800" id="stat-completed">0</span>
                            <div class="bg-emerald-50 p-2 rounded-lg text-emerald-600"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="kpi-card border-l-4 border-amber-500">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-2">قيد العمل</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-slate-800" id="stat-pending">0</span>
                            <div class="bg-amber-50 p-2 rounded-lg text-amber-600"><i data-lucide="loader-2" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                    <div class="kpi-card border-l-4 border-red-500">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-2">متأخرات</div>
                        <div class="flex justify-between items-end">
                            <span class="text-3xl font-extrabold text-slate-800" id="stat-overdue">0</span>
                            <div class="bg-red-50 p-2 rounded-lg text-red-600"><i data-lucide="alert-circle" class="w-5 h-5"></i></div>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-1 h-6 bg-violet-500 rounded-full"></div>
                    <h3 class="text-lg font-bold text-slate-800">2. تقييم أداء الفريق (Leaderboard)</h3>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full custom-table">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="w-16 text-center">الترتيب</th>
                                    <th>الموظف</th>
                                    <th class="text-center">المهام</th>
                                    <th class="text-center text-emerald-600">منجز</th>
                                    <th class="text-center text-red-600">متأخر</th>
                                    <th class="w-1/3">معدل الإنجاز</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-1 h-6 bg-rose-500 rounded-full"></div>
                        <h3 class="text-lg font-bold text-slate-800">3. سجل استلام التكليفات (توزيع الدفتر)</h3>
                    </div>
                    
                    <div class="relative">
                        <select id="taskEmployeeFilter" onchange="filterTasksLog()" class="appearance-none bg-white border border-slate-300 text-slate-700 py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:border-teal-500 font-bold text-sm shadow-sm min-w-[200px]">
                            <option value="">اختر الموظف...</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center px-2 text-slate-700">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 min-h-[300px]">
                    
                    <div id="noSelectionState" class="flex flex-col items-center justify-center py-10 text-slate-400">
                        <div class="bg-slate-50 p-4 rounded-full mb-4">
                            <i data-lucide="user-search" class="w-10 h-10 text-slate-300"></i>
                        </div>
                        <p class="font-medium">اختر اسم الموظف من القائمة أعلاه لعرض سجل التكليفات الخاص به</p>
                        <p class="text-xs mt-2">يستخدم هذا السجل لتأكيد الاستلام والتوقيع في الدفتر</p>
                    </div>

                    <div id="employeeTasksLog" class="hidden space-y-3">
                        </div>
                </div>
            </section>

        </div>
    </div>

    <div class="mobile-nav">
        <a href="distribution.html" class="flex flex-col items-center text-teal-600">
            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
        </a>
        <a href="admin.html" class="flex flex-col items-center text-slate-400">
            <i data-lucide="pie-chart" class="w-6 h-6"></i>
        </a>
        <a href="employee.html" class="flex flex-col items-center text-slate-400">
            <i data-lucide="briefcase" class="w-6 h-6"></i>
        </a>
        <a href="settings.html" class="flex flex-col items-center text-slate-400">
            <i data-lucide="settings" class="w-6 h-6"></i>
        </a>
    </div>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    
    <script>
        let globalData = null;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupFilters();
            loadData();
            
            document.getElementById('filterYear').addEventListener('change', loadData);
            document.getElementById('filterPeriod').addEventListener('change', loadData);
        });

        function setupFilters() {
            const yearSelect = document.getElementById('filterYear');
            const years = [2027, 2026, 2025, 2024];
            const current = new Date().getFullYear();
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y; opt.textContent = y;
                if(y === current) opt.selected = true;
                yearSelect.appendChild(opt);
            });
        }

        async function loadData() {
            document.getElementById('loading-overlay').style.display = 'flex';
            
            const result = await auth.apiCall('getDashboardData', { 
                year: document.getElementById('filterYear').value,
                period: document.getElementById('filterPeriod').value
            });
            
            document.getElementById('loading-overlay').style.display = 'none';

            if (result.success) {
                globalData = result;
                renderStats(result.stats);
                renderLeaderboard(result.employees);
                populateEmployeeFilter(result.employees);
                
                // If an employee was already selected, refresh their view
                const currentSelect = document.getElementById('taskEmployeeFilter').value;
                if(currentSelect) filterTasksLog();
            } else {
                alert('خطأ: ' + result.error);
            }
        }

        function renderStats(stats) {
            animateValue('stat-total', stats.total);
            animateValue('stat-completed', stats.completed);
            animateValue('stat-pending', stats.pending + stats.inProgress); // جمعنا الجاري والانتظار
            animateValue('stat-overdue', stats.overdue);
        }

        function renderLeaderboard(employees) {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';

            employees.forEach((emp, index) => {
                // Rank Styling
                let rankHtml = `<span class="font-mono text-slate-400 font-bold">#${index + 1}</span>`;
                if(index === 0) rankHtml = `<div class="bg-yellow-100 text-yellow-700 w-8 h-8 rounded-full flex items-center justify-center mx-auto"><i data-lucide="trophy" class="w-4 h-4"></i></div>`;
                else if(index === 1) rankHtml = `<div class="bg-slate-100 text-slate-600 w-8 h-8 rounded-full flex items-center justify-center mx-auto font-bold">2</div>`;
                else if(index === 2) rankHtml = `<div class="bg-orange-50 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center mx-auto font-bold">3</div>`;

                // Progress Bar Color
                let barColor = 'bg-teal-500';
                if(emp.rate < 50) barColor = 'bg-red-500';
                else if(emp.rate < 80) barColor = 'bg-amber-500';

                const row = `
                    <tr>
                        <td class="text-center align-middle">${rankHtml}</td>
                        <td>
                            <div class="flex flex-col">
                                <span class="font-bold text-slate-800 text-base">${emp.name}</span>
                                <span class="text-[10px] text-slate-400">${emp.dept}</span>
                            </div>
                        </td>
                        <td class="text-center align-middle"><span class="bg-slate-100 px-2 py-1 rounded text-slate-700 font-bold">${emp.total}</span></td>
                        <td class="text-center align-middle text-emerald-600 font-bold">${emp.completed}</td>
                        <td class="text-center align-middle text-red-600 font-bold">${emp.overdue}</td>
                        <td class="align-middle">
                            <div class="flex items-center gap-3">
                                <div class="progress-track w-full">
                                    <div class="progress-fill ${barColor}" style="width: ${emp.rate}%"></div>
                                </div>
                                <span class="text-xs font-bold text-slate-600 w-8">${emp.rate}%</span>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            lucide.createIcons();
        }

        // Section 3: Logic
        function populateEmployeeFilter(employees) {
            const select = document.getElementById('taskEmployeeFilter');
            // Save current selection if exists
            const currentVal = select.value;
            
            select.innerHTML = '<option value="">اختر الموظف...</option>';
            employees.forEach(emp => {
                const opt = document.createElement('option');
                opt.value = emp.name;
                opt.textContent = emp.name;
                select.appendChild(opt);
            });

            // Restore selection if valid
            if (currentVal) select.value = currentVal;
        }

        function filterTasksLog() {
            const selectedName = document.getElementById('taskEmployeeFilter').value;
            const container = document.getElementById('employeeTasksLog');
            const emptyState = document.getElementById('noSelectionState');

            if (!selectedName) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            // Find data in globalData (from rawTasks map or find in array)
            // Note: Backend returns 'rawTasks' map or we can find in 'employees' array
            const empData = globalData.employees.find(e => e.name === selectedName);
            
            if (!empData || !empData.tasks || empData.tasks.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-slate-400">لا توجد مهام مسجلة لهذا الموظف في الفترة المحددة</div>`;
            } else {
                container.innerHTML = '';
                // Sort tasks: Active/New first
                const sortedTasks = empData.tasks.sort((a, b) => {
                    if (a.status.includes('جديد') && !b.status.includes('جديد')) return -1;
                    return 0;
                });

                sortedTasks.forEach(task => {
                    let borderClass = 'border-slate-200 hover:border-slate-300';
                    let statusBadge = 'bg-slate-100 text-slate-600';
                    
                    if (task.status.includes('جديد') || task.status.includes('لم يتم')) {
                        borderClass = 'border-l-4 border-l-blue-500 border-y-slate-100 border-r-slate-100';
                        statusBadge = 'bg-blue-50 text-blue-600';
                    } else if (task.status.includes('متأخر')) {
                        borderClass = 'border-l-4 border-l-red-500 border-y-slate-100 border-r-slate-100';
                        statusBadge = 'bg-red-50 text-red-600';
                    } else if (task.status.includes('منتهي')) {
                        borderClass = 'border-l-4 border-l-emerald-500 border-y-slate-100 border-r-slate-100 opacity-75';
                        statusBadge = 'bg-emerald-50 text-emerald-600';
                    }

                    const card = `
                        <div class="bg-white p-4 rounded-xl shadow-sm border ${borderClass} transition flex justify-between items-center group">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-mono text-[10px] bg-slate-800 text-white px-2 py-0.5 rounded">#${task.id}</span>
                                    <span class="text-[10px] text-slate-400 font-bold">${task.date}</span>
                                </div>
                                <h4 class="font-bold text-slate-800 text-sm mb-1">${task.subject}</h4>
                                <div class="flex items-center gap-1 text-xs text-slate-500">
                                    <i data-lucide="building-2" class="w-3 h-3"></i>
                                    <span>${task.entity}</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2 pl-4 border-r border-slate-100 mr-4">
                                <span class="text-[10px] font-bold px-2 py-1 rounded ${statusBadge}">${task.status}</span>
                                <div class="w-6 h-6 rounded-full border border-slate-200 flex items-center justify-center text-slate-300" title="لم يتم التوقيع">
                                    <i data-lucide="pen-tool" class="w-3 h-3"></i>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });
                lucide.createIcons();
            }

            emptyState.classList.add('hidden');
            container.classList.remove('hidden');
        }

        function animateValue(id, end) {
            document.getElementById(id).innerText = end;
        }
    </script>
</body>
</html>
