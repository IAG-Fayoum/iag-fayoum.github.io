<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة المتابعة - IAG</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Cairo', sans-serif; 
      background: #f8f9fa;
      padding-bottom: 80px;
    }
    
    /* Side Navigation */
    .sidebar {
      position: fixed;
      right: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.05);
      z-index: 100;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }
    
    .sidebar.hidden { transform: translateX(100%); }
    
    .sidebar-logo {
      padding: 24px;
      border-bottom: 1px solid #e9ecef;
      background: linear-gradient(135deg, #0f766e 0%, #115e59 100%);
      color: white;
    }
    
    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 24px;
      color: #495057;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
      border-right: 3px solid transparent;
    }
    
    .sidebar-item:hover {
      background: #f8f9fa;
      border-right-color: #0f766e;
      color: #0f766e;
    }
    
    .sidebar-item.active {
      background: #e6f7f5;
      border-right-color: #0f766e;
      color: #0f766e;
    }
    
    /* Main Content */
    .main-content {
      margin-right: 260px;
      padding: 24px;
    }
    
    /* Stat Cards */
    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      transition: all 0.3s ease;
      border: 1px solid #e9ecef;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    
    .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    
    /* Status Pills */
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .status-new { background: #e7f5ff; color: #1971c2; }
    .status-progress { background: #fff3cd; color: #997404; }
    .status-approved { background: #d3f9d8; color: #2f9e44; }
    .status-done { background: #e5dbff; color: #5f3dc4; }
    .status-overdue { background: #ffe3e3; color: #c92a2a; }
    .status-followup { background: #ffdeeb; color: #a61e4d; }
    
    /* Table */
    .data-table {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }
    
    thead {
      background: #f8f9fa;
    }
    
    th {
      padding: 16px;
      text-align: right;
      font-weight: 700;
      font-size: 0.875rem;
      color: #495057;
      border-bottom: 2px solid #e9ecef;
    }
    
    td {
      padding: 16px;
      border-bottom: 1px solid #f1f3f5;
      color: #495057;
      font-size: 0.875rem;
    }
    
    tbody tr:hover {
      background: #f8f9fa;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e9ecef;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      z-index: 50;
      display: none;
    }
    
    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px;
      color: #868e96;
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 600;
      transition: color 0.2s ease;
    }
    
    .bottom-nav-item.active {
      color: #0f766e;
    }
    
    .bottom-nav-item:hover {
      color: #0f766e;
    }
    
    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .sidebar { transform: translateX(100%); }
      .sidebar.active { transform: translateX(0); }
      .main-content { margin-right: 0; }
      .bottom-nav { display: flex; }
      body { padding-bottom: 70px; }
      
      .mobile-header {
        background: white;
        padding: 16px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 40;
      }
    }
    
    @media (min-width: 1025px) {
      .mobile-header { display: none; }
      .menu-toggle { display: none; }
    }
    
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 90;
      display: none;
    }
    
    .overlay.active { display: block; }
    
    /* Loading */
    #loading {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e9ecef;
      border-top-color: #0f766e;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="loading" class="hidden">
    <div class="spinner"></div>
  </div>

  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <div class="mobile-header">
    <button onclick="toggleSidebar()" class="p-2">
      <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
    </button>
    <h1 class="text-lg font-bold text-gray-800">لوحة المتابعة</h1>
    <button onclick="toggleFilters()" class="p-2">
      <i data-lucide="filter" class="w-6 h-6 text-gray-700"></i>
    </button>
  </div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <h2 class="text-xl font-bold mb-1">IAG System</h2>
      <p class="text-sm opacity-90">إدارة الحوكمة</p>
    </div>
    
    <nav class="py-4">
      <a href="index.html" class="sidebar-item">
        <i data-lucide="home" class="w-5 h-5"></i>
        <span>الرئيسية</span>
      </a>
      
      <a href="distribution.html" class="sidebar-item active">
        <i data-lucide="pie-chart" class="w-5 h-5"></i>
        <span>Dashboard</span>
      </a>
      
      <a href="forms.html" class="sidebar-item">
        <i data-lucide="file-text" class="w-5 h-5"></i>
        <span>النماذج الإلكترونية</span>
      </a>
      
      <a href="employee.html" class="sidebar-item">
        <i data-lucide="briefcase" class="w-5 h-5"></i>
        <span>خدمات الموظفين</span>
      </a>
      
      <a href="coordinator.html" class="sidebar-item">
        <i data-lucide="users" class="w-5 h-5"></i>
        <span>المنسقين</span>
      </a>
      
      <a href="admin.html" class="sidebar-item">
        <i data-lucide="settings" class="w-5 h-5"></i>
        <span>لوحة الإدارة</span>
      </a>
    </nav>
  </aside>

  <main class="main-content">
    
    <div class="mb-6" style="display: none;" id="filter-panel">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
        <h3 class="font-bold text-gray-800 mb-4">تصفية البيانات</h3>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">السنة</label>
            <select id="filter-year" class="w-full px-4 py-2 border border-gray-300 rounded-lg font-semibold focus:border-teal-600 focus:outline-none">
              <option value="">الكل</option>
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
              <option value="2027">2027</option>
              <option value="2028">2028</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">الفترة</label>
            <select id="filter-period" class="w-full px-4 py-2 border border-gray-300 rounded-lg font-semibold focus:border-teal-600 focus:outline-none">
              <option value="">السنة كاملة</option>
              <option value="Q1">الربع الأول</option>
              <option value="Q2">الربع الثاني</option>
              <option value="Q3">الربع الثالث</option>
              <option value="Q4">الربع الرابع</option>
            </select>
          </div>
          <div class="flex items-end">
            <button onclick="applyFilters()" class="w-full bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg font-bold transition">
              تطبيق
            </button>
          </div>
        </div>
      </div>
    </div>

    <h1 class="text-2xl font-bold text-gray-800 mb-6">لوحة المتابعة</h1>

    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">
      <div class="stat-card">
        <div class="stat-icon" style="background: #e7f5ff;">
          <i data-lucide="clipboard-list" class="w-7 h-7" style="color: #1971c2;"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800 mb-1" id="stat-total">0</p>
        <p class="text-sm text-gray-600 font-semibold">الإجمالي</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #e7f5ff;">
          <i data-lucide="circle" class="w-7 h-7" style="color: #1971c2;"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800 mb-1" id="stat-new">0</p>
        <p class="text-sm text-gray-600 font-semibold">لم يتم البدء</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #fff3cd;">
          <i data-lucide="clock" class="w-7 h-7" style="color: #997404;"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800 mb-1" id="stat-progress">0</p>
        <p class="text-sm text-gray-600 font-semibold">قيد المراجعة</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #d3f9d8;">
          <i data-lucide="check-circle" class="w-7 h-7" style="color: #2f9e44;"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800 mb-1" id="stat-approval">0</p>
        <p class="text-sm text-gray-600 font-semibold">بانتظار اعتماد</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #e5dbff;">
          <i data-lucide="check-check" class="w-7 h-7" style="color: #5f3dc4;"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800 mb-1" id="stat-done">0</p>
        <p class="text-sm text-gray-600 font-semibold">منتهي</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #ffe3e3;">
          <i data-lucide="alert-circle" class="w-7 h-7" style="color: #c92a2a;"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800 mb-1" id="stat-overdue">0</p>
        <p class="text-sm text-gray-600 font-semibold">متأخر</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #ffdeeb;">
          <i data-lucide="bell" class="w-7 h-7" style="color: #a61e4d;"></i>
        </div>
        <p class="text-3xl font-bold text-gray-800 mb-1" id="stat-followup">0</p>
        <p class="text-sm text-gray-600 font-semibold">يحتاج متابعة</p>
      </div>
    </div>

    <div class="data-table">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-800">جميع المهام</h2>
      </div>
      <div class="table-container" id="tasks-container">
        <table>
          <thead>
            <tr>
              <th>رقم القيد</th>
              <th>التاريخ</th>
              <th>الجهة</th>
              <th>الموضوع</th>
              <th>المكلف</th>
              <th>الحالة</th>
            </tr>
          </thead>
          <tbody id="tasks-tbody">
            <tr><td colspan="6" class="text-center py-8 text-gray-400">جارٍ التحميل...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <nav class="bottom-nav">
    <div style="display: flex; width: 100%; justify-content: space-around;">
      <a href="distribution.html" class="bottom-nav-item active">
        <i data-lucide="pie-chart" class="w-6 h-6"></i>
        <span>Dashboard</span>
      </a>
      <a href="forms.html" class="bottom-nav-item">
        <i data-lucide="file-text" class="w-6 h-6"></i>
        <span>النماذج</span>
      </a>
      <a href="employee.html" class="bottom-nav-item">
        <i data-lucide="briefcase" class="w-6 h-6"></i>
        <span>الخدمات</span>
      </a>
      <a href="admin.html" class="bottom-nav-item">
        <i data-lucide="settings" class="w-6 h-6"></i>
        <span>الإدارة</span>
      </a>
    </div>
  </nav>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/auth.js"></script>
  <script>
    lucide.createIcons();

    // 1. Security: Check Session with correct redirect
    const user = auth.checkSession();
    if (!user) {
      // Security Fix: Prevent back button usage
      window.location.replace('index.html');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
      document.getElementById('overlay').classList.toggle('active');
    }

    function toggleFilters() {
      document.getElementById('filter-panel').style.display = 
        document.getElementById('filter-panel').style.display === 'none' ? 'block' : 'none';
    }

    // 2. Helper: Sanitization for Table Data
    function escapeHtml(text) {
      if (!text) return '';
      return text.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function getStatusClass(status) {
      if (!status) return 'status-new';
      const s = status.trim();
      if (s.includes('لم يتم البدء')) return 'status-new';
      else if (s.includes('قيد المراجعة') || s.includes('جاري')) return 'status-progress';
      else if (s.includes('بانتظار الاعتماد')) return 'status-approved';
      else if (s.includes('تم الاعتماد') || s.includes('منتهي')) return 'status-done';
      else if (s.includes('متأخر')) return 'status-overdue';
      else if (s.includes('بحاجة إلى متابعة')) return 'status-followup';
      return 'status-new';
    }

    async function loadDashboard() {
      document.getElementById('loading').classList.remove('hidden');

      const year = document.getElementById('filter-year').value;

      try {
        const result = await auth.apiCall('getAllData', {
          role: 'مدير',
          name: 'Dashboard',
          startDate: year ? `${year}-01-01` : '2024-01-01',
          endDate: year ? `${year}-12-31` : '2028-12-31'
        });

        if (result.success) {
          let statusCount = { new: 0, progress: 0, approval: 0, done: 0, overdue: 0, followup: 0 };

          result.tasks.forEach(task => {
            const s = (task.status || '').trim();
            if (s.includes('لم يتم البدء')) statusCount.new++;
            else if (s.includes('قيد المراجعة') || s.includes('جاري')) statusCount.progress++;
            else if (s.includes('بانتظار الاعتماد')) statusCount.approval++;
            else if (s.includes('تم الاعتماد') || s.includes('منتهي') || s.includes('أرشيف')) statusCount.done++;
            else if (s.includes('متأخر')) statusCount.overdue++;
            else if (s.includes('بحاجة إلى متابعة')) statusCount.followup++;
          });

          document.getElementById('stat-total').textContent = result.stats.totals.total || 0;
          document.getElementById('stat-new').textContent = statusCount.new;
          document.getElementById('stat-progress').textContent = statusCount.progress;
          document.getElementById('stat-approval').textContent = statusCount.approval;
          document.getElementById('stat-done').textContent = statusCount.done;
          document.getElementById('stat-overdue').textContent = statusCount.overdue;
          document.getElementById('stat-followup').textContent = statusCount.followup;

          const tbody = document.getElementById('tasks-tbody');
          if (result.tasks && result.tasks.length > 0) {
            tbody.innerHTML = result.tasks.map(task => `
              <tr>
                <td><span class="font-bold text-teal-700">${escapeHtml(task.id)}</span></td>
                <td class="text-gray-600">${escapeHtml(task.date)}</td>
                <td class="font-semibold">${escapeHtml(task.entity)}</td>
                <td>${escapeHtml(task.subject)}</td>
                <td class="text-gray-600">${escapeHtml(task.assignee)}</td>
                <td><span class="status-pill ${getStatusClass(task.status || '')}">${escapeHtml(task.status || 'جديد')}</span></td>
              </tr>
            `).join('');
          } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">لا توجد مهام</td></tr>';
          }
        }
      } catch (err) {
        console.error("Dashboard Load Error:", err);
        document.getElementById('tasks-tbody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-400">خطأ في تحميل البيانات</td></tr>';
      } finally {
        document.getElementById('loading').classList.add('hidden');
        lucide.createIcons();
      }
    }

    function applyFilters() {
      loadDashboard();
      toggleFilters();
    }

    loadDashboard();
  </script>
</body>
</html>
