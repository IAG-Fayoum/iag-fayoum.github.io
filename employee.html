<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f766e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>مهامي | نظام الحوكمة</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #0f766e; --bg: #f3f4f6; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        
        /* Header */
        .header-bg { background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; padding-bottom: 3rem; }
        
        /* Interactive Stats Cards */
        .stat-card { transition: all 0.2s ease; cursor: pointer; border: 2px solid transparent; }
        .stat-card:active { transform: scale(0.96); }
        .stat-card.active { border-color: var(--primary); background-color: #f0fdfa; box-shadow: 0 4px 12px rgba(15, 118, 110, 0.15); }
        .stat-card.active .num { color: var(--primary); }

        /* Tabs */
        .tab-btn { border-bottom: 3px solid transparent; color: #64748b; font-weight: 700; padding: 10px 0; transition: 0.3s; }
        .tab-btn.active { border-color: var(--primary); color: var(--primary); }

        /* Task Card */
        .task-card { background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #e5e7eb; overflow: hidden; transition: 0.2s; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.05); }
        
        /* Smart Buttons */
        .btn-action { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; transition: 0.2s; }
        .btn-doc { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; } /* Google Doc Blue */
        .btn-att { background: #f0fdfa; color: #0f766e; border: 1px solid #ccfbf1; } /* Attachment Teal */
        .btn-details { background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; } /* Details Gray */

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="sidebar-overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/50 z-40 hidden"></div>
    <aside id="sidebar" class="fixed top-0 right-[-280px] w-[280px] h-full bg-white z-50 transition-all duration-300 flex flex-col shadow-2xl">
        <div class="p-6 bg-teal-50 text-center border-b border-teal-100">
            <div class="w-16 h-16 mx-auto bg-white rounded-full flex items-center justify-center shadow-sm mb-2 text-teal-700">
                <i data-lucide="user" class="w-8 h-8"></i>
            </div>
            <h3 class="font-bold text-teal-900" id="menu-name">...</h3>
            <p class="text-xs text-teal-600" id="menu-role">...</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="employee.html" class="flex items-center gap-3 p-3 rounded-lg bg-teal-600 text-white font-bold text-sm"><i data-lucide="list-todo" class="w-5 h-5"></i> مهامي</a>
            <a href="distribution.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 text-gray-700 font-bold text-sm"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> المؤشرات</a>
            <a href="forms.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 text-gray-700 font-bold text-sm"><i data-lucide="file-text" class="w-5 h-5"></i> النماذج</a>
            <a href="notifications.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 text-gray-700 font-bold text-sm"><i data-lucide="bell" class="w-5 h-5"></i> الإشعارات</a>
        </nav>
        <div class="p-4 border-t">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 p-3 text-red-600 font-bold bg-red-50 rounded-lg text-sm"><i data-lucide="log-out" class="w-4 h-4"></i> خروج</button>
        </div>
    </aside>

    <header class="header-bg text-white pt-4 px-4">
        <div class="flex justify-between items-center mb-4">
            <button onclick="toggleMenu()" class="p-2 bg-white/20 rounded-full hover:bg-white/30"><i data-lucide="menu" class="w-6 h-6"></i></button>
            <div class="text-center">
                <h1 class="font-bold text-lg">إدارة المراجعة الداخلية</h1>
                <p class="text-[10px] opacity-80">Internal Audit & Governance</p>
            </div>
            <button onclick="window.location.href='notifications.html'" class="p-2 bg-white/20 rounded-full hover:bg-white/30 relative">
                <i data-lucide="bell" class="w-6 h-6"></i>
                <span id="notif-badge" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-teal-800 hidden"></span>
            </button>
        </div>
        
        <div class="flex items-center gap-3 bg-white/10 p-3 rounded-xl border border-white/20 backdrop-blur-sm">
            <div class="w-10 h-10 rounded-full bg-white text-teal-700 flex items-center justify-center font-bold shadow-sm">
                <i data-lucide="user" class="w-5 h-5"></i>
            </div>
            <div>
                <h2 class="font-bold text-sm" id="header-name">...</h2>
                <p class="text-[10px] text-teal-100" id="header-job">...</p>
            </div>
        </div>
    </header>

    <div class="px-4 -mt-8 relative z-10 max-w-lg mx-auto">
        
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="bg-white p-3 rounded-xl shadow-sm text-center stat-card" onclick="filterByStat('all', this)" id="card-all">
                <span class="block text-2xl font-extrabold text-slate-700 mb-1" id="count-total">0</span>
                <span class="text-xs font-bold text-gray-500">المهام الكلية</span>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm text-center stat-card border-r-4 border-r-red-500" onclick="filterByStat('late', this)" id="card-late">
                <span class="block text-2xl font-extrabold text-red-600 mb-1" id="count-late">0</span>
                <span class="text-xs font-bold text-red-400">متأخر</span>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-2">
            <div class="bg-white p-2 rounded-lg shadow-sm text-center stat-card" onclick="filterByStat('new', this)" id="card-new">
                <span class="block text-lg font-bold text-blue-600" id="count-new">0</span>
                <span class="text-[10px] text-gray-400">جديد</span>
            </div>
            <div class="bg-white p-2 rounded-lg shadow-sm text-center stat-card" onclick="filterByStat('progress', this)" id="card-progress">
                <span class="block text-lg font-bold text-amber-500" id="count-progress">0</span>
                <span class="text-[10px] text-gray-400">تنفيذ</span>
            </div>
            <div class="bg-white p-2 rounded-lg shadow-sm text-center stat-card" onclick="filterByStat('pending', this)" id="card-pending">
                <span class="block text-lg font-bold text-gray-600" id="count-pending">0</span>
                <span class="text-[10px] text-gray-400">انتظار</span>
            </div>
            <div class="bg-white p-2 rounded-lg shadow-sm text-center stat-card" onclick="filterByStat('done', this)" id="card-done">
                <span class="block text-lg font-bold text-emerald-600" id="count-done">0</span>
                <span class="text-[10px] text-gray-400">معتمد</span>
            </div>
        </div>
    </div>

    <div class="px-4 mt-6 max-w-lg mx-auto">
        <div class="flex border-b border-gray-200 mb-4">
            <button onclick="switchTab('tasks')" id="tab-tasks" class="tab-btn flex-1 active">المهام الحالية</button>
            <button onclick="switchTab('archive')" id="tab-archive" class="tab-btn flex-1">أرشيف التقارير</button>
        </div>

        <div id="view-tasks" class="space-y-3">
            <div class="relative mb-3">
                <input type="text" id="search-input" placeholder="بحث في الموضوع أو الجهة..." class="w-full pl-3 pr-10 py-3 rounded-xl border border-gray-200 text-sm focus:outline-none focus:border-teal-500 shadow-sm" oninput="applyFilters()">
                <i data-lucide="search" class="absolute right-3 top-3.5 w-4 h-4 text-gray-400"></i>
            </div>
            
            <div id="tasks-list" class="pb-20">
                <div class="text-center py-10 text-gray-400"><div class="animate-spin w-6 h-6 border-2 border-teal-600 border-t-transparent rounded-full mx-auto mb-2"></div>جاري التحميل...</div>
            </div>
        </div>

        <div id="view-archive" class="hidden space-y-3">
            <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-700 mb-2 border border-blue-100">
                <i data-lucide="info" class="w-3 h-3 inline mb-0.5"></i> هنا تجد جميع التقارير التي تم الانتهاء منها واعتمادها.
            </div>
            <div id="archive-list" class="pb-20"></div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800">تفاصيل المعاملة</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-gray-200 rounded-full"><i data-lucide="x" class="w-5 h-5 text-gray-500"></i></button>
            </div>
            <div class="p-5 overflow-y-auto" id="modal-body"></div>
        </div>
    </div>

    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around py-2 z-40 md:hidden pb-[env(safe-area-inset-bottom)]">
        <a href="employee.html" class="flex flex-col items-center gap-1 w-16 text-teal-600">
            <i data-lucide="list-todo" class="w-5 h-5"></i><span class="text-[10px] font-bold">مهامي</span>
        </a>
        <a href="distribution.html" class="flex flex-col items-center gap-1 w-16 text-gray-400 hover:text-teal-600">
            <i data-lucide="bar-chart-2" class="w-5 h-5"></i><span class="text-[10px] font-bold">مؤشرات</span>
        </a>
        <a href="forms.html" class="flex flex-col items-center gap-1 w-16 text-gray-400 hover:text-teal-600">
            <i data-lucide="file-text" class="w-5 h-5"></i><span class="text-[10px] font-bold">نماذج</span>
        </a>
    </nav>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        lucide.createIcons();
        
        let allTasks = [];
        let currentStatusFilter = 'all'; // all, new, late, progress, pending, done

        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('iag_user');
            if (!userStr) { window.location.href = 'index.html'; return; }
            const user = JSON.parse(userStr);

            // Setup User Info
            document.getElementById('header-name').textContent = user.name;
            document.getElementById('header-job').textContent = user.jobTitle || 'موظف';
            document.getElementById('menu-name').textContent = user.name;
            document.getElementById('menu-role').textContent = user.role;

            await loadData(user.name);
            
            // Set Default Active Card
            document.getElementById('card-all').classList.add('active');
        });

        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if(sidebar.style.right === '0px') {
                sidebar.style.right = '-280px'; overlay.classList.add('hidden');
            } else {
                sidebar.style.right = '0px'; overlay.classList.remove('hidden');
            }
        }

        function logout() { localStorage.removeItem('iag_user'); window.location.href = 'index.html'; }

        async function loadData(username) {
            try {
                const res = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getAllData', role: 'موظف', name: username })
                });
                const data = await res.json();
                
                if(data.success) {
                    allTasks = data.tasks || [];
                    calculateStats();
                    applyFilters();
                    renderArchive(data.reports || []); // التقارير المنتهية
                } else {
                    document.getElementById('tasks-list').innerHTML = '<div class="text-center py-10 text-red-500">خطأ في جلب البيانات</div>';
                }
            } catch(e) {
                console.error(e);
                document.getElementById('tasks-list').innerHTML = '<div class="text-center py-10 text-red-500">تأكد من الاتصال بالإنترنت</div>';
            }
        }

        // --- Logic: Statistics & Filtering ---
        function calculateStats() {
            // Calculate stats dynamically from the tasks array
            const counts = {
                total: allTasks.length,
                late: allTasks.filter(t => t.status.includes('متأخر')).length,
                new: allTasks.filter(t => t.status.includes('جديد') || t.status.includes('لم يتم')).length,
                progress: allTasks.filter(t => t.status.includes('جاري') || t.status.includes('قيد')).length,
                pending: allTasks.filter(t => t.status.includes('بانتظار')).length,
                done: allTasks.filter(t => t.status.includes('تم') || t.status.includes('منتهي') || t.status.includes('أرشيف')).length
            };

            // Update UI
            document.getElementById('count-total').innerText = counts.total;
            document.getElementById('count-late').innerText = counts.late;
            document.getElementById('count-new').innerText = counts.new;
            document.getElementById('count-progress').innerText = counts.progress;
            document.getElementById('count-pending').innerText = counts.pending;
            document.getElementById('count-done').innerText = counts.done;
        }

        function filterByStat(filterType, cardElement) {
            // UI Update
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            cardElement.classList.add('active');

            // Logic Update
            currentStatusFilter = filterType;
            applyFilters();
        }

        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            
            const filtered = allTasks.filter(t => {
                // 1. Status Filter
                let statusMatch = true;
                if(currentStatusFilter === 'late') statusMatch = t.status.includes('متأخر');
                else if(currentStatusFilter === 'new') statusMatch = (t.status.includes('جديد') || t.status.includes('لم يتم'));
                else if(currentStatusFilter === 'progress') statusMatch = (t.status.includes('جاري') || t.status.includes('قيد'));
                else if(currentStatusFilter === 'pending') statusMatch = t.status.includes('بانتظار');
                else if(currentStatusFilter === 'done') statusMatch = (t.status.includes('تم') || t.status.includes('منتهي'));
                
                if(!statusMatch) return false;

                // 2. Search Filter
                if(search && !(t.subject + t.source + t.id).toLowerCase().includes(search)) return false;

                return true;
            });

            renderTasks(filtered);
        }

        // --- Rendering ---
        function renderTasks(tasks) {
            const container = document.getElementById('tasks-list');
            if(tasks.length === 0) {
                container.innerHTML = `
                <div class="text-center py-12">
                    <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                        <i data-lucide="clipboard-list" class="w-8 h-8"></i>
                    </div>
                    <p class="text-gray-500 font-bold">لا توجد مهام مطابقة</p>
                </div>`;
                lucide.createIcons();
                return;
            }

            container.innerHTML = tasks.map(t => {
                // Colors based on status
                let borderLeft = 'border-l-gray-400';
                let statusColor = 'text-gray-500 bg-gray-100';
                
                if(t.status.includes('جديد')) { borderLeft = 'border-l-blue-500'; statusColor = 'text-blue-700 bg-blue-50'; }
                else if(t.status.includes('متأخر')) { borderLeft = 'border-l-red-500'; statusColor = 'text-red-700 bg-red-50'; }
                else if(t.status.includes('جاري')) { borderLeft = 'border-l-amber-500'; statusColor = 'text-amber-700 bg-amber-50'; }
                else if(t.status.includes('تم')) { borderLeft = 'border-l-emerald-500'; statusColor = 'text-emerald-700 bg-emerald-50'; }

                // Check for Smart Buttons availability
                const hasDoc = t.report || t.docLink; // Google Doc Link
                const hasAtt = t.attachment; // Original Attachment

                return `
                <div class="task-card mb-3 border-l-[5px] ${borderLeft} fade-in">
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-500">#${t.id}</span>
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded ${statusColor}">${t.status}</span>
                        </div>
                        <h4 class="font-bold text-gray-800 text-sm mb-3 leading-relaxed">${t.subject}</h4>
                        
                        <div class="flex flex-wrap gap-4 text-xs text-gray-500 mb-3">
                            <div class="flex items-center gap-1.5"><i data-lucide="building-2" class="w-3.5 h-3.5"></i> ${t.source}</div>
                            <div class="flex items-center gap-1.5 text-red-600 font-medium"><i data-lucide="calendar-clock" class="w-3.5 h-3.5"></i> الموعد: ${t.deadline}</div>
                        </div>

                        <div class="grid grid-cols-${(hasDoc && hasAtt) ? '3' : '2'} gap-2 pt-2 border-t border-gray-100">
                            
                            <button onclick="openModalDetails('${t.id}')" class="btn-action btn-details">
                                <i data-lucide="eye" class="w-3.5 h-3.5"></i> التفاصيل
                            </button>

                            ${hasAtt ? `
                            <a href="${t.attachment}" target="_blank" class="btn-action btn-att">
                                <i data-lucide="paperclip" class="w-3.5 h-3.5"></i> المرفقات
                            </a>` : ''}

                            ${hasDoc ? `
                            <a href="${t.report || t.docLink}" target="_blank" class="btn-action btn-doc">
                                <i data-lucide="file-edit" class="w-3.5 h-3.5"></i> تعديل التقرير
                            </a>` : ''}
                            
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function renderArchive(reports) {
            const container = document.getElementById('archive-list');
            if(reports.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-400">الأرشيف فارغ</div>';
                return;
            }
            container.innerHTML = reports.map(r => `
                <div class="bg-white p-4 rounded-xl border border-gray-200 mb-3 shadow-sm flex items-center justify-between">
                    <div>
                        <h4 class="font-bold text-gray-800 text-sm mb-1">${r.title || r.type}</h4>
                        <p class="text-xs text-gray-500">${r.date} - ${r.entity}</p>
                    </div>
                    <a href="${r.pdfLink || r.docLink}" target="_blank" class="p-2 bg-teal-50 text-teal-700 rounded-lg hover:bg-teal-100">
                        <i data-lucide="download" class="w-5 h-5"></i>
                    </a>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- Tabs & Modal Logic ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+tabId).classList.add('active');
            
            document.getElementById('view-tasks').classList.add('hidden');
            document.getElementById('view-archive').classList.add('hidden');
            document.getElementById('view-'+tabId).classList.remove('hidden');
        }

        function openModalDetails(id) {
            const task = allTasks.find(t => t.id === id);
            if(!task) return;

            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div class="space-y-4 text-sm">
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-500">رقم القيد</span>
                        <span class="font-mono font-bold">${task.id}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs mb-1">الموضوع</span>
                        <p class="font-bold text-gray-800">${task.subject}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><span class="text-gray-500 text-xs block">الجهة الواردة</span><span class="font-bold">${task.source}</span></div>
                        <div><span class="text-gray-500 text-xs block">تاريخ الورود</span><span class="font-bold">${task.date}</span></div>
                        <div><span class="text-gray-500 text-xs block">نوع المعاملة</span><span class="font-bold">${task.transactionType || '-'}</span></div>
                        <div><span class="text-red-500 text-xs block">الموعد النهائي</span><span class="font-bold text-red-600">${task.deadline}</span></div>
                    </div>
                    ${task.notes ? `
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-xs">
                        <strong class="text-yellow-700 block mb-1">ملاحظات:</strong>
                        ${task.notes}
                    </div>` : ''}
                </div>
            `;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }
    </script>
</body>
</html>
