<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title>Ù…Ù‡Ø§Ù…ÙŠ | Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</title>
    <link rel="icon" href="assets/icons/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        :root { --primary: #047857; } body { font-family: 'Cairo', sans-serif; background: #f8fafc; padding-bottom: 80px; }
        .task-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 12px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal.open { display: flex; }
        @media(min-width:1024px){ body{padding-right:260px} .sidebar{transform:translateX(0)!important} .mobile-nav{display:none} }
    </style>
</head>
<body>
    <aside class="sidebar fixed top-0 right-0 h-full bg-white w-64 shadow-lg border-l border-gray-100 transition-transform translate-x-full lg:translate-x-0 z-50 flex flex-col">
        <div class="p-6 border-b flex items-center gap-3">
            <div class="w-10 h-10 bg-teal-50 rounded flex items-center justify-center text-[#047857]"><i data-lucide="shield-check"></i></div>
            <div><h1 class="font-bold text-lg">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</h1><p class="text-xs text-gray-500">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p></div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="distribution.html" class="flex gap-3 px-4 py-3 text-gray-600 hover:bg-teal-50 rounded font-bold"><i data-lucide="layout-grid"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="employee.html" class="flex gap-3 px-4 py-3 bg-[#047857] text-white rounded font-bold shadow"><i data-lucide="briefcase"></i> Ù…Ù‡Ø§Ù…ÙŠ</a>
            <a href="forms.html" class="flex gap-3 px-4 py-3 text-gray-600 hover:bg-teal-50 rounded font-bold"><i data-lucide="file-text"></i> Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</a>
        </nav>
        <div class="p-4 border-t"><button onclick="auth.logout()" class="flex gap-2 text-red-500 font-bold"><i data-lucide="log-out"></i> Ø®Ø±ÙˆØ¬</button></div>
    </aside>

    <main class="p-4 lg:p-8 max-w-4xl mx-auto">
        <h2 class="text-xl font-bold text-slate-800 mb-4">Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù…ÙŠ</h2>
        <div id="my-tasks" class="space-y-4">
            <div class="text-center py-10 text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù‡Ø§Ù…Ùƒ...</div>
        </div>
    </main>

    <div id="update-modal" class="modal">
        <div class="bg-white p-6 rounded-xl w-96 max-w-full m-4 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</h3>
            <input type="hidden" id="m-id">
            <div class="space-y-3">
                <select id="m-status" class="w-full border p-2 rounded"><option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option>ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</option><option>Ù…ØªØ£Ø®Ø±</option></select>
                <input type="text" id="m-link" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø¯ / Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="w-full border p-2 rounded">
                <button onclick="saveUpdate()" class="w-full bg-[#047857] text-white py-2 rounded font-bold">Ø­ÙØ¸</button>
                <button onclick="closeModal()" class="w-full text-gray-500 py-2">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <nav class="mobile-nav fixed bottom-0 w-full bg-white border-t flex justify-around p-2 z-40 lg:hidden shadow-lg">
        <a href="distribution.html" class="text-gray-400 flex flex-col items-center text-[10px]"><i data-lucide="layout-grid" class="w-6"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="employee.html" class="text-[#047857] flex flex-col items-center text-[10px] font-bold"><i data-lucide="briefcase" class="w-6"></i>Ù…Ù‡Ø§Ù…ÙŠ</a>
        <a href="forms.html" class="text-gray-400 flex flex-col items-center text-[10px]"><i data-lucide="file-text" class="w-6"></i>Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</a>
    </nav>

    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        lucide.createIcons();
        let currentTasks = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const user = auth.checkAuth();
            if(!user) return;

            const res = await auth.callAPI('getAllData', { role: 'employee', name: user.name, startDate: `${new Date().getFullYear()}-01-01` });
            if(res.success) {
                currentTasks = res.tasks;
                renderTasks(currentTasks);
            }
        });

        function renderTasks(tasks) {
            const container = document.getElementById('my-tasks');
            if(!tasks.length) return container.innerHTML = '<div class="text-center py-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</div>';

            container.innerHTML = tasks.map(t => `
                <div class="task-card border-l-4 ${t.status.includes('ØªÙ…')?'border-l-green-500':'border-l-blue-500'}">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-gray-500 text-xs">#${t.id}</span>
                        <span class="text-xs bg-gray-100 px-2 rounded">${t.status}</span>
                    </div>
                    <h3 class="font-bold text-slate-800 mb-2">${t.subject}</h3>
                    <div class="text-xs text-gray-500 mb-3 flex gap-3">
                        <span>ğŸ“¥ ${t.source}</span>
                        <span>ğŸ“… ${t.deadline||t.date}</span>
                    </div>
                    <div class="flex justify-end gap-2 border-t pt-2 mt-2">
                        ${t.attachment ? `<a href="${t.attachment}" target="_blank" class="text-xs bg-gray-50 border px-3 py-1 rounded text-green-700 font-bold">Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒÙ„ÙŠÙ</a>` : ''}
                        <button onclick="openModal('${t.id}')" class="text-xs bg-[#047857] text-white px-3 py-1 rounded font-bold">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
                    </div>
                </div>
            `).join('');
        }

        function openModal(id) { document.getElementById('m-id').value = id; document.getElementById('update-modal').classList.add('open'); }
        function closeModal() { document.getElementById('update-modal').classList.remove('open'); }
        
        async function saveUpdate() {
            const id = document.getElementById('m-id').value;
            const sts = document.getElementById('m-status').value;
            // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† Ù†Ø¶ÙŠÙ Ù„ÙˆØ¬ÙŠÙƒ Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ùˆ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø¨ÙŠØ¯Ø¹Ù…Ù‡
            const res = await auth.callAPI('updateStatus', { taskId: id, newStatus: sts, user: auth.currentUser.name });
            if(res.success) alert('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«'), location.reload();
        }
    </script>
</body>
</html>
