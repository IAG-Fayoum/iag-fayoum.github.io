<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØµÙØ­ØªÙŠ - IAG</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <style>
    /* Basic Reset & Styles ensuring consistency */
    body { font-family: 'Cairo', sans-serif; background: #f8f9fa; margin: 0; }
    
    .sidebar { position: fixed; right: 0; top: 0; width: 260px; height: 100vh; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.08); z-index: 100; overflow-y: auto; }
    .sidebar-logo { padding: 24px; background: linear-gradient(135deg, #0f766e, #115e59); color: white; }
    .sidebar-item { display: flex; align-items: center; gap: 12px; padding: 14px 24px; color: #495057; text-decoration: none; font-weight: 600; transition: all 0.2s; border-right: 3px solid transparent; }
    .sidebar-item:hover, .sidebar-item.active { background: #e6f7f5; border-right-color: #0f766e; color: #0f766e; }
    
    .main-content { margin-right: 260px; padding: 24px; }
    
    .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 24px; }
    .header-card { background: linear-gradient(135deg, #2563eb, #1e40af); color: white; }
    
    .task-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
    .task-card { background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; transition: all 0.2s; }
    .task-card:hover { border-color: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
    
    .task-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .task-id { font-weight: 800; color: #1e293b; }
    .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; }
    .badge-done { background: #dcfce7; color: #166534; }
    .badge-pending { background: #fef3c7; color: #92400e; }
    
    .task-subject { font-weight: 600; color: #334155; margin-bottom: 12px; line-height: 1.5; }
    .task-meta { font-size: 0.85rem; color: #64748b; display: flex; flex-direction: column; gap: 6px; }

    @media (max-width: 1024px) {
      .sidebar { display: none; } /* Simplified for mobile example */
      .main-content { margin-right: 0; }
    }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="sidebar-logo">
      <h2 class="text-xl font-bold mb-2">IAG System</h2>
      <p id="user-name" class="text-sm opacity-90">Ù…Ø±Ø­Ø¨Ø§Ù‹</p>
    </div>
    
    <nav style="padding: 16px 0;">
      <a href="index.html" class="sidebar-item">
        <i data-lucide="home" class="w-5 h-5"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
      </a>
      <a href="distribution.html" class="sidebar-item">
        <i data-lucide="pie-chart" class="w-5 h-5"></i><span>Dashboard</span>
      </a>
      <a href="forms.html" class="sidebar-item">
        <i data-lucide="file-text" class="w-5 h-5"></i><span>Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</span>
      </a>
      <a href="employee.html" class="sidebar-item active" id="employee-link">
        <i data-lucide="briefcase" class="w-5 h-5"></i><span>ØµÙØ­ØªÙŠ</span>
      </a>
      <a href="coordinator.html" class="sidebar-item" id="coordinator-link" style="display: none;">
        <i data-lucide="users" class="w-5 h-5"></i><span>Ø§Ù„Ù…Ù†Ø³Ù‚ÙŠÙ†</span>
      </a>
      <a href="admin.html" class="sidebar-item" id="admin-link" style="display: none;">
        <i data-lucide="settings" class="w-5 h-5"></i><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
      </a>
    </nav>
  </aside>

  <main class="main-content">
    <div class="card header-card">
      <h1 style="font-size: 1.75rem; font-weight: 800;">ØµÙØ­ØªÙŠ</h1>
      <p style="opacity: 0.9; margin-top: 4px;">Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„ØªÙƒÙ„ÙŠÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
    </div>

    <div id="tasks-container">
      <div style="text-align: center; padding: 60px; color: #94a3b8;">
        <div style="font-size: 2rem; margin-bottom: 12px;">â³</div>
        <p style="font-weight: 600;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...</p>
      </div>
    </div>
  </main>

  <script src="assets/js/config.js"></script>
  <script src="assets/js/auth.js"></script>
  <script>
    // 1. Security & Auth Check
    const user = auth.checkSession();
    if (!user) {
      window.location.replace('index.html');
    }
    
    // 2. Role Based Display
    if (['Ù…ÙˆØ¸Ù', 'Employee', 'Ù…Ø¯ÙŠØ±', 'Admin', 'Ù…Ù†Ø³Ù‚', 'Coordinator'].includes(user.role)) {
      document.getElementById('user-name').textContent = user.name + ' ğŸ‘‹';
      
      // Toggle Links
      if (user.role === 'Ù…Ù†Ø³Ù‚' || user.role === 'Coordinator') document.getElementById('coordinator-link').style.display = 'flex';
      if (user.role === 'Ù…Ø¯ÙŠØ±' || user.role === 'Admin') {
        document.getElementById('coordinator-link').style.display = 'flex';
        document.getElementById('admin-link').style.display = 'flex';
      }
    } else {
      alert('ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„');
      window.location.replace('index.html');
    }

    lucide.createIcons();

    // 3. Helper: Sanitize Output (XSS Protection)
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // 4. Load Data
    loadTasks();

    async function loadTasks() {
      try {
        // Use 'Employee' role specifically to get assigned tasks
        const result = await auth.apiCall('getEmployeeData', { name: user.name });
        
        if (result.success) {
          displayTasks(result.tasks);
        } else {
          throw new Error(result.error || 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
      } catch (err) {
        document.getElementById('tasks-container').innerHTML = `
          <div style="text-align: center; padding: 60px; color: #dc2626;">
            <div style="font-size: 3rem; margin-bottom: 12px;">âŒ</div>
            <p style="font-weight: 700;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…</p>
            <p style="font-size: 0.9rem; opacity: 0.8;">${escapeHtml(err.message)}</p>
            <button onclick="loadTasks()" style="margin-top:16px; padding:8px 16px; cursor:pointer;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
          </div>
        `;
      }
    }

    function displayTasks(tasks) {
      if (!tasks || tasks.length === 0) {
        document.getElementById('tasks-container').innerHTML = `
          <div style="text-align: center; padding: 60px; color: #94a3b8;">
            <div style="font-size: 3rem; margin-bottom: 12px;">ğŸ‰</div>
            <p style="font-weight: 600;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
          </div>
        `;
        return;
      }

      document.getElementById('tasks-container').innerHTML = `
        <div class="card">
          <h2 style="font-weight: 700; margin-bottom: 16px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… (${tasks.length})</h2>
          <div class="task-grid">
            ${tasks.map(t => {
              const status = escapeHtml(t.status || 'Ø¬Ø¯ÙŠØ¯');
              const isDone = status.includes('ØªÙ…') || status.includes('Ù…Ù†ØªÙ‡ÙŠ');
              
              return `
              <div class="task-card">
                <div class="task-header">
                  <div class="task-id">#${escapeHtml(t.id)}</div>
                  <span class="badge ${isDone ? 'badge-done' : 'badge-pending'}">${status}</span>
                </div>
                
                <div class="task-subject">${escapeHtml(t.subject || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}</div>
                
                <div class="task-meta">
                  <div><strong>ğŸ“¥ Ø§Ù„Ø¬Ù‡Ø©:</strong> ${escapeHtml(t.entity || t.source || '-')}</div>
                  <div><strong>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${escapeHtml(t.date || '-')}</div>
                  ${t.attachment ? `<div style="margin-top:4px;"><a href="${t.attachment}" target="_blank" rel="noopener noreferrer" style="color:#2563eb; text-decoration:underline; font-weight:700;">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚</a></div>` : ''}
                </div>
              </div>
            `}).join('')}
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>
