<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸Ù - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50">

<!-- Header -->
<header class="bg-gradient-to-r from-teal-600 to-teal-700 text-white sticky top-0 z-40 shadow-lg">
    <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 id="emp-name" class="text-lg font-bold">Ø§Ù„Ù…ÙˆØ¸Ù</h1>
                    <p id="emp-role" class="text-xs text-teal-100">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
            
            <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold text-sm transition-all">
                Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </div>
</header>

<!-- Stats Bar -->
<div class="bg-white shadow-md border-b-4 border-teal-500">
    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center">
                <div class="text-3xl font-black text-blue-600" id="stat-new">0</div>
                <div class="text-xs text-slate-600 font-bold mt-1">Ø¬Ø¯ÙŠØ¯</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-black text-amber-600" id="stat-progress">0</div>
                <div class="text-xs text-slate-600 font-bold mt-1">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-black text-red-600" id="stat-late">0</div>
                <div class="text-xs text-slate-600 font-bold mt-1">Ù…ØªØ£Ø®Ø±</div>
            </div>
            <div class="text-center">
                <div class="text-3xl font-black text-emerald-600" id="stat-done">0</div>
                <div class="text-xs text-slate-600 font-bold mt-1">Ù…Ù†Ø¬Ø²</div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container mx-auto px-4 py-8">
    <!-- Tabs -->
    <div class="bg-white rounded-xl shadow-lg p-4 mb-8">
        <div class="flex flex-wrap gap-2">
            <button id="tab-btn-new" onclick="switchTab('new')" class="px-6 py-3 rounded-lg font-bold transition-all bg-teal-600 text-white">
                Ø¬Ø¯ÙŠØ¯
            </button>
            <button id="tab-btn-progress" onclick="switchTab('progress')" class="px-6 py-3 rounded-lg font-bold transition-all bg-slate-100 text-slate-600">
                Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
            </button>
            <button id="tab-btn-late" onclick="switchTab('late')" class="px-6 py-3 rounded-lg font-bold transition-all bg-slate-100 text-slate-600">
                Ù…ØªØ£Ø®Ø±
            </button>
            <button id="tab-btn-history" onclick="switchTab('history')" class="px-6 py-3 rounded-lg font-bold transition-all bg-slate-100 text-slate-600">
                Ø§Ù„Ø£Ø±Ø´ÙŠÙ
            </button>
        </div>
    </div>

    <!-- Tasks Container -->
    <div id="tasks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="col-span-full text-center py-12 text-slate-400">
            <i data-lucide="loader" class="w-12 h-12 mx-auto mb-4 animate-spin"></i>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...</p>
        </div>
    </div>

    <!-- Archive Container -->
    <div id="archive-container" class="hidden space-y-8">
        <!-- Completed Tasks -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="check-circle" class="w-5 h-5 text-emerald-600"></i>
                Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©
            </h3>
            <div id="done-tasks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Will be filled by JS -->
            </div>
        </div>

        <!-- Reports -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª
            </h3>
            
            <!-- Filters -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ø³Ù†Ø©</label>
                    <select id="history-year" onchange="applyHistoryFilter()" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <!-- Will be filled by JS -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ø´Ù‡Ø±</label>
                    <select id="history-month" onchange="applyHistoryFilter()" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <!-- Will be filled by JS -->
                    </select>
                </div>
            </div>

            <!-- Reports Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-3 text-right text-xs font-bold text-slate-600">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="p-3 text-right text-xs font-bold text-slate-600">Ø§Ù„Ù†ÙˆØ¹</th>
                            <th class="p-3 text-right text-xs font-bold text-slate-600">Ø§Ù„Ø¬Ù‡Ø©</th>
                            <th class="p-3 text-center text-xs font-bold text-slate-600">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="reports-rows">
                        <!-- Will be filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Loader -->
<div id="loader" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-teal-600 border-t-transparent"></div>
        <p class="text-slate-700 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
</div>

<!-- Scripts -->
<script src="assets/js/core.js"></script>
<script>
let allTasks = [];
let allReports = [];
let currentTab = 'new';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
    // Check auth
    const user = getCurrentUser();
    if (!user) {
        window.location.href = 'index.html';
        return;
    }
    
    document.getElementById('emp-name').textContent = user.name;
    document.getElementById('emp-role').textContent = user.role;
    
    // Fill year/month options
    document.getElementById('history-year').innerHTML = getYearOptions();
    document.getElementById('history-month').innerHTML = getMonthOptions();
    
    // Load data
    await loadEmployeeData();
}

async function loadEmployeeData() {
    const user = getCurrentUser();
    const data = await fetchEmployeeData(user.name);
    
    if (data) {
        allTasks = data.tasks || [];
        allReports = data.reports || [];
        
        updateStats();
        switchTab('new');
    }
}

function updateStats() {
    document.getElementById('stat-new').textContent = allTasks.filter(t => !t.status || t.status === 'Ø¬Ø¯ÙŠØ¯').length;
    document.getElementById('stat-progress').textContent = allTasks.filter(t => t.status && (t.status.includes('Ø¬Ø§Ø±ÙŠ') || t.status.includes('Ù‚ÙŠØ¯'))).length;
    document.getElementById('stat-late').textContent = allTasks.filter(t => t.status && t.status.includes('Ù…ØªØ£Ø®Ø±')).length;
    document.getElementById('stat-done').textContent = allTasks.filter(t => t.status && (t.status.includes('ØªÙ…') || t.status.includes('Ù…Ù†ØªÙ‡ÙŠ'))).length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‘ TABS LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
    currentTab = tab;
    
    // Update buttons
    ['new', 'progress', 'late', 'history'].forEach(t => {
        const btn = document.getElementById(`tab-btn-${t}`);
        if (t === tab) {
            btn.className = 'px-6 py-3 rounded-lg font-bold transition-all bg-teal-600 text-white';
        } else {
            btn.className = 'px-6 py-3 rounded-lg font-bold transition-all bg-slate-100 text-slate-600';
        }
    });
    
    // Show/hide containers
    if (tab === 'history') {
        document.getElementById('tasks-container').classList.add('hidden');
        document.getElementById('archive-container').classList.remove('hidden');
        renderHistory();
    } else {
        document.getElementById('tasks-container').classList.remove('hidden');
        document.getElementById('archive-container').classList.add('hidden');
        renderTasks(tab);
    }
}

function renderTasks(tab) {
    const container = document.getElementById('tasks-container');
    let filtered = [];
    
    if (tab === 'new') {
        filtered = allTasks.filter(t => !t.status || t.status === 'Ø¬Ø¯ÙŠØ¯');
    } else if (tab === 'progress') {
        filtered = allTasks.filter(t => t.status && (t.status.includes('Ø¬Ø§Ø±ÙŠ') || t.status.includes('Ù‚ÙŠØ¯') || t.status.includes('Ù„Ù… ÙŠØªÙ…')));
    } else if (tab === 'late') {
        filtered = allTasks.filter(t => t.status && t.status.includes('Ù…ØªØ£Ø®Ø±'));
    }
    
    if (filtered.length === 0) {
        container.innerHTML = `
        <div class="col-span-full text-center py-12 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">
            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4"></i>
            <p class="font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
        </div>`;
        lucide.createIcons();
        return;
    }
    
    container.innerHTML = '';
    filtered.forEach(task => {
        const borderClass = tab === 'new' ? 'border-r-4 border-blue-500' : (tab === 'late' ? 'border-r-4 border-red-500' : 'border-r-4 border-amber-500');
        const delayBadge = task.delay ? `<span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded font-bold">Ù…ØªØ£Ø®Ø± ${task.delay} ÙŠÙˆÙ…</span>` : '';
        const attachmentBtn = task.attachment ? `<a href="${task.attachment}" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold text-xs flex items-center gap-1"><i data-lucide="paperclip" class="w-4 h-4"></i> Ù…Ø±ÙÙ‚</a>` : '';
        
        container.innerHTML += `
        <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all p-6 ${borderClass}">
            <div class="flex justify-between items-start mb-3">
                <span class="text-xs font-bold text-slate-400">#${task.id}</span>
                <span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-600">${task.status}</span>
            </div>
            
            <h4 class="font-bold text-slate-800 mb-3 text-sm leading-relaxed">${task.subject}</h4>
            
            <div class="space-y-2 text-xs text-slate-600 mb-4">
                <div class="flex items-center gap-2">
                    <i data-lucide="map-pin" class="w-4 h-4 text-teal-600"></i>
                    <span>${task.entity}</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar" class="w-4 h-4 text-teal-600"></i>
                    <span>${task.date}</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="mail" class="w-4 h-4 text-teal-600"></i>
                    <span>${task.source}</span>
                </div>
            </div>
            
            <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                ${delayBadge}
                ${attachmentBtn}
            </div>
        </div>`;
    });
    
    lucide.createIcons();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‚ HISTORY & REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory() {
    // Completed tasks
    const doneTasks = allTasks.filter(t => t.status && (t.status.includes('ØªÙ…') || t.status.includes('Ù…Ù†ØªÙ‡ÙŠ')));
    const doneList = document.getElementById('done-tasks-list');
    
    if (doneTasks.length === 0) {
        doneList.innerHTML = '<p class="text-slate-400 text-sm col-span-full text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ù†Ø¬Ø²Ø©</p>';
    } else {
        doneList.innerHTML = '';
        doneTasks.slice(0, 9).forEach(t => {
            doneList.innerHTML += `
            <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                <h5 class="font-bold text-xs text-slate-800 mb-2 line-clamp-2">${t.subject}</h5>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-500">${t.date}</span>
                    <span class="text-emerald-600 font-bold">âœ“ Ù…Ù†Ø¬Ø²</span>
                </div>
            </div>`;
        });
    }
    
    // Reports
    applyHistoryFilter();
}

function applyHistoryFilter() {
    const year = document.getElementById('history-year').value;
    const month = document.getElementById('history-month').value;
    const tbody = document.getElementById('reports-rows');
    
    const filtered = allReports.filter(r => {
        if (!r.date) return false;
        const parts = r.date.split('/');
        if (parts.length !== 3) return false;
        
        const rYear = parts[2];
        const rMonth = parseInt(parts[1]);
        
        return rYear === year && (month === "" || rMonth === parseInt(month));
    });
    
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</td></tr>';
        return;
    }
    
    tbody.innerHTML = '';
    filtered.forEach(r => {
        let links = '';
        if (r.docLink) links += `<a href="${r.docLink}" target="_blank" class="inline-block bg-blue-100 text-blue-600 px-3 py-1 rounded hover:bg-blue-200 transition-all text-xs font-bold">ğŸ“„ DOC</a> `;
        if (r.pdfLink) links += `<a href="${r.pdfLink}" target="_blank" class="inline-block bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200 transition-all text-xs font-bold">ğŸ“• PDF</a> `;
        if (r.fieldAttachments && r.fieldAttachments.length > 0) {
            links += `<button onclick='showGallery(${JSON.stringify(r.fieldAttachments)})' class="inline-block bg-purple-100 text-purple-600 px-3 py-1 rounded hover:bg-purple-200 transition-all text-xs font-bold">ğŸ“· ${r.fieldAttachments.length}</button>`;
        }
        
        tbody.innerHTML += `
        <tr class="hover:bg-slate-50 border-b border-slate-100">
            <td class="p-3 text-xs font-bold text-slate-600">${r.date}</td>
            <td class="p-3 text-xs text-slate-700">${r.type}</td>
            <td class="p-3 text-xs font-bold text-slate-800">${r.entity}</td>
            <td class="p-3 text-center">${links || '-'}</td>
        </tr>`;
    });
}

function showGallery(images) {
    let html = `
    <div class="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4" onclick="this.remove()">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 max-w-4xl w-full max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">`;
    
    images.forEach(img => {
        html += `<a href="${img}" target="_blank" class="block aspect-square bg-slate-800 rounded-lg overflow-hidden border-2 border-slate-700 bg-cover bg-center hover:scale-105 transition-transform" style="background-image:url('${img}')"></a>`;
    });
    
    html += `</div>
        <button class="absolute top-4 left-4 text-white text-4xl hover:text-red-500 transition-colors">&times;</button>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', html);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    init();
});
</script>

</body>
</html>
