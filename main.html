<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0f766e">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø© - Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„ØµØ­Ø©</title>
  
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="assets/js/api.js"></script>

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
    .theme-gradient { background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); }
    .hidden-section { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Scrollbar Hide */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Cards */
    .stat-card { background: white; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .service-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
    .service-card:active { transform: scale(0.98); background-color: #f0fdfa; }

    /* Bottom Nav */
    @media (max-width: 768px) {
      .desktop-sidebar { display: none !important; }
      .bottom-nav { display: flex !important; position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e2e8f0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); height: calc(65px + env(safe-area-inset-bottom)); }
      .bottom-nav button { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; color: #64748b; border: none; background: transparent; }
      .bottom-nav button.active { color: #0f766e; font-weight: bold; }
      .main-content { padding-bottom: calc(80px + env(safe-area-inset-bottom)); }
    }
    @media (min-width: 769px) { .bottom-nav { display: none !important; } }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <div id="toast-container" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-[100] w-max max-w-[90%]"></div>

  <div class="flex-grow flex h-screen overflow-hidden">
    <aside class="desktop-sidebar w-64 bg-white border-l border-slate-200 flex flex-col shadow-lg z-20 shrink-0">
      <div class="p-6 text-center border-b border-slate-100">
        <h2 class="font-bold text-slate-800">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</h2>
      </div>
      <nav class="flex-grow p-4 space-y-2">
        <button onclick="switchTab('dashboard')" class="w-full flex items-center gap-3 p-3 rounded-lg font-bold bg-teal-50 text-teal-700"><i data-lucide="layout-grid"></i> Dashboard</button>
        <button onclick="switchTab('services')" class="w-full flex items-center gap-3 p-3 rounded-lg text-slate-600 hover:bg-slate-50"><i data-lucide="briefcase"></i> Ø§Ù„Ø®Ø¯Ù…Ø§Øª</button>
        <button onclick="switchTab('employees')" class="w-full flex items-center gap-3 p-3 rounded-lg text-slate-600 hover:bg-slate-50"><i data-lucide="users-2"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        <a href="admin.html" class="w-full flex items-center gap-3 p-3 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-600"><i data-lucide="settings-2"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
      </nav>
    </aside>

    <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative main-content">
      <div class="flex-1 overflow-y-auto no-scrollbar p-4 md:p-6">

        <div id="tab-dashboard" class="fade-in">
          <header class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="activity" class="text-teal-600"></i> Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</h2>
              <p class="text-xs text-slate-500 font-bold mt-1" id="filter-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
            <button onclick="applyFilter()" class="p-2 bg-white rounded-full shadow text-slate-600"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
          </header>

          <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
            <div class="stat-card border-b-4 border-slate-600">
              <p class="text-xs font-bold text-slate-400">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</p>
              <h3 id="v-total" class="text-2xl font-black text-slate-800">--</h3>
            </div>
            <div class="stat-card border-b-4 border-emerald-500">
              <p class="text-xs font-bold text-slate-400">ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</p>
              <h3 id="v-done" class="text-2xl font-black text-emerald-600">--</h3>
            </div>
            <div class="stat-card border-b-4 border-blue-500">
              <p class="text-xs font-bold text-slate-400">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</p>
              <h3 id="v-pending" class="text-2xl font-black text-blue-600">--</h3>
            </div>
            <div class="stat-card border-b-4 border-amber-500">
              <p class="text-xs font-bold text-slate-400">Ø¬Ø§Ø±ÙŠ / ÙØ­Øµ</p>
              <h3 id="v-prog" class="text-2xl font-black text-amber-500">--</h3>
            </div>
            <div class="stat-card border-b-4 border-red-600 bg-red-50">
              <p class="text-xs font-bold text-red-600">ğŸš¨ Ù…ØªØ£Ø®Ø±Ø§Øª</p>
              <h3 id="v-late" class="text-2xl font-black text-red-600">--</h3>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
            <div class="p-4 border-b border-slate-100 flex items-center gap-2 bg-slate-50"><i data-lucide="users" class="text-teal-600"></i><h3 class="font-bold text-slate-800">ØªÙÙ†ÙŠØ·Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3></div>
            <div class="overflow-x-auto">
              <table class="w-full text-right text-sm">
                <thead class="bg-slate-100 text-slate-600 font-bold text-xs">
                  <tr>
                    <th class="p-3">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th class="p-3 text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th class="p-3 text-center text-emerald-700">Ù…Ù†Ø¬Ø²</th>
                    <th class="p-3 text-center text-blue-700">Ø§Ù†ØªØ¸Ø§Ø±</th>
                    <th class="p-3 text-center text-red-700">Ù…ØªØ£Ø®Ø±</th>
                    <th class="p-3 text-center">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>
                  </tr>
                </thead>
                <tbody id="table-rows" class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex items-center gap-2 bg-slate-50"><i data-lucide="building-2" class="text-blue-600"></i><h3 class="font-bold text-slate-800">Ù…ÙˆÙ‚Ù Ø§Ù„Ø¬Ù‡Ø§Øª</h3></div>
            <div class="overflow-x-auto max-h-80">
              <table class="w-full text-right text-sm">
                <thead class="bg-slate-100 text-slate-600 font-bold text-xs sticky top-0">
                  <tr>
                    <th class="p-3">Ø§Ù„Ø¬Ù‡Ø©</th>
                    <th class="p-3 text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th class="p-3 text-center">Ù…ØªØ£Ø®Ø±</th>
                    <th class="p-3 text-center">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
                  </tr>
                </thead>
                <tbody id="entity-rows" class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tab-services" class="hidden-section fade-in">
          <h2 class="text-xl font-bold text-slate-800 mb-4">Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <a href="https://forms.gle/A68F79PpJXHsfzXS9" target="_blank" class="service-card">
              <div class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center"><i data-lucide="building-2"></i></div>
              <span class="font-bold text-slate-700">Ù…Ø±ÙˆØ± Ù…Ø³ØªØ´ÙÙŠØ§Øª</span>
            </a>
            <a href="https://forms.gle/49ku3m4hAjqnqxKE6" target="_blank" class="service-card">
              <div class="w-10 h-10 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center"><i data-lucide="building"></i></div>
              <span class="font-bold text-slate-700">Ù…Ø±ÙˆØ± ÙˆØ­Ø¯Ø§Øª</span>
            </a>
            <a href="https://forms.gle/UWAYWbRKhx753Ddc9" target="_blank" class="service-card">
              <div class="w-10 h-10 rounded-lg bg-violet-50 text-violet-600 flex items-center justify-center"><i data-lucide="wallet"></i></div>
              <span class="font-bold text-slate-700">Ù…Ø±ÙˆØ± Ù…Ø§Ù„ÙŠ</span>
            </a>
            <a href="https://forms.gle/MdqjBxbYcdiuR2NG9" target="_blank" class="service-card">
              <div class="w-10 h-10 rounded-lg bg-amber-50 text-amber-600 flex items-center justify-center"><i data-lucide="file-warning"></i></div>
              <span class="font-bold text-slate-700">ÙØ­Øµ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</span>
            </a>
            <a href="https://forms.gle/gqyJvmhZHeggeYLV7" target="_blank" class="service-card">
              <div class="w-10 h-10 rounded-lg bg-teal-50 text-teal-600 flex items-center justify-center"><i data-lucide="arrow-right-left"></i></div>
              <span class="font-bold text-slate-700">ØµØ§Ø¯Ø± ÙˆÙˆØ§Ø±Ø¯</span>
            </a>
          </div>
        </div>

        <div id="tab-employees" class="hidden-section fade-in flex flex-col items-center justify-center min-h-[60vh]">
          
          <div id="emp-login-form" class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-violet-50 text-violet-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="lock" class="w-8 h-8"></i></div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸Ù</h3>
            <input type="password" id="emp-pin-input" placeholder="****" maxlength="4" inputmode="numeric" class="w-full text-center text-2xl border border-slate-200 rounded-xl p-3 mb-4 outline-none focus:border-violet-500">
            <button onclick="handleLogin()" class="w-full bg-violet-600 text-white font-bold py-3 rounded-xl hover:bg-violet-700">Ø¯Ø®ÙˆÙ„</button>
          </div>

          <div id="emp-profile-view" class="hidden-section w-full">
             <div class="bg-white p-4 rounded-xl border border-slate-200 mb-4 flex justify-between items-center">
               <div><h2 id="profile-name" class="font-bold">...</h2><p id="profile-role" class="text-xs text-slate-500">...</p></div>
               <button onclick="logout()" class="text-red-500 bg-red-50 px-3 py-1 rounded text-xs font-bold">Ø®Ø±ÙˆØ¬</button>
             </div>
             <div id="cards-new" class="space-y-3"></div>
          </div>
        </div>

      </div>
    </main>

    <nav class="bottom-nav">
      <button onclick="switchTab('dashboard')" id="nav-dashboard" class="active"><i data-lucide="layout-grid"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
      <button onclick="switchTab('services')" id="nav-services"><i data-lucide="briefcase"></i><span>Ø§Ù„Ø®Ø¯Ù…Ø§Øª</span></button>
      <button onclick="switchTab('employees')" id="nav-employees"><i data-lucide="users-2"></i><span>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></button>
    </nav>
  </div>

  <div id="loader" class="fixed inset-0 bg-white/90 z-[2000] flex flex-col items-center justify-center hidden-section">
    <div class="w-10 h-10 border-4 border-teal-600 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p class="font-bold text-slate-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>

  <script>
    lucide.createIcons();

    function switchTab(tabName) {
      document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden-section'));
      document.getElementById('tab-' + tabName).classList.remove('hidden-section');
      
      document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active', 'text-teal-600'));
      const navBtn = document.getElementById('nav-' + tabName);
      if(navBtn) navBtn.classList.add('active', 'text-teal-600');
      
      lucide.createIcons();
    }

    async function applyFilter() {
      document.getElementById('loader').classList.remove('hidden-section');
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ§Ø±ÙŠØ® Ø«Ø§Ø¨Øª Ø§Ù„Ø¢Ù† Ù„Ù„ØªØ¬Ø±Ø¨Ø©ØŒ ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ø§Ø­Ù‚Ø§Ù‹
      const start = '2024-01-01';
      const end = '2025-12-31';

      try {
        if(typeof getDashboardData === 'undefined') throw new Error("Backend not loaded");
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ (Ø§Ù„Ù…Ø¹Ø¯Ù„)
        const data = await getDashboardData(start, end);
        
        if (data.error) throw new Error(data.error);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
        document.getElementById('v-total').innerText = data.totals.total;
        document.getElementById('v-done').innerText = data.totals.completed;
        document.getElementById('v-pending').innerText = data.totals.pending;
        document.getElementById('v-prog').innerText = data.totals.progress; // ÙŠØ´Ù…Ù„ Ø¬Ø§Ø±ÙŠ ÙˆÙ‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        document.getElementById('v-late').innerText = data.totals.overdue;

        // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù…Ø¹ Ø§Ù„ØªÙÙ†ÙŠØ·Ø©)
        const tbody = document.getElementById('table-rows');
        tbody.innerHTML = '';
        data.employees.forEach(e => {
          tbody.innerHTML += `
            <tr class="border-b hover:bg-slate-50">
              <td class="p-3">
                <div class="font-bold text-slate-800">${e.name}</div>
                <div class="text-[10px] text-slate-500 mt-1 bg-slate-100 inline-block px-1 rounded">${e.breakdownStr}</div>
              </td>
              <td class="p-3 text-center font-bold">${e.total}</td>
              <td class="p-3 text-center text-emerald-600 font-bold">${e.completed}</td>
              <td class="p-3 text-center text-blue-600 font-bold">${e.pending}</td>
              <td class="p-3 text-center ${e.overdue > 0 ? 'bg-red-50 text-red-600 font-black' : 'text-slate-300'}">${e.overdue}</td>
              <td class="p-3 text-center font-bold text-slate-700">%${e.rate}</td>
            </tr>
          `;
        });

        // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ù‡Ø§Øª
        const entBody = document.getElementById('entity-rows');
        entBody.innerHTML = '';
        data.entities.forEach(ent => {
           entBody.innerHTML += `
             <tr class="border-b hover:bg-slate-50">
               <td class="p-3 font-bold text-xs text-slate-700">${ent.name}</td>
               <td class="p-3 text-center font-bold">${ent.total}</td>
               <td class="p-3 text-center ${ent.overdue > 0 ? 'text-red-600 font-bold' : 'text-slate-300'}">${ent.overdue}</td>
               <td class="p-3 text-center text-xs text-slate-500">%${ent.overduePercent}</td>
             </tr>
           `;
        });

      } catch (e) {
        console.error(e);
        // showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'error');
      } finally {
        document.getElementById('loader').classList.add('hidden-section');
      }
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    async function handleLogin() {
       const pin = document.getElementById('emp-pin-input').value;
       if(!pin) return;
       // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ (ÙŠØ¬Ø¨ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù€ loginUser ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠ)
       document.getElementById('loader').classList.remove('hidden-section');
       // ... Logic here ...
       // Ù„Ù„Ø³Ø±Ø¹Ø© Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ¹Ù…Ù„
       setTimeout(() => {
          document.getElementById('loader').classList.add('hidden-section');
          document.getElementById('emp-login-form').classList.add('hidden-section');
          document.getElementById('emp-profile-view').classList.remove('hidden-section');
          document.getElementById('profile-name').innerText = "Ù…ÙˆØ¸Ù ØªØ¬Ø±ÙŠØ¨ÙŠ"; 
       }, 500);
    }

    function logout() {
      document.getElementById('emp-profile-view').classList.add('hidden-section');
      document.getElementById('emp-login-form').classList.remove('hidden-section');
      document.getElementById('emp-pin-input').value = '';
    }

    window.onload = applyFilter;
  </script>
</body>
</html>
