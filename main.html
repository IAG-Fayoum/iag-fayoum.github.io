<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0f766e">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø© - Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„ØµØ­Ø©</title>
  
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="assets/js/api.js"></script>

  <style>
    /* â”€â”€ Ø£Ø³Ø§Ø³ÙŠØ§Øª ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ â”€â”€ */
    body { 
      font-family: 'Cairo', sans-serif; 
      background-color: #f8fafc;
      overscroll-behavior-y: none; /* Ù…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø¯ÙŠØ« */
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none; user-select: none;
    }
    
    /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
    input, textarea, table, h1, h2, h3, p, span, td, th { -webkit-user-select: text; user-select: text; }
    
    /* Ù…Ù†Ø¹ ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· ÙÙŠ Ø§Ù„Ø¢ÙŠÙÙˆÙ† */
    input, select, textarea { font-size: 16px !important; }

    /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* ğŸ“± Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ÙˆØªØ´ (Notch) */
    header, .safe-top { padding-top: calc(10px + env(safe-area-inset-top)); }
    .main-content { padding-bottom: calc(85px + env(safe-area-inset-bottom)); }
    .bottom-nav { padding-bottom: env(safe-area-inset-bottom); height: calc(65px + env(safe-area-inset-bottom)); }

    /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶ØºØ· */
    button:active, .card-press:active, .service-card:active { transform: scale(0.97); transition: 0.1s; opacity: 0.9; }

    /* â”€â”€ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© â”€â”€ */
    .theme-gradient { background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); }
    .hidden-section { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Sidebar Active State */
    .sidebar-active { background-color: #0f766e; color: white; border-right: 4px solid #ccfbf1; }

    /* Cards */
    .stat-card { background: white; border-radius: 12px; padding: 12px; border: 1px solid #e2e8f0; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .stat-card h3 { font-size: 1.5rem; font-weight: 800; line-height: 1; margin-top: 4px; }
    .stat-card p { font-size: 0.7rem; font-weight: 700; color: #64748b; }

    .service-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
    
    .task-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-right: 4px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    
    /* Employee Tabs */
    .main-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
    .main-tab-btn { padding: 8px 16px; font-weight: 700; color: #64748b; cursor: pointer; transition: 0.2s; border-radius: 8px; display: flex; align-items: center; gap: 6px; font-size: 0.85rem; white-space: nowrap; background: #f1f5f9; border: 1px solid transparent; }
    .main-tab-btn.active { background-color: #0f766e; color: white; box-shadow: 0 4px 6px -1px rgba(15, 118, 110, 0.2); }

    /* Mobile Bottom Nav */
    @media (max-width: 768px) {
      .desktop-only { display: none !important; }
      
      .bottom-nav { 
        display: flex !important; position: fixed; bottom: 0; left: 0; right: 0; 
        background: white; border-top: 1px solid #e2e8f0; z-index: 1000;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
      }
      .bottom-nav button { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #94a3b8; font-size: 0.7rem; font-weight: 700; border: none; background: transparent; }
      .bottom-nav button.active { color: #0f766e; }
      .bottom-nav button.active i { stroke-width: 2.5px; }
      
      /* Mobile Cards for Tables */
      .mobile-card { background: white; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
    }

    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
      .bottom-nav { display: none !important; }
    }
    
    /* Toast */
    #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 400px; pointer-events: none; }
    .toast { background: #1e293b; color: white; padding: 12px 20px; border-radius: 50px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-weight: bold; font-size: 0.9rem; opacity: 0; transition: 0.3s; transform: translateY(20px); pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: #ef4444; }
  </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden">

  <div id="toast-container"></div>

  <div class="flex-grow flex h-screen overflow-hidden">
    
    <aside class="desktop-only w-64 bg-white border-l border-slate-200 flex flex-col shadow-lg z-20 shrink-0">
      <div class="p-6 text-center border-b border-slate-100">
        <div class="w-14 h-14 bg-teal-50 text-teal-700 rounded-full flex items-center justify-center mx-auto mb-2"><i data-lucide="shield" class="w-7 h-7"></i></div>
        <h2 class="font-bold text-slate-800">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</h2>
      </div>
      <nav class="flex-grow p-4 space-y-2">
        <button onclick="switchTab('dashboard')" class="w-full flex items-center gap-3 p-3 rounded-lg font-bold bg-teal-50 text-teal-700 nav-btn" data-target="dashboard"><i data-lucide="layout-grid"></i> Dashboard</button>
        <button onclick="switchTab('services')" class="w-full flex items-center gap-3 p-3 rounded-lg text-slate-600 hover:bg-slate-50 nav-btn" data-target="services"><i data-lucide="briefcase"></i> Ø§Ù„Ø®Ø¯Ù…Ø§Øª</button>
        <button onclick="switchTab('employees')" class="w-full flex items-center gap-3 p-3 rounded-lg text-slate-600 hover:bg-slate-50 nav-btn" data-target="employees"><i data-lucide="users-2"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        <a href="admin.html" class="w-full flex items-center gap-3 p-3 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-600"><i data-lucide="settings-2"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
      </nav>
      <div class="p-4"><button onclick="window.location.href='index.html'" class="text-red-500 font-bold text-sm flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Ø®Ø±ÙˆØ¬</button></div>
    </aside>

    <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative">
      <div class="flex-1 overflow-y-auto scroll-smooth no-scrollbar main-content p-4 md:p-6">

        <div id="tab-dashboard" class="tab-content fade-in">
          
          <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="w-full md:w-auto">
              <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="activity" class="text-teal-600"></i> Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡</h2>
              <p class="text-xs text-slate-500 font-bold mt-1">Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„ØµØ­Ø© Ø¨Ø§Ù„ÙÙŠÙˆÙ…</p>
            </div>
            
            <div class="flex items-center gap-2 bg-white p-1.5 rounded-xl border shadow-sm w-full md:w-auto overflow-x-auto">
               <select id="dash-year" class="bg-transparent text-sm font-bold text-slate-700 outline-none px-2 py-1">
                 <option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
                 <option value="2025" selected>2025</option>
                 <option value="2024">2024</option>
               </select>
               <div class="w-px h-4 bg-slate-200"></div>
               <select id="dash-month" class="bg-transparent text-sm font-bold text-slate-700 outline-none px-2 py-1">
                 <option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
                 <option value="1">ÙŠÙ†Ø§ÙŠØ±</option><option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="3">Ù…Ø§Ø±Ø³</option>
                 <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option><option value="5">Ù…Ø§ÙŠÙˆ</option><option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
                 <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option><option value="8">Ø£ØºØ³Ø·Ø³</option><option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                 <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option><option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
               </select>
               <button onclick="applyFilter()" class="bg-teal-600 text-white px-4 py-1.5 rounded-lg text-sm font-bold shadow-sm whitespace-nowrap active:scale-95 transition">Ø¨Ø­Ø«</button>
            </div>
          </header>

          <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
            <div class="stat-card border-b-4 border-slate-600">
              <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</p>
              <h3 id="v-total" class="text-slate-800">--</h3>
            </div>
            <div class="stat-card border-b-4 border-emerald-500">
              <p>ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</p>
              <h3 id="v-done" class="text-emerald-600">--</h3>
            </div>
            <div class="stat-card border-b-4 border-teal-300">
              <p>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</p>
              <h3 id="v-pending" class="text-teal-500">--</h3>
            </div>
            <div class="stat-card border-b-4 border-blue-500">
              <p>Ù‚ÙŠØ¯ Ø§Ù„ÙØ­Øµ</p>
              <h3 id="v-review" class="text-blue-600">--</h3>
            </div>
            <div class="stat-card border-b-4 border-red-600 bg-red-50">
              <p class="text-red-600">ğŸš¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª</p>
              <h3 id="v-late" class="text-red-600">--</h3>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
            <div class="p-4 border-b border-slate-100 flex items-center gap-2 bg-slate-50"><i data-lucide="users" class="text-teal-600"></i><h3 class="font-bold text-slate-800">ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3></div>
            
            <div class="desktop-only overflow-x-auto">
              <table class="w-full text-right text-sm">
                <thead class="bg-slate-50 text-slate-600 font-bold text-xs uppercase">
                  <tr>
                    <th class="p-3">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th class="p-3 text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th class="p-3 text-center text-emerald-700">Ù…Ù†Ø¬Ø²</th>
                    <th class="p-3 text-center text-teal-600">Ø§Ù†ØªØ¸Ø§Ø±</th>
                    <th class="p-3 text-center text-blue-600">ÙØ­Øµ</th>
                    <th class="p-3 text-center text-red-600">Ù…ØªØ£Ø®Ø±</th>
                    <th class="p-3 text-center">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                  </tr>
                </thead>
                <tbody id="table-rows-desktop"></tbody>
              </table>
            </div>

            <div id="table-rows-mobile" class="mobile-only p-3"></div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex items-center gap-2 bg-slate-50"><i data-lucide="building-2" class="text-blue-600"></i><h3 class="font-bold text-slate-800">Ù…ÙˆÙ‚Ù Ø§Ù„Ø¬Ù‡Ø§Øª</h3></div>
            <div class="desktop-only overflow-x-auto max-h-80">
              <table class="w-full text-right text-sm">
                <thead class="bg-slate-50 text-slate-600 font-bold text-xs sticky top-0">
                  <tr>
                    <th class="p-3">Ø§Ù„Ø¬Ù‡Ø©</th>
                    <th class="p-3 text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th class="p-3 text-center">Ù…ØªØ£Ø®Ø±</th>
                    <th class="p-3 text-center">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ£Ø®ÙŠØ±</th>
                  </tr>
                </thead>
                <tbody id="entity-rows-desktop"></tbody>
              </table>
            </div>
            <div id="entity-rows-mobile" class="mobile-only p-3"></div>
          </div>
        </div>

        <div id="tab-services" class="tab-content hidden-section fade-in">
          <header class="mb-6"><h2 class="text-xl font-bold text-slate-800">Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h2></header>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <a href="https://forms.gle/A68F79PpJXHsfzXS9" target="_blank" class="service-card group">
              <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center"><i data-lucide="building-2"></i></div>
              <span class="font-bold text-slate-700">Ù…Ø±ÙˆØ± Ù…Ø³ØªØ´ÙÙŠØ§Øª</span>
            </a>
            <a href="https://forms.gle/49ku3m4hAjqnqxKE6" target="_blank" class="service-card group">
              <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-lg flex items-center justify-center"><i data-lucide="building"></i></div>
              <span class="font-bold text-slate-700">Ù…Ø±ÙˆØ± ÙˆØ­Ø¯Ø§Øª</span>
            </a>
            <a href="https://forms.gle/UWAYWbRKhx753Ddc9" target="_blank" class="service-card group">
              <div class="w-12 h-12 bg-violet-50 text-violet-600 rounded-lg flex items-center justify-center"><i data-lucide="wallet"></i></div>
              <span class="font-bold text-slate-700">Ù…Ø±ÙˆØ± Ù…Ø§Ù„ÙŠ</span>
            </a>
            <a href="https://forms.gle/MdqjBxbYcdiuR2NG9" target="_blank" class="service-card group">
              <div class="w-12 h-12 bg-amber-50 text-amber-600 rounded-lg flex items-center justify-center"><i data-lucide="file-warning"></i></div>
              <span class="font-bold text-slate-700">ÙØ­Øµ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</span>
            </a>
            <a href="https://forms.gle/gqyJvmhZHeggeYLV7" target="_blank" class="service-card group">
              <div class="w-12 h-12 bg-teal-50 text-teal-600 rounded-lg flex items-center justify-center"><i data-lucide="arrow-right-left"></i></div>
              <span class="font-bold text-slate-700">ØµØ§Ø¯Ø± ÙˆÙˆØ§Ø±Ø¯</span>
            </a>
          </div>
        </div>

        <div id="tab-employees" class="tab-content hidden-section fade-in flex flex-col items-center justify-center min-h-[60vh]">
          
          <div id="emp-login-form" class="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-violet-50 text-violet-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="lock" class="w-8 h-8"></i></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸Ù</h3>
            <p class="text-sm text-slate-500 mb-6">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø´Ø®ØµÙŠ</p>
            <input type="password" id="emp-pin-input" placeholder="****" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="w-full text-center text-3xl tracking-[0.5em] border border-slate-200 rounded-xl p-3 mb-6 outline-none focus:border-violet-500 transition-colors">
            <button onclick="handleLogin()" class="w-full bg-violet-600 text-white font-bold py-3 rounded-xl hover:bg-violet-700 transition card-press">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          </div>

          <div id="emp-profile-view" class="hidden-section w-full max-w-4xl self-start">
             
             <div class="bg-white p-5 rounded-xl border border-slate-200 mb-4 flex justify-between items-center shadow-sm">
               <div class="flex items-center gap-3">
                 <div class="w-12 h-12 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold text-lg"><i data-lucide="user"></i></div>
                 <div><h2 id="profile-name" class="font-bold text-lg text-slate-800">...</h2><p id="profile-role" class="text-xs text-slate-500">...</p></div>
               </div>
               <button onclick="logout()" class="text-red-500 bg-red-50 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-100 transition">Ø®Ø±ÙˆØ¬</button>
             </div>

             <div class="grid grid-cols-4 gap-2 mb-4">
                <div class="bg-white p-2 rounded-lg border text-center"><span class="text-xs text-slate-500 block">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><span id="p-total" class="font-bold text-lg">-</span></div>
                <div class="bg-emerald-50 p-2 rounded-lg border border-emerald-100 text-center"><span class="text-xs text-emerald-600 block">Ù…Ù†Ø¬Ø²</span><span id="p-done" class="font-bold text-lg text-emerald-700">-</span></div>
                <div class="bg-teal-50 p-2 rounded-lg border border-teal-100 text-center"><span class="text-xs text-teal-600 block">Ø§Ù†ØªØ¸Ø§Ø±</span><span id="p-pending" class="font-bold text-lg text-teal-700">-</span></div>
                <div class="bg-red-50 p-2 rounded-lg border border-red-100 text-center"><span class="text-xs text-red-600 block">Ù…ØªØ£Ø®Ø±</span><span id="p-late" class="font-bold text-lg text-red-700">-</span></div>
             </div>

             <div class="main-tabs no-scrollbar">
               <div class="main-tab-btn active" id="tab-btn-new" onclick="switchEmpTab('new')">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯/Ø¬Ø§Ø±ÙŠ</div>
               <div class="main-tab-btn" id="tab-btn-review" onclick="switchEmpTab('review')">ğŸ§ Ù‚ÙŠØ¯ Ø§Ù„ÙØ­Øµ</div>
               <div class="main-tab-btn" id="tab-btn-pending" onclick="switchEmpTab('pending')">â³ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</div>
               <div class="main-tab-btn" id="tab-btn-late" onclick="switchEmpTab('late')">ğŸš¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª</div>
               <div class="main-tab-btn" id="tab-btn-history" onclick="switchEmpTab('history')">ğŸ—‚ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</div>
             </div>

             <div id="emp-content-area" class="space-y-3"></div>
          </div>
        </div>

      </div>
    </main>

    <nav class="bottom-nav">
      <button onclick="switchTab('dashboard')" id="nav-btn-dashboard" class="active"><i data-lucide="layout-grid"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
      <button onclick="switchTab('services')" id="nav-btn-services"><i data-lucide="briefcase"></i><span>Ø§Ù„Ø®Ø¯Ù…Ø§Øª</span></button>
      <button onclick="switchTab('employees')" id="nav-btn-employees"><i data-lucide="users-2"></i><span>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></button>
    </nav>

  </div>

  <div id="loader" class="fixed inset-0 bg-white/90 z-[3000] flex flex-col items-center justify-center hidden-section">
    <div class="w-12 h-12 border-4 border-teal-600 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p class="font-bold text-slate-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
  </div>

  <script>
    lucide.createIcons();
    let allTasks = []; 

    // â”€â”€ Navigation â”€â”€
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-section'));
      const target = document.getElementById('tab-' + tabName);
      if(target) target.classList.remove('hidden-section');

      document.querySelectorAll('.bottom-nav button, .nav-btn').forEach(btn => {
        btn.classList.remove('active', 'text-teal-600', 'bg-teal-50', 'text-teal-700');
        if(btn.id === 'nav-btn-' + tabName) btn.classList.add('active'); 
        if(btn.dataset && btn.dataset.target === tabName) btn.classList.add('bg-teal-50', 'text-teal-700');
      });
      vibrateDevice();
    }

    // â”€â”€ Dashboard Logic â”€â”€
    async function applyFilter() {
      document.getElementById('loader').classList.remove('hidden-section');
      
      const year = document.getElementById('dash-year').value;
      const month = document.getElementById('dash-month').value;
      
      let start = '', end = '';
      if(year) {
         if(month) {
            // Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯
            start = `${year}-${month.padStart(2,'0')}-01`;
            // Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø± ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø´Ù‡Ø±
            let lastDay = new Date(year, month, 0).getDate();
            end = `${year}-${month.padStart(2,'0')}-${lastDay}`;
         } else {
            // Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©
            start = `${year}-01-01`; end = `${year}-12-31`;
         }
      }

      try {
        if(typeof google !== 'undefined' && google.script) {
           google.script.run.withSuccessHandler(renderData).withFailureHandler(err => {
             showToast("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„", "error");
             document.getElementById('loader').classList.add('hidden-section');
           }).getDashboardData(start, end);
        } else {
           console.log("Dev Mode: Skipping Backend Call");
           document.getElementById('loader').classList.add('hidden-section');
        }
      } catch (e) { console.error(e); }
    }

    function renderData(data) {
        document.getElementById('loader').classList.add('hidden-section');
        if (data.error) { showToast(data.error, 'error'); return; }

        // 1. Stats
        document.getElementById('v-total').innerText = data.totals.total || 0;
        document.getElementById('v-done').innerText = data.totals.completed || 0;
        document.getElementById('v-pending').innerText = data.totals.pending_approval || 0; // Updated Key
        document.getElementById('v-review').innerText = data.totals.review || 0; // Updated Key
        document.getElementById('v-late').innerText = data.totals.overdue || 0;

        renderEmployees(data.employees);
        renderEntities(data.entities);
        showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    }

    function renderEmployees(list) {
      const desktop = document.getElementById('table-rows-desktop');
      const mobile = document.getElementById('table-rows-mobile');
      desktop.innerHTML = ''; mobile.innerHTML = '';

      if(!list || list.length === 0) { mobile.innerHTML = '<p class="text-center text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>'; return; }

      list.forEach(e => {
        // Keys from Backend v5
        const total = e.total || 0;
        const done = e.completed || 0;
        const pending = e.pending_approval || 0; // Green
        const review = e.review || 0; // Blue
        const overdue = e.overdue || 0; // Red
        const rate = e.rate || 0;

        // Desktop
        desktop.innerHTML += `
          <tr class="border-b hover:bg-slate-50 transition">
            <td class="p-3">
              <div class="font-bold text-slate-800">${e.name}</div>
              <div class="text-[10px] text-slate-500 mt-1 bg-slate-100 inline-block px-1 rounded">${e.breakdownStr || ''}</div>
            </td>
            <td class="p-3 text-center font-bold">${total}</td>
            <td class="p-3 text-center text-emerald-700 font-bold">${done}</td>
            <td class="p-3 text-center text-teal-600 font-bold">${pending}</td>
            <td class="p-3 text-center text-blue-600 font-bold">${review}</td>
            <td class="p-3 text-center ${overdue > 0 ? 'text-red-600 font-black' : 'text-slate-300'}">${overdue}</td>
            <td class="p-3 text-center font-bold text-slate-700">%${rate}</td>
          </tr>
        `;

        // Mobile Card
        mobile.innerHTML += `
          <div class="mobile-card">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-bold text-slate-800 text-sm">${e.name}</h4>
                <p class="text-[10px] text-slate-500 mt-1">${e.breakdownStr || ''}</p>
              </div>
              <span class="bg-slate-100 text-xs px-2 py-1 rounded font-bold">Ù…: ${total}</span>
            </div>
            <div class="grid grid-cols-5 gap-1 mt-2 text-center text-[10px] font-bold">
               <div class="bg-emerald-50 text-emerald-700 py-1 rounded">âœ… ${done}</div>
               <div class="bg-teal-50 text-teal-700 py-1 rounded">â³ ${pending}</div>
               <div class="bg-blue-50 text-blue-700 py-1 rounded">ğŸ§ ${review}</div>
               <div class="${overdue > 0 ? 'bg-red-100 text-red-700' : 'bg-slate-50 text-slate-300'} py-1 rounded">ğŸš¨ ${overdue}</div>
               <div class="bg-slate-100 text-slate-700 py-1 rounded">%${rate}</div>
            </div>
          </div>
        `;
      });
    }

    function renderEntities(list) {
      const desktop = document.getElementById('entity-rows-desktop');
      const mobile = document.getElementById('entity-rows-mobile');
      desktop.innerHTML = ''; mobile.innerHTML = '';

      if(!list) return;

      list.forEach(ent => {
        desktop.innerHTML += `
          <tr class="border-b hover:bg-slate-50">
            <td class="p-3 font-bold text-xs text-slate-700">${ent.name}</td>
            <td class="p-3 text-center font-bold">${ent.total}</td>
            <td class="p-3 text-center ${ent.overdue > 0 ? 'text-red-600 font-bold' : 'text-slate-300'}">${ent.overdue}</td>
            <td class="p-3 text-center text-xs text-slate-500">%${ent.overduePercent}</td>
          </tr>
        `;
        mobile.innerHTML += `
          <div class="mobile-card flex-row justify-between items-center">
             <div class="flex-1">
               <h4 class="font-bold text-slate-800 text-sm mb-1">${ent.name}</h4>
               <div class="flex gap-2 text-xs">
                 <span class="${ent.overdue > 0 ? 'text-red-600 font-bold' : 'text-slate-400'}">Ù…ØªØ£Ø®Ø±: ${ent.overdue}</span>
                 <span class="text-slate-500">Ù†Ø³Ø¨Ø©: %${ent.overduePercent}</span>
               </div>
             </div>
             <div class="bg-blue-50 text-blue-700 px-3 py-2 rounded-lg font-bold text-lg">${ent.total}</div>
          </div>
        `;
      });
    }

    // â”€â”€ Employee Portal Logic â”€â”€
    async function handleLogin() {
      const pin = document.getElementById('emp-pin-input').value;
      if (!pin || pin.length < 4) { showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (4 Ø£Ø±Ù‚Ø§Ù…)", "error"); return; }
      
      document.getElementById('loader').classList.remove('hidden-section');
      
      google.script.run.withSuccessHandler(res => {
         document.getElementById('loader').classList.add('hidden-section');
         if(res.success) {
            document.getElementById('emp-login-form').classList.add('hidden-section');
            document.getElementById('emp-profile-view').classList.remove('hidden-section');
            
            // Set Info & Stats
            document.getElementById('profile-name').innerText = res.name;
            document.getElementById('profile-role').innerText = res.role;
            // Update Personal Stats Bar
            if(res.stats) {
               document.getElementById('p-total').innerText = res.stats.total;
               document.getElementById('p-done').innerText = res.stats.done;
               document.getElementById('p-pending').innerText = res.stats.pending;
               document.getElementById('p-late').innerText = res.stats.late;
            }

            allTasks = res.tasks || [];
            switchEmpTab('new');
            showToast(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ${res.name}`);
         } else {
            showToast("ÙƒÙˆØ¯ Ø®Ø·Ø£", "error");
         }
      }).loginUser(pin);
    }

    function switchEmpTab(type) {
      document.querySelectorAll('.main-tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-btn-' + type).classList.add('active');
      
      const container = document.getElementById('emp-content-area');
      container.innerHTML = '';
      
      let filtered = [];
      // ğŸ›‘ Ù…Ù†Ø·Ù‚ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù€ Backend (categories)
      // categories: 'completed', 'pending_approval', 'review', 'overdue', 'progress'
      if(type === 'new') filtered = allTasks.filter(t => t.category === 'progress' || !t.category);
      else if(type === 'review') filtered = allTasks.filter(t => t.category === 'review');
      else if(type === 'pending') filtered = allTasks.filter(t => t.category === 'pending_approval');
      else if(type === 'late') filtered = allTasks.filter(t => t.category === 'overdue');
      else if(type === 'history') filtered = allTasks.filter(t => t.category === 'completed');

      if(filtered.length === 0) {
         container.innerHTML = '<div class="text-center py-8 text-slate-400 bg-slate-50 rounded-lg border border-dashed">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>';
         return;
      }

      filtered.forEach(t => {
         // Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙƒØ±ÙˆØª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
         let borderColor = 'border-l-slate-400';
         let statusBg = 'bg-slate-100 text-slate-600';
         
         if(t.category === 'overdue') { borderColor='border-l-red-500'; statusBg='bg-red-100 text-red-700'; }
         else if(t.category === 'pending_approval') { borderColor='border-l-teal-400'; statusBg='bg-teal-100 text-teal-700'; } // Mint
         else if(t.category === 'review') { borderColor='border-l-blue-500'; statusBg='bg-blue-100 text-blue-700'; }
         else if(t.category === 'completed') { borderColor='border-l-emerald-500'; statusBg='bg-emerald-100 text-emerald-700'; }
         else { borderColor='border-l-amber-500'; statusBg='bg-amber-100 text-amber-700'; }

         let attachBtn = t.attachment ? `<a href="${t.attachment}" target="_blank" class="text-blue-600 text-xs font-bold flex items-center gap-1 mt-2 bg-blue-50 p-1.5 rounded w-fit"><i data-lucide="paperclip" class="w-3 h-3"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ÙÙ‚</a>` : '';
         
         container.innerHTML += `
           <div class="task-card border-l-4 ${borderColor}">
              <div class="flex justify-between items-start mb-2">
                 <span class="text-[10px] bg-slate-50 border px-2 py-1 rounded font-bold text-slate-500">#${t.id}</span>
                 <span class="text-[10px] px-2 py-1 rounded font-bold ${statusBg}">${t.status}</span>
              </div>
              <h3 class="font-bold text-slate-800 text-sm mb-1">${t.subject}</h3>
              <p class="text-xs text-slate-500 mb-1 font-bold">${t.entity}</p>
              <div class="flex justify-between items-center mt-2 border-t pt-2 border-slate-50">
                 <span class="text-[10px] text-slate-400">${t.date}</span>
                 ${attachBtn}
              </div>
           </div>
         `;
      });
      lucide.createIcons();
    }

    function logout() {
      document.getElementById('emp-profile-view').classList.add('hidden-section');
      document.getElementById('emp-login-form').classList.remove('hidden-section');
      document.getElementById('emp-pin-input').value = '';
    }

    function vibrateDevice() { if (navigator.vibrate) navigator.vibrate(10); }
    function showToast(msg, type='success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = type === 'error' ? `<i data-lucide="alert-circle" class="w-4 h-4"></i> ${msg}` : `<i data-lucide="check" class="w-4 h-4"></i> ${msg}`;
      container.appendChild(toast);
      lucide.createIcons();
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // Init Load
    window.onload = applyFilter;
  </script>
</body>
</html>
