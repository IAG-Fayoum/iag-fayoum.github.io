<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø© - ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø© Ø§Ù„ÙÙŠÙˆÙ…</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gradient-to-br from-teal-50 to-slate-100 min-h-screen">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ” LOGIN VIEW
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-view" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <!-- Logo & Title -->
        <div class="text-center mb-8">
            <div class="bg-teal-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="shield-check" class="text-white w-10 h-10"></i>
            </div>
            <h1 class="text-2xl font-bold text-slate-800 mb-2">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</h1>
            <p class="text-slate-500 text-sm">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø³ÙƒØ§Ù† - Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„ÙÙŠÙˆÙ…</p>
        </div>

        <!-- PIN Input -->
        <div class="space-y-4">
            <div>
                <label class="block text-slate-700 font-bold mb-2 text-sm">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ (PIN)</label>
                <input 
                    type="password" 
                    id="pin-input" 
                    placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…"
                    maxlength="6"
                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-teal-500 focus:outline-none text-center text-2xl tracking-widest"
                    onkeypress="if(event.key==='Enter') handleLogin()"
                >
            </div>
            
            <button 
                onclick="handleLogin()"
                class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2"
            >
                <i data-lucide="log-in" class="w-5 h-5"></i>
                Ø¯Ø®ÙˆÙ„
            </button>

            <p id="error-msg" class="hidden text-red-600 text-sm text-center font-bold"></p>
        </div>

        <!-- Footer -->
        <div class="mt-8 pt-6 border-t border-slate-200 text-center text-xs text-slate-400">
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© ÙˆØ§Ù„Ø­ÙˆÙƒÙ…Ø© Â© 2025
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ“Š DASHBOARD VIEW
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard-view" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-teal-600 w-12 h-12 rounded-full flex items-center justify-center">
                    <i data-lucide="shield-check" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800">Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</h1>
                    <p class="text-xs text-slate-500">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-left">
                    <p class="text-sm font-bold text-slate-800" id="user-name"></p>
                    <p class="text-xs text-slate-500" id="user-role"></p>
                </div>
                <button 
                    onclick="logout()"
                    class="bg-red-100 hover:bg-red-200 text-red-600 px-4 py-2 rounded-lg font-bold text-sm transition-all"
                >
                    Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="filter" class="w-5 h-5 text-teal-600"></i>
                Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¨Ø­Ø«
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ø³Ù†Ø©</label>
                    <select id="year-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <!-- Will be filled by JS -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„ÙØªØ±Ø©</label>
                    <select id="filter-type" onchange="toggleFilterInputs()" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <option value="current">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
                        <option value="month">Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯</option>
                        <option value="custom">ÙØªØ±Ø© Ù…Ø®ØµØµØ©</option>
                    </select>
                </div>
                
                <div id="month-input" class="hidden">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Ø§Ù„Ø´Ù‡Ø±</label>
                    <select id="month-select" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <!-- Will be filled by JS -->
                    </select>
                </div>
                
                <div id="date-range" class="hidden col-span-2 grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ù…Ù†</label>
                        <input type="date" id="d-start" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ø¥Ù„Ù‰</label>
                        <input type="date" id="d-end" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                </div>
                
                <div class="flex items-end">
                    <button 
                        onclick="applyFilter()"
                        class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg transition-all flex items-center justify-center gap-2"
                    >
                        <i data-lucide="search" class="w-4 h-4"></i>
                        ØªØ·Ø¨ÙŠÙ‚
                    </button>
                </div>
            </div>
            
            <p id="filter-status" class="text-xs text-slate-500 mt-4"></p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-blue-100 text-sm font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</p>
                        <h2 id="v-total" class="text-4xl font-black mt-2">0</h2>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i data-lucide="file-text" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-emerald-100 text-sm font-bold">Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</p>
                        <h2 id="v-done" class="text-4xl font-black mt-2">0</h2>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-amber-100 text-sm font-bold">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</p>
                        <h2 id="v-prog" class="text-4xl font-black mt-2">0</h2>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i data-lucide="clock" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-red-100 text-sm font-bold">Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</p>
                        <h2 id="v-late" class="text-4xl font-black mt-2">0</h2>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i data-lucide="alert-circle" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tables Container -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Employees Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-teal-600 text-white px-6 py-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-4 text-right text-xs font-bold text-slate-600">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                <th class="p-4 text-center text-xs font-bold text-slate-600">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th class="p-4 text-center text-xs font-bold text-slate-600">Ø§Ù„Ù…Ù†Ø¬Ø²</th>
                                <th class="p-4 text-xs font-bold text-slate-600">Ø§Ù„ØªÙ‚Ø¯Ù…</th>
                            </tr>
                        </thead>
                        <tbody id="table-rows">
                            <tr>
                                <td colspan="4" class="p-8 text-center text-slate-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Entities Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-slate-700 text-white px-6 py-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i data-lucide="building" class="w-5 h-5"></i>
                        Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± ØªØ£Ø®ÙŠØ±Ø§Ù‹
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-4 text-right text-xs font-bold text-slate-600">Ø§Ù„Ø¬Ù‡Ø©</th>
                                <th class="p-4 text-center text-xs font-bold text-slate-600">Ø§Ù„ÙƒÙ„</th>
                                <th class="p-4 text-center text-xs font-bold text-slate-600">Ù…Ø¹Ù„Ù‚</th>
                                <th class="p-4 text-center text-xs font-bold text-slate-600">Ù…ØªØ£Ø®Ø±</th>
                                <th class="p-4 text-center text-xs font-bold text-slate-600">Ù†Ø³Ø¨Ø© %</th>
                            </tr>
                        </thead>
                        <tbody id="entity-rows">
                            <tr>
                                <td colspan="5" class="p-8 text-center text-slate-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loader -->
<div id="loader" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-teal-600 border-t-transparent"></div>
        <p class="text-slate-700 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
</div>

<!-- Scripts -->
<script src="assets/js/core.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” LOGIN LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleLogin() {
    const pin = document.getElementById('pin-input').value.trim();
    const errorMsg = document.getElementById('error-msg');
    
    if (pin.length < 4) {
        errorMsg.textContent = 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„';
        errorMsg.classList.remove('hidden');
        return;
    }
    
    const result = await login(pin);
    
    if (result.success) {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('dashboard-view').classList.remove('hidden');
        
        document.getElementById('user-name').textContent = result.name;
        document.getElementById('user-role').textContent = result.role;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø§ØªØ§
        initDashboard();
    } else {
        errorMsg.textContent = 'âŒ ' + (result.error || 'Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­');
        errorMsg.classList.remove('hidden');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š DASHBOARD LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDashboard() {
    // Fill year options
    document.getElementById('year-select').innerHTML = getYearOptions();
    document.getElementById('month-select').innerHTML = getMonthOptions();
    
    // Apply default filter
    applyFilter();
}

async function applyFilter() {
    const year = document.getElementById('year-select').value;
    const type = document.getElementById('filter-type').value;
    let start, end;
    
    if (type === 'current') {
        start = `${year}-01-01`;
        end = `${year}-12-31`;
    } else if (type === 'month') {
        const m = parseInt(document.getElementById('month-select').value);
        const mm = m < 10 ? '0' + m : m;
        start = `${year}-${mm}-01`;
        end = `${year}-${mm}-31`;
    } else {
        start = document.getElementById('d-start').value;
        end = document.getElementById('d-end').value;
    }
    
    document.getElementById('filter-status').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
    
    const data = await fetchDashboardData(start, end);
    
    if (data) {
        renderDashboard(data);
        document.getElementById('filter-status').textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleTimeString('ar-EG')}`;
    }
}

function renderDashboard(data) {
    // Update stats
    document.getElementById('v-total').textContent = data.totals.periodTotal;
    document.getElementById('v-done').textContent = data.totals.periodCompleted;
    document.getElementById('v-prog').textContent = data.totals.periodInProgress;
    document.getElementById('v-late').textContent = data.totals.absoluteOverdue;
    
    // Render employees table
    const tbody = document.getElementById('table-rows');
    tbody.innerHTML = '';
    data.employees.forEach(emp => {
        const percent = emp.periodTotal > 0 ? Math.round((emp.periodCompleted / emp.periodTotal) * 100) : 0;
        const barColor = percent >= 80 ? 'bg-emerald-500' : (percent < 50 ? 'bg-red-500' : 'bg-amber-500');
        
        tbody.innerHTML += `
        <tr class="hover:bg-slate-50 border-b border-slate-100">
            <td class="p-4 font-bold text-slate-800">${emp.name}</td>
            <td class="p-4 text-center text-slate-600">${emp.periodTotal}</td>
            <td class="p-4 text-center font-bold text-emerald-600">${emp.periodCompleted}</td>
            <td class="p-4">
                <div class="w-full bg-slate-200 rounded-full h-2.5">
                    <div class="${barColor} h-2.5 rounded-full" style="width: ${percent}%"></div>
                </div>
            </td>
        </tr>`;
    });
    
    // Render entities table
    const entBody = document.getElementById('entity-rows');
    entBody.innerHTML = '';
    data.entities.slice(0, 10).forEach(ent => {
        entBody.innerHTML += `
        <tr class="hover:bg-slate-50 border-b border-slate-100">
            <td class="p-4 font-bold text-slate-700 text-xs">${ent.name}</td>
            <td class="p-4 text-center text-slate-600">${ent.total}</td>
            <td class="p-4 text-center text-amber-600 font-bold">${ent.pending}</td>
            <td class="p-4 text-center text-red-600 font-black">${ent.overdue}</td>
            <td class="p-4 text-center text-xs font-bold">${ent.overduePercent}%</td>
        </tr>`;
    });
    
    lucide.createIcons();
}

function toggleFilterInputs() {
    const type = document.getElementById('filter-type').value;
    document.getElementById('month-input').classList.add('hidden');
    document.getElementById('date-range').classList.add('hidden');
    
    if (type === 'month') document.getElementById('month-input').classList.remove('hidden');
    if (type === 'custom') document.getElementById('date-range').classList.remove('hidden');
}

// Init icons
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    
    // Check if already logged in
    const user = getCurrentUser();
    if (user) {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('dashboard-view').classList.remove('hidden');
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-role').textContent = user.role;
        initDashboard();
    }
});
</script>

</body>
</html>
